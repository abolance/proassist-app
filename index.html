<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ ProAssist - Mi Dashboard</title>
    <script src="https://accounts.google.com/gsi/client"></script>
	<!-- ======================== -->
	<!-- ESQUEMA DE COLORES CSS -->
	<!-- ======================== -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
		
		body {
			font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
			background: #34495e; /* Color de la segunda imagen */
			min-height: 100vh;
			color: #333;
		}

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LOGIN SCREEN */
        .login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
            color: white;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 400px;
            width: 100%;
            color: #333;
        }

        .app-logo {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .app-title {
			font-size: 2rem;
			font-weight: bold;
			margin-bottom: 10px;
			background: linear-gradient(45deg, #3498db, #1abc9c);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

        .app-subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .google-signin-btn {
			background: #3498db;
			color: white;
			border: none;
			padding: 15px 30px;
			border-radius: 10px;
			font-size: 1.1rem;
			cursor: pointer;
			width: 100%;
			transition: all 0.3s ease;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 10px;
		}

        .google-signin-btn:hover {
			background: #2980b9;
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
		}

        .main-screen {
            display: none;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .greeting {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logout-btn {
			background: #e74c3c;
			color: white;
			border: none;
			padding: 10px 20px;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.3s ease;
		}

        .logout-btn:hover {
			background: #c0392b;
			transform: translateY(-1px);
		}

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-value {
			font-size: 2.5rem;
			font-weight: bold;
			color: #3498db;
			margin-bottom: 10px;
		}

        .stat-description {
            color: #666;
            font-size: 0.9rem;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e0e0e0;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-fill {
			height: 100%;
			background: linear-gradient(45deg, #3498db, #1abc9c);
			border-radius: 5px;
			transition: width 0.3s ease;
		}

        .comparison {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 15px 0;
        }

        .comparison-item {
            text-align: center;
        }

        .comparison-value {
			font-size: 1.5rem;
			font-weight: bold;
			color: #3498db;
		}

        .comparison-label {
            color: #666;
            font-size: 0.8rem;
        }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .form-title {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-frame {
            width: 100%;
            min-height: 600px;
            border: none;
            border-radius: 10px;
            background: white;
        }

        .no-training {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s ease;
        }

        .history-item:hover {
            background: #f8f9fa;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-date {
            font-weight: bold;
            color: #333;
        }

        .history-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-missed {
            background: #f8d7da;
            color: #721c24;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
			border: 4px solid #f3f3f3;
			border-top: 4px solid #3498db;
			border-radius: 50%;
			width: 40px;
			height: 40px;
			animation: spin 1s linear infinite;
			margin: 0 auto 20px;
		}

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

		.motivational-message {
			background: linear-gradient(45deg, #3498db, #1abc9c);
			color: white;
			padding: 20px;
			border-radius: 15px;
			margin-bottom: 20px;
			text-align: center;
			box-shadow: 0 5px 20px rgba(52, 152, 219, 0.2);
		}

        .motivational-message h3 {
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .user-info {
                flex-direction: column;
                align-items: stretch;
            }

            .comparison {
                flex-direction: column;
                gap: 10px;
            }

            .app-title {
                font-size: 1.5rem;
            }

            .greeting {
                font-size: 1.4rem;
            }
        }

        .refresh-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: opacity 0.3s ease;
        }

        .refresh-indicator.hidden {
            opacity: 0;
        }
		
		button[onclick*="load"], button[onclick*="retry"] {
			padding: 10px 20px;
			background: #3498db;
			color: white;
			border: none;
			border-radius: 8px;
			cursor: pointer;
			transition: all 0.3s ease;
		}
		
		button[onclick*="load"]:hover, button[onclick*="retry"]:hover {
			background: #2980b9;
			transform: translateY(-1px);
		}
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <!-- ======================== -->
			<!-- LOGO HTML -->
			<!-- ======================== -->
			<!-- Reemplazar esta l√≠nea: <div class="app-logo">‚öΩ</div> -->
			<div class="app-logo">
				<img src="ProAssist.png" alt="ProAssist Logo" style="width: 80px; height: 80px; margin-bottom: 15px;">
			</div>
            <h1 class="app-title">ProAssist</h1>
            <p class="app-subtitle">Tu dashboard personal de entrenamientos</p>
            <button id="signInButton" class="google-signin-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Iniciar sesi√≥n con Google
            </button>
            <div id="loginLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Iniciando sesi√≥n...</p>
            </div>
        </div>
    </div>

    <!-- PANTALLA PRINCIPAL -->
    <div id="mainScreen" class="main-screen">
        <div class="container">
            <!-- HEADER CON SALUDO -->
            <div class="header">
                <div class="user-info">
                    <div>
                        <div id="greeting" class="greeting"></div>
                        <div id="lastActivity" style="color: #666; font-size: 0.9rem;"></div>
                    </div>
                    <button id="logoutButton" class="logout-btn">Cerrar Sesi√≥n</button>
                </div>
            </div>

            <!-- MENSAJE MOTIVACIONAL -->
            <div id="motivationalMessage" class="motivational-message" style="display: none;">
                <h3 id="motivationalTitle"></h3>
                <p id="motivationalText"></p>
            </div>

            <!-- ESTAD√çSTICAS PRINCIPALES -->
            <div class="stats-grid">
                <!-- ESTAD√çSTICAS PERSONALES -->
                <div class="stat-card">
                    <div class="stat-title">
                        üìä Mis Estad√≠sticas
                    </div>
                    <div class="stat-value" id="totalTrainings">-</div>
                    <div class="stat-description">Entrenamientos completados</div>
                    
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Asistencia</span>
                            <span id="attendanceRate">-</span>
                        </div>
                        <div class="progress-bar">
                            <div id="attendanceProgress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Progreso Mensual</span>
                            <span id="monthlyProgress">-</span>
                        </div>
                        <div class="progress-bar">
                            <div id="monthlyProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- COMPARACI√ìN CON EQUIPO -->
                <div class="stat-card">
                    <div class="stat-title">
                        üë• Comparaci√≥n con Equipo
                    </div>
                    <div class="comparison">
                        <div class="comparison-item">
                            <div class="comparison-value" id="myRanking">-</div>
                            <div class="comparison-label">Mi Posici√≥n</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-value" id="teamAverage">-</div>
                            <div class="comparison-label">Media Equipo</div>
                        </div>
                        <div class="comparison-item">
                            <div class="comparison-value" id="currentStreak">-</div>
                            <div class="comparison-label">Racha Actual</div>
                        </div>
                    </div>

                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>Tu rendimiento vs equipo</span>
                            <span id="performanceComparison">-</span>
                        </div>
                        <div class="progress-bar">
                            <div id="performanceBar" class="progress-fill" style="width: 50%"></div>
                        </div>
                    </div>
                </div>

                <!-- HISTORIAL RECIENTE -->
                <div class="stat-card">
                    <div class="stat-title">
                        üìÖ Historial Reciente
                    </div>
                    <div id="historyList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Cargando historial...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORMULARIO DEL D√çA -->
            <div class="form-section">
                <div class="form-title">
                    üìù <span id="formTitle">Formulario del D√≠a</span>
                </div>
                <div id="formContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando formulario...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INDICADOR DE AUTO-REFRESH -->
    <div id="refreshIndicator" class="refresh-indicator hidden">
        üîÑ
    </div>

    <script>
        // ========================
        // CONFIGURACI√ìN
        // ========================
        const CONFIG = {
            CLIENT_ID: '231457973375-lu8n54s56es213oqg5r3c5huas7golbb.apps.googleusercontent.com',
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzBJGoykjXFl6ryxEV_1-zapE34b738xJQhZ2fOznJ6nL4ZL4ko2lGhXnpYBaTU2vVCDA/exec',
            SCOPES: 'email profile',
            AUTO_REFRESH_INTERVAL: 300000, // 5 minutos
        };

        // Variables globales
        let currentUser = null;
        let refreshInterval = null;

        // ========================
        // INICIALIZACI√ìN
        // ========================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Configurar botones
            document.getElementById('signInButton').addEventListener('click', signIn);
            document.getElementById('logoutButton').addEventListener('click', signOut);

            // Cargar Google Identity Services
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: CONFIG.CLIENT_ID,
                    callback: handleCredentialResponse
                });
            }

            // Verificar si ya hay sesi√≥n activa
            checkExistingSession();
        }

        // ========================
        // AUTENTICACI√ìN
        // ========================
        function signIn() {
            document.getElementById('loginLoading').style.display = 'block';
            document.getElementById('signInButton').style.display = 'none';

            google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: handleTokenResponse,
            }).requestAccessToken();
        }

        function handleTokenResponse(response) {
            if (response.access_token) {
                fetchUserInfo(response.access_token);
            } else {
                showError('Error al obtener token de acceso');
                resetLoginScreen();
            }
        }

        function handleCredentialResponse(response) {
            // Decodificar JWT token
            const userInfo = parseJwt(response.credential);
            loginUser(userInfo);
        }

        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    loginUser(userInfo);
                } else {
                    throw new Error('Error al obtener informaci√≥n del usuario');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al obtener informaci√≥n del usuario');
                resetLoginScreen();
            }
        }

        async function loginUser(userInfo) {
		    let response; // Definimos la variable aqu√≠ para poder acceder a ella en el catch
		    try {
		        response = await fetch(`${CONFIG.SCRIPT_URL}?action=checkAccess&email=${encodeURIComponent(userInfo.email)}&app=player`);
		
		        // NUEVA VERIFICACI√ìN: Nos aseguramos de que la respuesta de red sea exitosa (c√≥digo 200)
		        if (!response.ok) {
		            // Si no es 200 OK, lanzamos un error para que lo capture el catch
		            throw new Error(`Error de red o de servidor: ${response.status}`);
		        }
		
		        const accessData = await response.json(); // Esto solo se ejecuta si la respuesta es OK
		
		        if (accessData.status === 'granted') {
		            currentUser = { ...userInfo, role: accessData.role };
		            sessionStorage.setItem('proassist_user', JSON.stringify(currentUser));
		            showMainScreen();
		            loadUserData();
		            startAutoRefresh();
		        } else {
		            console.error('Acceso denegado por el backend:', accessData.reason);
		            showError(`Acceso denegado: ${accessData.reason}`);
		            resetLoginScreen();
		        }
		
		    } catch (error) {
		        console.error('Error de autorizaci√≥n:', error);
		
		        // ESTA ES LA MAGIA: Si la petici√≥n fall√≥, intentamos leer la respuesta como texto
		        // para ver qu√© nos mand√≥ Google en realidad (probablemente una p√°gina de error HTML).
		        if (response) {
		            console.log("Inspeccionando la respuesta fallida del servidor...");
		            response.text().then(text => {
		                console.error("El servidor respondi√≥ con este texto (que no es JSON v√°lido):", text);
		            });
		        }
		
		        showError('Ocurri√≥ un error al verificar tus permisos.');
		        resetLoginScreen();
		    }
		}

        function checkExistingSession() {
            const savedUser = sessionStorage.getItem('proassist_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                showMainScreen();
                loadUserData();
                startAutoRefresh();
            }
        }

        function signOut() {
            // Limpiar datos
            currentUser = null;
            sessionStorage.removeItem('proassist_user');
            
            // Detener auto-refresh
            stopAutoRefresh();
            
            // Mostrar pantalla de login
            showLoginScreen();
            
            // Desconectar de Google
            if (typeof google !== 'undefined' && google.accounts.oauth2) {
                google.accounts.oauth2.revoke(currentUser?.access_token || '');
            }
        }

        // ========================
        // UI NAVIGATION
        // ========================
        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainScreen').style.display = 'none';
            resetLoginScreen();
        }

        function showMainScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainScreen').style.display = 'block';
            updateGreeting();
        }

        function resetLoginScreen() {
            document.getElementById('loginLoading').style.display = 'none';
            document.getElementById('signInButton').style.display = 'flex';
        }

        // ========================
        // SALUDO PERSONALIZADO
        // ========================
        function updateGreeting() {
            if (!currentUser) return;
            
            const now = new Date();
            const hour = now.getHours();
            let greeting;
            
            if (hour < 12) {
                greeting = 'üåÖ Buenos d√≠as';
            } else if (hour < 18) {
                greeting = '‚òÄÔ∏è Buenas tardes';
            } else {
                greeting = 'üåô Buenas noches';
            }
            
            const firstName = currentUser.name ? currentUser.name.split(' ')[0] : 'Jugadora';
            document.getElementById('greeting').textContent = `${greeting}, ${firstName}!`;
        }

        // ========================
        // CARGAR DATOS DEL USUARIO
        // ========================
        async function loadUserData() {
            if (!currentUser || !currentUser.email) {
                showError('No hay informaci√≥n de usuario disponible');
                return;
            }

            try {
                // Cargar estad√≠sticas del usuario
                await loadUserStats();
                
                // Cargar historial
                await loadUserHistory();
                
                // Cargar formulario del d√≠a
                await loadTodaysForm();
                
                // Cargar estad√≠sticas del equipo para comparaci√≥n
                await loadTeamComparison();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError('Error al cargar los datos del usuario');
            }
        }

        async function loadUserStats() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserStats&email=${encodeURIComponent(currentUser.email)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    updateStatsUI(data.stats);
                    updateMotivationalMessage(data.stats);
                } else {
                    console.error('Error del servidor:', data.error);
                    showDefaultStats();
                }
            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
                showDefaultStats();
            }
        }

        function updateStatsUI(stats) {
            // Estad√≠sticas principales
            document.getElementById('totalTrainings').textContent = stats.totalTrainings || 0;
            document.getElementById('attendanceRate').textContent = `${stats.attendanceRate || 0}%`;
            document.getElementById('currentStreak').textContent = stats.currentStreak || 0;
            document.getElementById('myRanking').textContent = `#${stats.ranking || '-'}`;
            
            // Barras de progreso
            const attendanceProgress = Math.min(100, stats.attendanceRate || 0);
            document.getElementById('attendanceProgress').style.width = `${attendanceProgress}%`;
            
            const monthlyProgress = Math.min(100, ((stats.monthlyTrainings || 0) / (stats.monthlyGoal || 1)) * 100);
            document.getElementById('monthlyProgressBar').style.width = `${monthlyProgress}%`;
            document.getElementById('monthlyProgress').textContent = `${stats.monthlyTrainings || 0}/${stats.monthlyGoal || 12}`;
            
            // Actualizar √∫ltima actividad
            if (stats.lastActivity) {
                const lastDate = new Date(stats.lastActivity);
                const formattedDate = lastDate.toLocaleDateString('es-ES', {
                    day: 'numeric',
                    month: 'long',
                    year: 'numeric'
                });
                document.getElementById('lastActivity').textContent = `√öltimo entreno: ${formattedDate}`;
            }
        }

        function showDefaultStats() {
            document.getElementById('totalTrainings').textContent = '0';
            document.getElementById('attendanceRate').textContent = '0%';
            document.getElementById('currentStreak').textContent = '0';
            document.getElementById('myRanking').textContent = '-';
            document.getElementById('monthlyProgress').textContent = '0/12';
            document.getElementById('lastActivity').textContent = 'Datos no disponibles';
        }

        async function loadTeamComparison() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTeamStats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    updateTeamComparisonUI(data.stats);
                }
            } catch (error) {
                console.error('Error cargando comparaci√≥n de equipo:', error);
                document.getElementById('teamAverage').textContent = '-';
                document.getElementById('performanceComparison').textContent = '-';
            }
        }

        function updateTeamComparisonUI(teamStats) {
            document.getElementById('teamAverage').textContent = `${teamStats.averageAttendance || 0}%`;
            
            // Calcular comparaci√≥n de rendimiento
            const userAttendance = parseInt(document.getElementById('attendanceRate').textContent) || 0;
            const teamAverage = teamStats.averageAttendance || 0;
            
            let performanceText, performanceWidth;
            if (userAttendance > teamAverage) {
                const diff = userAttendance - teamAverage;
                performanceText = `+${diff}% sobre la media`;
                performanceWidth = Math.min(100, 50 + (diff / teamAverage) * 50);
            } else if (userAttendance < teamAverage) {
                const diff = teamAverage - userAttendance;
                performanceText = `-${diff}% bajo la media`;
                performanceWidth = Math.max(0, 50 - (diff / teamAverage) * 50);
            } else {
                performanceText = 'En la media del equipo';
                performanceWidth = 50;
            }
            
            document.getElementById('performanceComparison').textContent = performanceText;
            document.getElementById('performanceBar').style.width = `${performanceWidth}%`;
        }
		
		// ========================
        // HISTORIAL DE ENTRENAMIENTOS
        // ========================
        async function loadUserHistory() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserHistory&email=${encodeURIComponent(currentUser.email)}&limit=5`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    updateHistoryUI(data.history);
                } else {
                    showHistoryError();
                }
            } catch (error) {
                console.error('Error cargando historial:', error);
                showHistoryError();
            }
        }
		
		function updateHistoryUI(history) {
            const historyList = document.getElementById('historyList');
            
            if (!history || history.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>A√∫n no tienes entrenamientos registrados</p>
                        <p style="font-size: 0.9rem;">¬°Completa tu primer formulario!</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = history.map(item => {
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });
                
                const statusClass = item.completed ? 'status-completed' : 'status-missed';
                const statusText = item.completed ? 'Completado' : 'No asisti√≥';
                
                return `
                    <div class="history-item">
                        <div>
                            <div class="history-date">${formattedDate}</div>
                            <div style="font-size: 0.8rem; color: #666;">${item.time || 'Horario no especificado'}</div>
                        </div>
                        <div class="history-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showHistoryError() {
            document.getElementById('historyList').innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666;">
                    <p>Error al cargar el historial</p>
                    <button onclick="loadUserHistory()" style="margin-top: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Reintentar
                    </button>
                </div>
            `;
        }

        // ========================
        // FORMULARIO DEL D√çA
        // ========================
        async function loadTodaysForm() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getForm&email=${encodeURIComponent(currentUser.email)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success && data.formUrl) {
                    showFormUI(data);
                } else {
                    showNoTrainingUI(data.message || 'No hay entreno programado para hoy');
                }
            } catch (error) {
                console.error('Error cargando formulario del d√≠a:', error);
                showFormError();
            }
        }

        function showFormUI(formData) {
            const container = document.getElementById('formContainer');
            const title = document.getElementById('formTitle');
            
            // Actualizar t√≠tulo con informaci√≥n del entreno
            if (formData.trainingInfo) {
                const info = formData.trainingInfo;
                title.innerHTML = `üìù Entreno de Hoy - ${info.time || '20:45-22:30'} üìç ${info.location || 'Pabell√≥n'}`;
            }
            
            // Mostrar iframe del formulario
            container.innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #666; font-size: 0.9rem;">
                        ‚ÑπÔ∏è Tu email ya est√° pre-rellenado. Solo completa el resto de campos.
                    </p>
                </div>
                <iframe 
                    src="${formData.formUrl}" 
                    class="form-frame"
                    onload="handleFormLoad()"
                    onerror="handleFormError()">
                </iframe>
            `;
        }

        function showNoTrainingUI(message) {
            const container = document.getElementById('formContainer');
            const title = document.getElementById('formTitle');
            
            title.textContent = 'üìÖ Informaci√≥n del D√≠a';
            container.innerHTML = `
                <div class="no-training">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üò¥</div>
                    <h3 style="margin-bottom: 10px;">No hay entreno hoy</h3>
                    <p style="color: #666; margin-bottom: 20px;">${message}</p>
                    <p style="font-size: 0.9rem; color: #888;">
                        ¬°Descansa y prep√°rate para el pr√≥ximo entreno!
                    </p>
                </div>
            `;
        }

        function showFormError() {
            const container = document.getElementById('formContainer');
            container.innerHTML = `
                <div class="no-training">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="margin-bottom: 10px;">Error al cargar formulario</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        No se pudo cargar el formulario del d√≠a
                    </p>
                    <button onclick="loadTodaysForm()" 
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Reintentar
                    </button>
                </div>
            `;
        }

        // ========================
        // MENSAJES MOTIVACIONALES
        // ========================
        function updateMotivationalMessage(stats) {
            const messageDiv = document.getElementById('motivationalMessage');
            const titleEl = document.getElementById('motivationalTitle');
            const textEl = document.getElementById('motivationalText');
            
            let title, text;
            
            // Mensajes basados en estad√≠sticas
            if (stats.currentStreak >= 5) {
                title = 'üî• ¬°Incre√≠ble racha!';
                text = `Llevas ${stats.currentStreak} entrenamientos consecutivos. ¬°Eres imparable!`;
            } else if (stats.attendanceRate >= 90) {
                title = '‚≠ê ¬°Excelente constancia!';
                text = `Tu asistencia del ${stats.attendanceRate}% est√° por encima del promedio. ¬°Sigue as√≠!`;
            } else if (stats.attendanceRate >= 70) {
                title = 'üí™ ¬°Buen trabajo!';
                text = 'Mant√©n el ritmo de entrenamientos para seguir mejorando tu forma f√≠sica.';
            } else if (stats.totalTrainings === 0) {
                title = 'üåü ¬°Bienvenida a ProAssist!';
                text = 'Completa tu primer formulario de entreno y comienza tu journey fitness.';
            } else {
                title = 'üéØ ¬°Vamos por m√°s!';
                text = 'Cada entreno cuenta. ¬°Tu pr√≥xima sesi√≥n te acerca m√°s a tus objetivos!';
            }
            
            titleEl.textContent = title;
            textEl.textContent = text;
            messageDiv.style.display = 'block';
            
            // Auto-hide despu√©s de 10 segundos
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 10000);
        }

        // ========================
        // AUTO-REFRESH
        // ========================
        function startAutoRefresh() {
            // Limpiar intervalo existente
            stopAutoRefresh();
            
            // Crear nuevo intervalo
            refreshInterval = setInterval(() => {
                showRefreshIndicator();
                loadUserData();
            }, CONFIG.AUTO_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.remove('hidden');
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 2000);
        }

        // ========================
        // UTILIDADES
        // ========================
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error parsing JWT:', error);
                return null;
            }
        }

        function showError(message) {
            // Crear notificaci√≥n de error
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff4757;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: bold;
                max-width: 400px;
                text-align: center;
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            // Auto-remove despu√©s de 5 segundos
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Funciones para el iframe del formulario
        function handleFormLoad() {
            console.log('Formulario cargado correctamente');
        }

        function handleFormError() {
            console.error('Error al cargar el formulario');
            showFormError();
        }

        // ========================
        // EVENT LISTENERS GLOBALES
        // ========================
        
        // Detectar cuando el usuario regresa a la pesta√±a
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser) {
                loadUserData(); // Refrescar datos
            }
        });

        // Detectar errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            if (e.error.message && e.error.message.includes('fetch')) {
                showError('Error de conexi√≥n. Por favor verifica tu internet.');
            }
        });

        // Limpiar al cerrar la ventana
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });

    </script>
</body>
