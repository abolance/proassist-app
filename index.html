<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚽ ProAssist - Mi Dashboard</title>
    <script src="https://accounts.google.com/gsi/client"></script>
	<!-- ======================== -->
	<!-- ESQUEMA DE COLORES CSS -->
	<!-- ======================== -->
    <style>
	    /* ======================================== */
	    /* === 1. RESET Y CONFIGURACIÓN GLOBAL ==== */
	    /* ======================================== */
	    * {
	        margin: 0;
	        padding: 0;
	        box-sizing: border-box;
	    }
	    
	    body {
	        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	        background-color: #34495e;
	        min-height: 100vh;
	        color: #333;
	    }
	
	    /* ======================================== */
	    /* ========= 2. LAYOUT PRINCIPAL ========== */
	    /* ======================================== */
	    .container {
	        max-width: 1200px;
	        margin: 1.5rem auto;
	        padding: 0 1rem; /* Padding horizontal para que el contenido no toque los bordes en móvil */
	    }
	
	    /* Oculta los dashboards por defecto */
	    #player-dashboard, #admin-panel {
	        display: none;
	    }
	
	    /* ======================================== */
	    /* ========= 3. PANTALLA DE LOGIN ========= */
	    /* ======================================== */
		.login-screen {
		    display: flex;
		    flex-direction: column;
		    justify-content: center;
		    align-items: center;
		    min-height: 100vh;
		    text-align: center;
		    padding: 1rem;
		}
		
		.login-card {
		    background: rgba(255, 255, 255, 0.98);
		    padding: 2.5rem;
		    border-radius: 20px;
		    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
		    max-width: 420px;
		    width: 100%;
		}
		
		.app-logo-container {
		    background: linear-gradient(135deg, #3498db, #1abc9c);
		    width: 100px;
		    height: 100px;
		    border-radius: 50%;
		    margin: 0 auto 1.5rem auto;
		    display: flex;
		    align-items: center;
		    justify-content: center;
		    box-shadow: 0 10px 20px rgba(52, 152, 219, 0.3);
		}
		
		.app-logo-container img {
		    width: 60px;
		    height: 60px;
		}
		
		.app-title {
		    font-size: 2.2rem;
		    font-weight: bold;
		    margin-bottom: 0.5rem;
		    color: #2c3e50;
		}
		
		/* Contenedor para la frase motivacional del login */
		#login-motivation {
		    color: #666;
		    margin-bottom: 2.5rem;
		    font-size: 1.1rem;
		    height: 40px; /* Altura fija para evitar saltos de layout */
		    display: flex;
		    align-items: center;
		    justify-content: center;
		}
		
		/* El botón de Google ahora se genera por la librería, le damos estilo al contenedor */
		#google-signin-button {
		    display: inline-block;
		    width: 100%;
		}	    
	
	    /* ======================================== */
	    /* ======== 4. COMPONENTES COMUNES ======== */
	    /* ======================================== */
	
	    /* --- Header Unificado --- */
	    .header {
	        background: white;
	        padding: 1rem 1.5rem;
	        border-radius: 15px;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        margin-bottom: 1.5rem;
	    }
	    
	    .logo {
	        display: flex;
	        align-items: center;
	        gap: 10px;
	        font-size: 1.4em;
	        font-weight: bold;
	        color: #2c3e50;
	    }
	
	    .admin-badge {
	        background: #e74c3c;
	        color: white;
	        padding: 4px 12px;
	        border-radius: 15px;
	        font-size: 0.7em;
	    }
	
	    /* --- Botones Genéricos --- */
	    .btn {
	        padding: 10px 20px;
	        border: none;
	        border-radius: 8px;
	        cursor: pointer;
	        font-size: 14px;
	        font-weight: bold;
	        transition: all 0.3s ease;
	        display: inline-flex;
	        align-items: center;
	        justify-content: center;
	        gap: 8px;
	    }
	    .btn:hover {
	        transform: translateY(-2px);
	        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	    }
	    .btn-primary { background: #3498db; color: white; }
	    .btn-success { background: #27ae60; color: white; }
	    .btn-danger { background: #e74c3c; color: white; }
	    .btn-secondary { background: #95a5a6; color: white; }
	    .btn-primary:hover { background: #2980b9; }
	    .btn-success:hover { background: #219a52; }
	    .btn-danger:hover { background: #c0392b; }
	    .btn-secondary:hover { background: #7f8c8d; }
	
	    /* --- Tarjetas (Cards) --- */
	    .card {
	        background: white;
	        border-radius: 15px;
	        padding: 1.5rem;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        transition: transform 0.3s ease;
	    }
	    .card:hover {
	        transform: translateY(-5px);
	    }
	    
	    /* --- Formularios --- */
	    .form-group {
	        margin-bottom: 1rem;
	    }
	    .form-group label {
	        display: block;
	        margin-bottom: 5px;
	        font-weight: bold;
	        color: #2c3e50;
	    }
	    .form-group input, .form-group select, .form-group textarea {
	        width: 100%;
	        padding: 12px;
	        border: 1px solid #ddd;
	        border-radius: 8px;
	        font-size: 14px;
	    }
	    
	    /* --- Alertas y Carga --- */
	    .alert {
	        padding: 1rem;
	        border-radius: 8px;
	        margin-bottom: 1rem;
	    }
	    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
	    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
	
	    .loading-placeholder {
	        text-align: center;
	        padding: 40px;
	        color: #666;
	    }
	    .spinner {
	        border: 4px solid #f3f3f3;
	        border-top: 4px solid #3498db;
	        border-radius: 50%;
	        width: 40px;
	        height: 40px;
	        animation: spin 1s linear infinite;
	        margin: 0 auto 1rem;
	    }
	    @keyframes spin {
	        0% { transform: rotate(0deg); }
	        100% { transform: rotate(360deg); }
	    }
	
	    /* ======================================== */
	    /* ===== 5. DASHBOARD JUGADORA (PLAYER) ==== */
	    /* ======================================== */
	    .stats-grid {
	        display: grid;
	        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
	        gap: 1.5rem;
	        margin-bottom: 1.5rem;
	    }
	
	    .motivational-message {
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        color: white;
	        padding: 1.5rem;
	        border-radius: 15px;
	        margin-bottom: 1.5rem;
	        text-align: center;
	        box-shadow: 0 5px 20px rgba(52, 152, 219, 0.2);
	    }
	    .motivational-message h3 {
	        margin-bottom: 0.5rem;
	        font-size: 1.3rem;
	    }
	
	    .stat-title {
	        font-size: 1.2rem;
	        font-weight: bold;
	        margin-bottom: 1rem;
	        display: flex;
	        align-items: center;
	        gap: 10px;
	    }
	    .stat-value {
	        font-size: 2.5rem;
	        font-weight: bold;
	        color: #3498db;
	        margin-bottom: 0.5rem;
	    }
	    .stat-description {
	        color: #666;
	        font-size: 0.9rem;
	    }
	    .progress-bar {
	        width: 100%;
	        height: 10px;
	        background: #e0e0e0;
	        border-radius: 5px;
	        margin-top: 0.5rem;
	        overflow: hidden;
	    }
	    .progress-fill {
	        height: 100%;
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        border-radius: 5px;
	        transition: width 0.3s ease;
	    }
	    .form-frame {
	        width: 100%;
	        min-height: 600px;
	        border: none;
	        border-radius: 10px;
	    }
		.history-item {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    padding: 1rem 0;
		    border-bottom: 1px solid #eee;
		}
		.history-item:last-child {
		    border-bottom: none;
		    padding-bottom: 0;
		}
		.history-date {
		    font-weight: bold;
		}
		.history-status {
		    padding: 5px 12px;
		    border-radius: 20px;
		    font-size: 0.8rem;
		    font-weight: bold;
		    text-align: center;
		}
		.status-completed { /* Verde para "Asistió" */
		    background-color: #d4edda;
		    color: #155724;
		}
		.status-missed { /* Rojo para "No Asistió" */
		    background-color: #f8d7da;
		    color: #721c24;
		}
	
	    /* ======================================== */
	    /* ===== 6. PANEL ADMINISTRADOR (ADMIN) ===== */
	    /* ======================================== */
	    .admin-content {
	        background: white;
	        border-radius: 15px;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        overflow: hidden; /* Para contener los bordes redondeados */
	    }
	    .tabs {
	        display: flex;
	        background: #ecf0f1;
	    }
	    .tab {
	        flex: 1;
	        padding: 1rem;
	        background: none;
	        border: none;
	        cursor: pointer;
	        font-size: 1em;
	        font-weight: bold;
	        transition: all 0.3s ease;
	        display: flex;
	        align-items: center;
	        justify-content: center;
	        gap: 8px;
	        color: #7f8c8d;
	    }
	    .tab.active {
	        background: white;
	        color: #2c3e50;
	    }
	    .tab:hover:not(.active) {
	        background: #e0e6e8;
	    }
	    .tab-panel {
	        display: none;
	        padding: 1.5rem;
	    }
	    .tab-panel.active {
	        display: block;
	    }
	
	    .calendar-container {
	        display: grid;
	        grid-template-columns: 1fr 300px;
	        gap: 1.5rem;
	    }

		.calendar-container.full-width {
		    grid-template-columns: 1fr; /* Fuerza al grid a tener una sola columna */
		}

		.calendar-header {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    padding: 0.5rem 1rem; /* Padding reducido */
			/*flex-direction: column;*/ /* Apilamos título y controles */
		}
		
		.calendar-title-container {
		    flex-grow: 1; /* Permite que el título ocupe el espacio central */
		    text-align: center;
		}
		
		/* Contenedores para los controles a izquierda y derecha */
		.calendar-nav-left, .calendar-controls-right {
		    display: flex;
		    align-items: center;
		    gap: 1rem;
		    flex-shrink: 0; /* Evita que los controles se encojan */
		}
		
		/* Estilos para los botones que ya teníamos */
		.calendar-nav {
		    background: #3498db;
		    border: none;
		    color: white;
		    font-size: 1.5em;
		    cursor: pointer;
		    padding: 5px 10px;
		    border-radius: 5px;
		    transition: background 0.2s ease;
		    line-height: 1;
		}
		.calendar-nav:hover { background: #2980b9; }

		.calendar-title-nav {
		    /* Quitamos estilos antiguos y solo lo usamos para agrupar flechas */
		    display: flex;
		    gap: 0.5rem;
		}		
		
		#calendar-month {
		    min-width: 200px;
		    text-align: center;
		}						
		
	    .calendar-grid {
	        display: grid;
	        grid-template-columns: repeat(7, 1fr);
	        gap: 1px;
	        background: #ddd;
	    }
	    .calendar-day-header {
	        background: #34495e;
	        color: white;
	        padding: 10px;
	        text-align: center;
	        font-weight: bold;
	        font-size: 0.9em;
	    }
	    .calendar-day {
	        background: white;
	        min-height: 80px;
	        padding: 8px;
	        cursor: pointer;
	        position: relative;
	        transition: all 0.3s ease;
	    }
	    .calendar-day:hover { background: #f0f5f9; }
	    .calendar-day.other-month { background: #f8f9fa; color: #ccc; }
	    .calendar-day.has-training { background: #e8f5e8; }
	    .calendar-day.selected { background: #3498db; color: white; }
	    .training-indicator {
	        position: absolute;
	        bottom: 4px;
	        right: 4px;
	        width: 8px;
	        height: 8px;
	        background: #27ae60;
	        border-radius: 50%;
	    }
	    .sidebar {
	        background: #f8f9fa;
	        border-radius: 8px;
	        padding: 1.5rem;
	    }
			
	    /* ======================================== */
	    /* ======== 7. RESPONSIVE DESIGN ========== */
	    /* ======================================== */
	    @media (max-width: 992px) {
	        .calendar-container {
	            grid-template-columns: 1fr; /* Apila el calendario y el formulario */
	        }
	        .sidebar {
	            margin-top: 1.5rem;
	        }
	    }
	    
	    @media (max-width: 768px) {
	        .header {
	            flex-direction: column; /* Apila logo y botones */
	            gap: 1rem;
	            padding: 1rem;
	        }
	        .logo { font-size: 1.3em; }
	
	        .stats-grid {
	            grid-template-columns: 1fr; /* Una columna para las estadísticas */
	        }
	        
	        .tabs {
	            flex-direction: column; /* Apila las pestañas del admin */
	        }			
			
		    .calendar-controls {
		        position: static; /* Quitamos el posicionamiento absoluto */
		    }
	    }

		/* En pantallas muy pequeñas, centramos todo */
		@media (max-width: 500px) {
		    .calendar-header {
		        justify-content: center;
		    }
		}

		/* Estilo para las alertas flotantes */
		.alert-popup {
		    position: fixed;
		    top: 20px;
		    left: 50%;
		    transform: translateX(-50%);
		    padding: 15px 25px;
		    border-radius: 10px;
		    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
		    z-index: 10000;
		    font-weight: bold;
		    max-width: 90%;
		    text-align: center;
		}

		/* Estilos para el selector de vistas del calendario */
		.view-btn {
		    border: none;
		    color: white;
		    padding: 6px 14px;
		    border-radius: 5px;
		    cursor: pointer;
		    transition: all 0.2s ease;
		    margin-left: 5px;
		    font-weight: bold;
		    background: #34495e; /* Azul oscuro (como los días del calendario) */
		}
		
		.view-btn:not(.active):hover {
		    background: #2c3e50; /* Un azul oscuro más intenso al pasar el ratón */
		}
		
		.view-btn.active {
		    background: #3498db; /* Azul claro para el botón activo */
		    color: white;
		}

		/* Estilos para la Vista Diaria */
		.day-view-container {
		    padding: 2rem;
		    text-align: center;
		}
		
		.day-view-card {
		    background-color: #f8f9fa;
		    border-radius: 15px;
		    padding: 2rem;
		    max-width: 600px;
		    margin: 0 auto;
		    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}
		
		.day-view-card h3 {
		    font-size: 1.8em;
		    color: #2c3e50;
		    margin-bottom: 1rem;
		}
		
		.day-view-card p {
		    font-size: 1.1em;
		    color: #7f8c8d;
		    line-height: 1.6;
		}
		
		.day-view-card .details {
		    text-align: left;
		    margin-top: 2rem;
		    border-top: 1px solid #ddd;
		    padding-top: 2rem;
		}
		
		.day-view-card .detail-item {
		    display: flex;
		    align-items: center;
		    gap: 15px;
		    margin-bottom: 1rem;
		    font-size: 1.1em;
		}	

		.modal-overlay {
		    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
		    background: rgba(0,0,0,0.6); z-index: 1000;
		    display: flex; align-items: center; justify-content: center;
		}
		.modal-content {
		    background: white; border-radius: 15px; width: 90%; max-width: 600px;
		    box-shadow: 0 5px 25px rgba(0,0,0,0.2); overflow: hidden;
		}
		.modal-header {
		    display: flex; justify-content: space-between; align-items: center;
		    padding: 1rem 1.5rem; border-bottom: 1px solid #eee;
		}
		.close-btn {
		    background: none; border: none; font-size: 2em; cursor: pointer; color: #888;
		}
		.modal-body {
		    padding: 1.5rem; max-height: 60vh; overflow-y: auto;
		}
		.file-item {
		    display: block; width: 100%; text-align: left; padding: 1rem;
		    border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;
		    cursor: pointer; transition: all 0.2s ease;
		}
		.file-item:hover { background: #f0f5f9; border-color: #3498db; }

		#player-stats-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
		#player-stats-table th, #player-stats-table td { padding: 12px 15px; border-bottom: 1px solid #eee; text-align: left; vertical-align: middle; }
		#player-stats-table th { background-color: #f8f9fa; font-size: 0.9em; text-transform: uppercase; }
		#player-stats-table tbody tr:hover { background-color: #f0f5f9; }
		.attendance-bar-container { display: flex; align-items: center; gap: 8px; min-width: 120px; }
		.bar { height: 8px; background-color: #e9ecef; border-radius: 4px; flex-grow: 1; overflow: hidden; }
		.bar-fill { height: 100%; background-color: #3498db; border-radius: 4px; }		
		#player-search-input { padding: 10px; border-radius: 8px; border: 1px solid #ddd; }

		/* Estilos para los símbolos del historial de asistencia */
		.attendance-history {
		    font-family: monospace;
		    font-size: 1.3em;
		    letter-spacing: 4px;
		    white-space: nowrap; /* Evita que los símbolos se partan en dos líneas */
		}
		
		.attendance-history span.check {
		    color: #27ae60 !important; /* Verde */
		}
		
		.attendance-history span.cross {
		    color: #e74c3c !important; /* Rojo */
		}
		
		.attendance-history span.question {
		    color: #3498db !important; /* Azul */
		}
	</style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
	<div id="loginScreen" class="login-screen">
	    <div class="login-card">
	        
	        <!-- Logo con fondo circular -->
	        <div class="app-logo-container">
	            <img src="ProAssist.png" alt="ProAssist Logo">
	        </div>
	
	        <h1 class="app-title">ProAssist</h1>
	        
	        <!-- Contenedor para la frase motivacional dinámica -->
	        <div id="login-motivation">
	            <p>Tu dashboard personal de entrenamientos</p>
	        </div>
	
	        <!-- Contenedor donde la librería de Google dibujará el botón -->
	        <div id="google-signin-button"></div>
	        
	        <div id="loginLoading" class="loading-placeholder" style="display: none;">
	            <div class="spinner"></div>
	            <p>Iniciando sesión...</p>
	        </div>
	    </div>
	</div>    

    <!-- DASHBOARD JUGADORA -->    
	<div id="player-dashboard" style="display: none;">
        <div class="container">
	        <!-- Header Unificado -->
	        <header class="header">
	            <div class="logo">
	                <span id="greeting"></span>
	            </div>
	            <div>
					<button id="player-logout-btn" class="btn btn-danger logout-btn">🚪 Cerrar Sesión</button>	                
	            </div>
	        </header>
	
	        <!-- Mensaje Motivacional -->
	        <div id="motivationalMessage" class="motivational-message" style="display: none;">
	            <h3 id="motivationalTitle"></h3>
	            <p id="motivationalText"></p>
	        </div>
	
	        <!-- Contened-or Principal de la Vista Diaria de la Jugadora -->
			<!-- Usamos un grid para organizar las tarjetas principales -->
			<div style="display: grid; gap: 1.5rem;">
			
			    <!-- 1. TARJETA DEL PRÓXIMO ENTRENAMIENTO -->
			    <div id="player-day-view-container" class="card">
			        <!-- El contenido se generará con JavaScript aquí dentro -->
			    </div>
			
			    <!-- 2. REJILLA DE ESTADÍSTICAS -->
			    <div class="stats-grid">
			        <div class="card">
			            <div class="stat-title">📊 Mis Estadísticas</div>
			            <div class="stat-value" id="totalTrainings">-</div>
			            <div class="stat-description">Entrenamientos completados</div>
			            <div style="margin-top: 20px;">
			                <span>Asistencia</span>
			                <span id="attendanceRate" style="float: right;">-</span>
			                <div class="progress-bar">
			                    <div id="attendanceProgress" class="progress-fill" style="width: 0%"></div>
			                </div>
			            </div>
			        </div>
			        <div class="card">
			            <div class="stat-title">👥 Comparación con Equipo</div>
			             <div style="margin-top: 1rem;">
			                <span>Tu Asistencia</span>
			                <span id="myAttendanceRate" style="float: right;">-</span>
			                <div class="progress-bar">
			                    <div id="myAttendanceProgress" class="progress-fill" style="width: 0%"></div>
			                </div>
			            </div>
			            <div style="margin-top: 1.5rem;">
			                <span>Media del Equipo</span>
			                <span id="teamAverageRate" style="float: right;">-</span>
			                <div class="progress-bar">
			                    <div id="teamAverageProgress" class="progress-fill" style="background: #e67e22; width: 0%;"></div>
			                </div>
			            </div>
			        </div>
			        <div class="card">
			            <div class="stat-title">📅 Historial Reciente</div>
			            <div id="historyList">Cargando historial...</div>
			        </div>
			    </div>			
			</div>
	    </div>
    </div>

    <!-- PANEL DE ADMINISTRADOR -->
    <div id="admin-panel" style="display: none;">  		
	    <div class="container">
			<!-- HEADER UNIFICADO PARA ADMIN -->
	        <header class="header">
	            <div class="logo">
	                ⚽ ProAssist
	                <span id="role-badge" class="admin-badge"></span>
	            </div>
	            <div style="display: flex; gap: 10px;">
	                <button id="admin-logout-btn" class="btn btn-danger logout-btn">🚪 Cerrar Sesión</button>
	            </div>
	        </header>
			<!-- NUEVO: SELECTOR DE EQUIPO PARA EL COACH -->
		    <div id="team-selector-header" class="header" style="display: none; margin-bottom: 1.5rem; border-radius: 15px;">
		        <div style="display: flex; align-items: center; gap: 15px;">
		            <label for="team-selector" style="font-weight: bold;">Selecciona un equipo para gestionar:</label>
		            <select id="team-selector" class="btn" style="background-color: white; color: black;"></select>
		        </div>
		    </div>
			<div class="admin-content">
		        <div class="tabs">
		            <button class="tab active" onclick="showTab('calendar')">
		                📅 Calendario
		            </button>
		            <button id="config-tab-button" class="tab" onclick="showTab('config')">
		                ⚙️ Configuración
		            </button>
		            <button id="stats-tab-button" class="tab" onclick="showTab('stats')">
		                📊 Estadísticas
		            </button>
					<button id="attendance-tab-button" class="tab" onclick="showTab('attendance')" style="display: none;">
						📋 Asistencia
					</button>
		        </div>
		
		        <div class="content">
		            <!-- CALENDARIO TAB -->
		            <div id="calendar-tab" class="tab-panel active">
		                <div class="calendar-container">
		                    <div id="calendar-main" class="calendar">
								<div class="calendar-header">
								   <!-- Flecha Izquierda -->
								   <div class="calendar-nav-left">
								      <button class="calendar-nav" onclick="previousPeriod()">‹</button>
								   </div>
								
								   <!-- Título Central -->
								   <div class="calendar-title-container">
								      <h2 id="calendar-month">Agosto 2025</h2>
								   </div>                     
								   
								   <!-- Controles Derechos -->
								   <div class="calendar-controls-right">
								      <button class="calendar-nav" onclick="nextPeriod()">›</button>
								      <div id="view-switcher">
								         <button id="month-view-btn" class="view-btn" onclick="setView('month')">Mes</button>
								         <button id="week-view-btn" class="view-btn active" onclick="setView('week')">Semana</button>
								         <button id="day-view-btn" class="view-btn" onclick="setView('day')">Día</button>
								      </div>
								   </div>               
								</div>		                        
		                        <div class="calendar-grid" id="calendar-grid">
		                            <!-- Se genera con JavaScript -->
		                        </div>
		                    </div>
		                    
		                    <div id="calendar-sidebar" class="sidebar">
		                        <h3>📝 Entreno Seleccionado</h3>
		                        <div id="training-details-form">
		                            <div class="form-group">
		                                <label>📅 Fecha:</label>
		                                <input type="text" id="selected-date" readonly>
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>🕐 Hora Inicio:</label>
		                                <input type="time" id="start-time" value="20:45">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>🕐 Hora Fin:</label>
		                                <input type="time" id="end-time" value="22:30">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>📍 Ubicación:</label>
		                                <input type="text" id="location" placeholder="Campo de entrenamiento">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>📝 Notas:</label>
		                                <textarea id="notes" rows="3" placeholder="Notas adicionales del entreno..."></textarea>
		                            </div>

									<div class="form-group">
									    <label>📄 Sesión de Entrenamiento:</label>
									    <div id="pdf-status-container">
									        <!-- El JS llenará esto -->
									    </div>
									    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openFilePicker()">
									        📂 Seleccionar Sesión de Drive
									    </button>
									</div>
									
									<!-- MODAL PARA EL SELECTOR DE ARCHIVOS (añade esto al final del <body>) -->
									<div id="file-picker-modal" class="modal-overlay" style="display:none;">
									    <div class="modal-content">
									        <div class="modal-header">
									            <h3>Seleccionar Archivo de Sesión</h3>
									            <button class="close-btn" onclick="closeFilePicker()">&times;</button>
									        </div>
									        <div id="file-picker-list" class="modal-body">
									            <!-- La lista de archivos se cargará aquí -->
									        </div>
									    </div>
									</div>

									<!-- Contenedor de botones con Flexbox y Flex-wrap -->
									<div id="action-buttons-container" style="margin-top: 1.5rem; border-top: 1px solid #ddd; padding-top: 1.5rem;">
									    <!-- Usaremos Flexbox con envoltura para una máxima adaptabilidad -->
									    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
											<button id="start-training-btn" class="btn" onclick="startTraining()" style="display: none; background-color: #f39c12; color: white;">▶️ Iniciar Entreno</button>											
											<button id="create-form-btn" class="btn btn-primary" onclick="prepareForm()" style="flex-grow: 2; min-width: 180px;">📋 Preparar Formulario</button>
									        <button id="save-training-btn" class="btn btn-success" onclick="saveTraining()" style="flex-grow: 1;">✅ Guardar</button>									        
									        <button id="delete-training-btn" class="btn btn-danger" onclick="deleteTraining()" style="flex-grow: 1;">🗑️ Eliminar</button>
									    </div>
									</div>
		                        </div>
		                    </div>
		                </div>
		            </div>
		
		            <!-- CONFIGURACIÓN TAB -->
		            <div id="config-tab" class="tab-panel">
		                <div class="config-section">
		                    <h3>⚙️ Configuración por Defecto</h3>
		                    <p>Define los días y horarios habituales de entrenamiento. Esto creará automáticamente los entrenamientos para las próximas semanas.</p>
		                    
		                    <div class="days-grid">
		                        <div class="day-config" id="day-tuesday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-tuesday" onchange="toggleDay('tuesday')">
		                                <label for="enable-tuesday"><strong>Martes</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="tuesday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="tuesday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                        
		                        <div class="day-config" id="day-thursday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-thursday" onchange="toggleDay('thursday')">
		                                <label for="enable-thursday"><strong>Jueves</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="thursday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="thursday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                        
		                        <div class="day-config" id="day-friday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-friday" onchange="toggleDay('friday')">
		                                <label for="enable-friday"><strong>Viernes</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="friday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="friday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    
		                    <div style="margin-top: 1.5rem;">
		                        <button class="btn btn-success" onclick="generateTrainings()">
		                            🔄 Generar Próximos 4 Entrenamientos
		                        </button>
		                        <button class="btn btn-secondary" onclick="clearAllTrainings()">
		                            🗑️ Limpiar Calendario
		                        </button>
		                    </div>
		                </div>
		
		                <div class="config-section">
		                    <h3>📋 Configuración de Formularios</h3>
		                    
		                    <div class="form-group">
		                        <label>🔗 ID Formulario Base:</label>
		                        <input type="text" id="form-base-id" placeholder="1BbcDef... (ID de tu formulario base)">
		                        <small style="color: #7f8c8d;">Este formulario se duplicará para cada entreno</small>
		                    </div>
		                    
		                    <div class="form-group">
		                        <label>📊 ID Google Sheets:</label>
		                        <input type="text" id="sheet-id" placeholder="1AbcDef... (ID de tu hoja de cálculo)">
		                        <small style="color: #7f8c8d;">Donde se guardarán las respuestas y configuración</small>
		                    </div>
		                    
		                    <div class="form-group">
		                        <label>📧 Entry ID Campo Email:</label>
		                        <input type="text" id="email-entry" placeholder="entry.123456789">
		                        <small style="color: #7f8c8d;">Para pre-rellenar el email de la jugadora</small>
		                    </div>
		                </div>
		            </div>
		
		            <!-- ESTADÍSTICAS TAB -->
		            <div id="stats-tab" class="tab-panel">
						<!-- 1. Estadísticas Generales del Equipo -->
					    <div class="stats-grid" id="team-stats-summary">
					        <!-- Los datos se cargarán aquí desde el backend -->
					        <div class="card">
					            <div class="stat-value" id="stat-avg-attendance">- %</div>
					            <div class="stat-label">Asistencia Media</div>
					        </div>
					        <div class="card">
					            <div class="stat-value" id="stat-total-trainings">-</div>
					            <div class="stat-label">Entrenamientos Planificados</div>
					        </div>
					        <div class="card">
					            <div class="stat-value" id="stat-upcoming-trainings">-</div>
					            <div class="stat-label">Próximos Entrenamientos</div>
					        </div>
					        <div class="card">
					            <div class="stat-value" id="stat-total-players">-</div>
					            <div class="stat-label">Jugadoras en el Equipo</div>
					        </div>
					    </div>
					
					    <hr style="margin: 2rem 0;">

						<!-- 2. Análisis por Jugadora (Nueva Tabla Interactiva) -->
					    <div id="player-stats-section">
					        <h3 style="margin-bottom: 1rem;">Análisis de Jugadoras</h3>
					        
					        <!-- Controles de Filtro -->
					        <div id="player-table-controls" style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
					            <input type="text" id="player-search-input" placeholder="🔍 Buscar por nombre..." onkeyup="filterPlayerTable()" style="flex-grow: 1; min-width: 200px;">
					            <!-- Aquí añadiremos los filtros de Posición y Menstruación -->
					        </div>
					        
					        <!-- Contenedor de la Tabla -->
					        <div id="player-table-container" style="overflow-x: auto;">
					            <table id="player-stats-table">
					                <thead>
					                    <tr>
					                        <th>Nombre</th>
					                        <th>Posición</th>
					                        <th>Asistencia</th>
					                        <th>Últimos 5 Entrenos</th>
					                        <th>Última Menstruación</th>
					                    </tr>
					                </thead>
					                <tbody id="player-table-body">
					                    <!-- El JavaScript llenará esta tabla -->
					                </tbody>
					            </table>
					        </div>
					    </div>																    								        		                						
		            </div>
					<!-- ASISTENCIA PARA EL ENTRENADOR -->
					<div id="attendance-tab" class="tab-panel">
					    <h3 id="attendance-title">Asistencia para el Entreno</h3>
					    <div id="attendance-table-container">
					        <!-- La tabla de respuestas se cargará aquí -->
					    </div>
					</div>
		        </div>
			</div>
	    </div>
    </div>	

    <!-- INDICADOR DE AUTO-REFRESH -->
    <div id="refreshIndicator" class="refresh-indicator hidden">
        🔄
    </div>

    <script>
        // ========================
        // CONFIGURACIÓN Y GLOBALES
        // ========================
        const CONFIG = {
            CLIENT_ID: '231457973375-lu8n54s56es213oqg5r3c5huas7golbb.apps.googleusercontent.com',
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxTQZTe9yJvZS0pK-ptjCQTpIbs3iFOjSuQ2mbDn02R5VaUs7aVsb4DAEHHJuQtwHMqGA/exec',
            SCOPES: 'email profile',
            AUTO_REFRESH_INTERVAL: 300000,
        };

        const FRASES_MOTIVACIONALES = [
            { title: "⚽ ¡A por Todas!", text: "El talento depende de la inspiración, pero el esfuerzo depende de cada una." },
            { title: "🔥 Espíritu de Equipo", text: "Juegas para el nombre en el frente de la camiseta, y se acordarán del nombre en la espalda." },
            { title: "🎯 Precisión y Pasión", text: "Cada entrenamiento es una oportunidad para ser mejor que ayer. ¡No la desperdicies!" },
            { title: "🌟 Brilla en el Campo", text: "No sueñes con el éxito. Entrena para conseguirlo. ¡Vamos!" },
            { title: "🏆 Mentalidad Ganadora", text: "Las campeonas no se hacen en los partidos, se hacen en los entrenamientos diarios." },
        ];

		const FRASES_LOGIN = [
		    "La victoria se consigue en el campo de entrenamiento.",
		    "El trabajo duro supera al talento cuando el talento no trabaja.",
		    "Cada día es una nueva oportunidad para ser mejor.",
		    "Tu único límite es tu mente.",
		    "Entrena, compite, inspira."
		];

        let currentUser = null;
        let refreshInterval = null;
        let currentDate = new Date();
        let selectedDate = null;
        let trainings = {};
		let currentCalendarView = 'week'; // 'week' es ahora la vista por defecto
		let visibilityChangeListener = null;

        function toYYYYMMDD(date) {
            const anio = date.getFullYear();
            const mes = String(date.getMonth() + 1).padStart(2, '0');
            const dia = String(date.getDate()).padStart(2, '0');
            return `${anio}-${mes}-${dia}`;
        }

        // ========================
        // INICIALIZACIÓN
        // ========================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
		    // --- 1. CONFIGURAR EVENTOS DE LA PÁGINA ---
			
		    // Asignamos la función signOut a todos los botones de cerrar sesión
		    document.querySelectorAll('.logout-btn').forEach(button => {
		        button.addEventListener('click', signOut);
		    });
		
		    // Asignamos nuestra función nombrada al evento de visibilidad
		    document.addEventListener('visibilitychange', handleVisibilityChange);

			// --- 2. INICIALIZAR GOOGLE SIGN-IN ---
			
		    // Si la librería de Google está disponible, la inicializamos
		    if (typeof google !== 'undefined' && google.accounts) {
		        google.accounts.id.initialize({
		            client_id: CONFIG.CLIENT_ID,
		            callback: handleCredentialResponse // Esta es la función que se llamará tras un login exitoso
		        });
		        
		        // Dibujamos el nuevo botón de Google en su contenedor
		        renderGoogleButton();
		    }

			// --- 3. PREPARAR LA UI INICIAL ---
			
		    // Mostramos una frase motivadora aleatoria en el login
		    setRandomLoginPhrase();
		
		    // 5. Comprobamos si ya existe una sesión activa para no tener que loguearse de nuevo
		    checkExistingSession();
		}

		function setRandomLoginPhrase() {
		    const phraseElement = document.querySelector('#login-motivation p');
		    if (phraseElement) {
		        const randomIndex = Math.floor(Math.random() * FRASES_LOGIN.length);
		        phraseElement.textContent = FRASES_LOGIN[randomIndex];
		    }
		}
		
		function renderGoogleButton() {
		    const buttonContainer = document.getElementById('google-signin-button');
		    if (buttonContainer) {
		        google.accounts.id.renderButton(
		            buttonContainer,
		            { theme: "outline", size: "large", width: "350", text: "signin_with" } // Personaliza el botón
		        );
		    }
		}

        // ========================
        // AUTENTICACIÓN
        // ========================
        function signIn() {
            document.getElementById('loginLoading').style.display = 'block';
            document.getElementById('signInButton').style.display = 'none';
            google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: handleTokenResponse,
            }).requestAccessToken();
        }

        function handleTokenResponse(response) {
            if (response.access_token) {
                fetchUserInfo(response.access_token);
            } else {
                showError('Error al obtener token de acceso');
                resetLoginScreen();
            }
        }

        function handleCredentialResponse(response) {
            const userInfo = parseJwt(response.credential);
            loginUser(userInfo);
        }

        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (response.ok) {
                    const userInfo = await response.json();
                    await loginUser(userInfo);
                } else {
                    throw new Error('Error al obtener información del usuario');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al obtener información del usuario');
                resetLoginScreen();
            }
        }

        async function loginUser(userInfo) {
			// --- NUEVA LÓGICA DE CARGA (SPINNER) ---
		    // Ocultamos el botón de Google y mostramos el spinner
		    document.getElementById('loginLoading').style.display = 'block';
		    document.getElementById('google-signin-button').style.display = 'none';
			
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=checkAccess&email=${encodeURIComponent(userInfo.email)}&app=player`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`El servidor respondió con un error ${response.status}: ${errorText}`);
                }
                const accessData = await response.json();
                if (accessData.status === 'granted') {
                    currentUser = { ...userInfo, role: accessData.role, teams: accessData.teams, teamMap: accessData.teamMap, name: accessData.name };
                    sessionStorage.setItem('proassist_user', JSON.stringify(currentUser));
                    updateGreeting();

					visibilityChangeListener = handleVisibilityChange;
    				document.addEventListener('visibilitychange', visibilityChangeListener);
					
                    await showDashboardBasedOnRole(accessData.role);
                    //startAutoRefresh();
                } else {
                    throw new Error(`Acceso denegado por el servidor: ${accessData.reason}`);
                }
            } catch (error) {
                console.error('--- ERROR DE AUTORIZACIÓN DETALLADO ---', error);
                showError('No se pudo verificar tus permisos. Revisa la consola para más detalles.');
                resetLoginScreen();
            }
        }

        async function checkExistingSession() {
            const savedUser = sessionStorage.getItem('proassist_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateGreeting();
                await showDashboardBasedOnRole(currentUser.role);
                //startAutoRefresh();
            }
        }

        function signOut() {
			if (visibilityChangeListener) {
		        document.removeEventListener('visibilitychange', visibilityChangeListener);
		        visibilityChangeListener = null;
		    }
			
		    // Primero, detenemos cualquier refresco automático
		    //stopAutoRefresh();
		    
		    // Luego, reseteamos el usuario
		    currentUser = null;
		    sessionStorage.removeItem('proassist_user');
		    
		    // Finalmente, mostramos la pantalla de login
		    showLoginScreen();
		}		

        // ========================
        // ROUTER Y NAVEGACIÓN
        // ========================
		async function showDashboardBasedOnRole(role) {
		    // 1. Ocultamos todos los dashboards para un estado limpio
		    document.getElementById('loginScreen').style.display = 'none';
		    document.getElementById('player-dashboard').style.display = 'none';
		    document.getElementById('admin-panel').style.display = 'none';

			// 2. Lógica para los roles de STAFF (ADMIN, COACH, ASSISTANT)
		    if (role === 'ADMIN' || role === 'COACH' || role === 'ASSISTANT') {
		        document.getElementById('admin-panel').style.display = 'block';

				// Obtenemos referencias a todos los elementos que vamos a manipular
		        const statsTab = document.getElementById('stats-tab-button');
		        const attendanceTab = document.getElementById('attendance-tab-button');
				const calendarContainer = document.querySelector('#admin-panel .calendar-container');
		        const calendarNav = document.querySelector('#admin-panel .calendar-title-nav');
		        const viewSwitcher = document.getElementById('view-switcher');	
				const configTab = document.getElementById('config-tab-button');
		        const calendarSidebar = document.getElementById('calendar-sidebar');
		        const calendarControls = document.querySelector('#admin-panel .calendar-controls'); // <-- NUEVA REFERENCIA
		        const roleBadge = document.getElementById('role-badge');
		
		        // --- Lógica de Personalización ---
		        if (role === 'ASSISTANT') {
					// Forzamos la fecha global a ser 'hoy' cada vez que un ASSISTANT inicia sesión.
    				currentDate = new Date();
					
		            configTab.style.display = 'none';
		            statsTab.style.display = 'none';
		            attendanceTab.style.display = 'flex';
		            calendarSidebar.style.display = 'none';
		            
		            // Ocultamos solo el contenedor de los controles
		            if (calendarControls) calendarControls.style.display = 'none';		            
		            if (calendarContainer) calendarContainer.classList.add('full-width');
		            if (calendarNav) calendarNav.style.display = 'none';
		            if (viewSwitcher) viewSwitcher.style.display = 'none';

					if (document.querySelector('#admin-panel .calendar-nav-left')) {
					    document.querySelector('#admin-panel .calendar-nav-left').style.display = 'none';
					}
					if (document.querySelector('#admin-panel .calendar-controls-right')) {
					    document.querySelector('#admin-panel .calendar-controls-right').style.display = 'none';
					}
					// Centramos el título que ha quedado solo
					document.querySelector('#admin-panel .calendar-header').style.justifyContent = 'center';

		            roleBadge.textContent = 'ASSISTANT';
		            roleBadge.style.backgroundColor = '#f39c12';
		            setView('day'); 
		            document.querySelector('#admin-panel .tab[onclick="showTab(\'calendar\')"]').click();		            
		        } else { // ADMIN y COACH
		            configTab.style.display = role === 'ADMIN' ? 'flex' : 'none';
		            statsTab.style.display = 'flex';
		            attendanceTab.style.display = 'flex';
		            calendarSidebar.style.display = 'block';
					if (calendarContainer) calendarContainer.classList.remove('full-width');
		            if (calendarNav) calendarNav.style.display = 'flex';
		            if (viewSwitcher) viewSwitcher.style.display = 'block';
					if (calendarControls) calendarControls.style.display = 'flex';

					if (document.querySelector('#admin-panel .calendar-nav-left')) {
					    document.querySelector('#admin-panel .calendar-nav-left').style.display = 'flex';
					}
					if (document.querySelector('#admin-panel .calendar-controls-right')) {
					    document.querySelector('#admin-panel .calendar-controls-right').style.display = 'flex';
					}
					document.querySelector('#admin-panel .calendar-header').style.justifyContent = 'space-between';
					
		            roleBadge.textContent = role;
		            roleBadge.style.backgroundColor = role === 'COACH' ? '#3498db' : '#e74c3c';		            
		        }
		        
		        // Lógica de carga de datos y selector de equipos
		        const teamSelectorHeader = document.getElementById('team-selector-header');
		        const teamSelector = document.getElementById('team-selector');
		        teamSelector.innerHTML = '';
		        
		        if (currentUser.teams && currentUser.teams.length > 1 && role !== 'ASSISTANT') {
		            teamSelectorHeader.style.display = 'flex';
		            currentUser.teams.forEach(teamId => {
		                const option = document.createElement('option');
		                option.value = teamId;
		                option.textContent = currentUser.teamMap[teamId] || teamId;
		                teamSelector.appendChild(option);
		            });
		            teamSelector.onchange = () => initializeAdminPanel(teamSelector.value);
		            await initializeAdminPanel(currentUser.teams[0]);
		        } else if (currentUser.teams && currentUser.teams.length > 0) {
		            teamSelectorHeader.style.display = 'none';
		            await initializeAdminPanel(currentUser.teams[0]);
		        } else {
		            showAlert('No tienes equipos asignados.', 'warning');
		        }
			// 3. Lógica para el rol PLAYER
		    } else if (role === 'PLAYER') {
		        document.getElementById('player-dashboard').style.display = 'block';
		        showMotivationalMessage();
		        
		        const playerTeamId = currentUser.teams[0];
		        if (playerTeamId) {
		            // Renombramos la llamada a la función unificada para el panel de jugador
		            await initializePlayerPanel(playerTeamId);
		        } else {
		            showError("No estás asignada a ningún equipo.");
		        }
		    }
		}		      

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('player-dashboard').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            resetLoginScreen();
        }

		function resetLoginScreen() {
		    // Ocultamos el spinner de carga
		    const loginLoading = document.getElementById('loginLoading');
		    if (loginLoading) {
		        loginLoading.style.display = 'none';
		    }
		    
		    // Mostramos el contenedor del botón de Google
		    const googleButtonContainer = document.getElementById('google-signin-button');
		    if (googleButtonContainer) {
		        googleButtonContainer.style.display = 'block';
		    }
		}        

        // ========================
        // LÓGICA DASHBOARD JUGADORA
        // ========================
		/**
		 * Muestra el saludo de bienvenida usando el DisplayName recibido del backend.
		 */
		function updateGreeting() {
		    if (!currentUser || !currentUser.name) return; // Verificamos que tengamos un usuario y un nombre
		
		    const now = new Date();
		    const hour = now.getHours();
		    let greetingText = (hour < 12) ? '🌅 Buenos días' : (hour < 18) ? '☀️ Buenas tardes' : '🌙 Buenas noches';
		    const displayName = currentUser.name; 
		    
		    document.getElementById('greeting').textContent = `${greetingText}, ${displayName}!`;
		}
		
		/*
        function updateGreeting() {
            if (!currentUser) return;
            const now = new Date();
            const hour = now.getHours();
            let greeting = (hour < 12) ? '🌅 Buenos días' : (hour < 18) ? '☀️ Buenas tardes' : '🌙 Buenas noches';
            const firstName = currentUser.name ? currentUser.name.split(' ')[0] : 'Jugadora';
            document.getElementById('greeting').textContent = `${greeting}, ${firstName}!`;
        }
		*/

		/**
		 * Carga TODOS los datos del panel de la jugadora en PARALELO para una experiencia más rápida.
		 * @param {string} teamId El ID del equipo de la jugadora.
		 */
		/*
		async function initializePlayerPanel(teamId) {
		    if (!currentUser || !currentUser.email) {
		        return showError('No hay información de usuario disponible');
		    }
		    
		    // --- Mostramos los spinners de carga en TODOS los widgets ---
		    document.getElementById('totalTrainings').textContent = '...';
		    document.getElementById('historyList').innerHTML = '<div class="spinner"></div>';
		    document.getElementById('player-day-view-container').innerHTML = '<div class="spinner"></div>';
		
		    try {
		        // --- ¡AQUÍ ESTÁ LA MAGIA! ---
		        // Lanzamos las tres llamadas al backend al mismo tiempo.
		        const [statsData, historyData, formStateData] = await Promise.all([
		            fetch(`${CONFIG.SCRIPT_URL}?action=getUserStats&email=${currentUser.email}&teamId=${teamId}`).then(res => res.json()),
		            fetch(`${CONFIG.SCRIPT_URL}?action=getUserHistory&email=${currentUser.email}&teamId=${teamId}`).then(res => res.json()),
		            fetch(`${CONFIG.SCRIPT_URL}?action=getPlayerState&email=${currentUser.email}&teamId=${teamId}`).then(res => res.json())
		        ]);
		
		        // --- Una vez que TODAS las respuestas han llegado, actualizamos la UI ---
		        
		        // 1. Actualizar Estadísticas
		        if (statsData.success) {
		            updateStatsUI(statsData); // La función ahora recibirá el objeto completo
		        } else {
		            showDefaultStats();
		        }
		
		        // 2. Actualizar Historial
		        if (historyData.success) {
		            updateHistoryUI(historyData.history);
		        } else {
		            showHistoryError();
		        }
		
		        // 3. Actualizar Sección del Formulario
		        if (formStateData.success) {
		            // Creamos una función nueva y dedicada para dibujar esta parte
		            renderPlayerFormState(formStateData);
		        } else {
		            document.getElementById('player-day-view-container').innerHTML = `<div class="alert alert-warning">${formStateData.error}</div>`;
		        }
		
		    } catch (error) {
		        console.error('Error CATASTRÓFICO cargando datos de la jugadora:', error);
		        showError('Error al cargar los datos. Revisa la consola.');
		    }
		}
  		*/

		/**
		 * Carga TODOS los datos del panel de la jugadora en PARALELO.
		 * @param {string} teamId El ID del equipo de la jugadora.
		 */
		async function initializePlayerPanel(teamId) {
		    if (!currentUser || !currentUser.email) {
		        return showError('No hay información de usuario disponible');
		    }
		    
		    // Mostramos los spinners de carga en TODOS los widgets
		    safeSetText('totalTrainings', '...');
		    document.getElementById('historyList').innerHTML = '<div class="spinner"></div>';
		    document.getElementById('player-day-view-container').innerHTML = '<div class="spinner"></div>';
		
		    try {
		        // Lanzamos las tres llamadas al backend al mismo tiempo.
		        const [statsResponse, historyResponse, formStateResponse] = await Promise.all([
		            fetch(`${CONFIG.SCRIPT_URL}?action=getUserStats&email=${currentUser.email}&teamId=${teamId}`),
		            fetch(`${CONFIG.SCRIPT_URL}?action=getUserHistory&email=${currentUser.email}&teamId=${teamId}`),
		            fetch(`${CONFIG.SCRIPT_URL}?action=getPlayerState&email=${currentUser.email}&teamId=${teamId}`)
		        ]);
		
		        // Convertimos todas las respuestas a JSON
		        const statsData = await statsResponse.json();
		        const historyData = await historyResponse.json();
		        const formStateData = await formStateResponse.json();
		
		        // Una vez que TODAS las respuestas han llegado, actualizamos la UI
		        updateStatsUI(statsData);
		        updateHistoryUI(historyData);
		        renderPlayerFormState(formStateData);
		
		    } catch (error) {
		        console.error('Error CATASTRÓFICO cargando datos de la jugadora:', error);
		        showError('Error al cargar los datos. Revisa la consola.');
		        // Mostramos errores en los widgets
		        showDefaultStats();
		        showHistoryError();
		    }
		}

		/**
		 * Dibuja la sección del formulario del día basándose en el estado recibido.
		 */
		/*
		function renderPlayerFormState(data) {
		    const container = document.getElementById('player-day-view-container');
		    const state = data.state;
		    const info = data.trainingInfo;
		    const formUrl = data.formUrl;
		    
		    let contentHtml = '';
		
		    switch (stateData.state) {
		      case 'listo_para_responder':
		        contentHtml += `
		            <div style="text-align: center;">
		                <h3 style="margin-bottom: 10px;">¡Confirma tu asistencia!</h3>
		                <a href="${stateData.formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">📋 Abrir Formulario</a>
		            </div>`;
		        break;
		        
		      case 'ya_respondido':
		        contentHtml += `
		            <div style="text-align: center; background-color: #e8f5e8; border-radius: 15px; padding: 1.5rem;">
		                <h3 style="margin-bottom: 10px; color: #155724;">✅ ¡Gracias por responder!</h3>
		                <p style="color: #666;">Tu respuesta para el entreno de hoy ha sido registrada.</p>
		            </div>`;
		        break;
		
		      default:
		         contentHtml += `<div style="text-align: center; padding: 20px; color: #666;">🗓️<p style="margin-top:1rem;">${stateData.error || 'No hay formulario disponible para el próximo entreno.'}</p></div>`;
		    }		    
	
		    container.innerHTML = contentHtml;
		}
  		*/

		/**
		 * Dibuja la sección principal del dashboard de la jugadora (próximo entreno y formulario).
		 * @param {object} formStateData El objeto de estado del formulario recibido del backend.
		 */
		function renderPlayerFormState(formStateData) {
		    const container = document.getElementById('player-day-view-container');
		    
		    // Verificamos si la petición fue exitosa
		    if (!formStateData || !formStateData.success) {
		        container.innerHTML = `<div class="alert alert-warning">${formStateData.error || 'Error al cargar la información del día.'}</div>`;
		        return;
		    }
		
		    const { state, trainingInfo, formUrl } = formStateData;
		    let contentHtml = '';
		    
		    // --- Parte 1: Mostrar siempre los detalles del próximo entreno (si existe) ---
		    if (trainingInfo) {
		        const date = new Date(trainingInfo.fecha + 'T12:00:00');
		        const displayDate = date.toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'});
		        
		        contentHtml += `
		            <h3 style="margin-bottom: 1rem;">Próximo Entrenamiento: ${displayDate}</h3>
		            <div class="details">
		                <p class="detail-item"><strong>🕒 Horario:</strong> ${trainingInfo.start} - ${trainingInfo.end}</p>
		                <p class="detail-item"><strong>📍 Ubicación:</strong> ${trainingInfo.location || 'No especificada'}</p>
		                <p class="detail-item"><strong>📝 Notas:</strong> ${trainingInfo.notes || 'Sin notas'}</p>
		            </div>
		            <hr style="margin: 2rem 0;">
		        `;
		    }
		
		    // --- Parte 2: Mostrar el estado del formulario según el "semáforo" del backend ---
		    switch (state) {
		        case 'listo_para_responder':
		            contentHtml += `
		                <div style="text-align: center;">
		                    <h3 style="margin-bottom: 10px;">¡Confirma tu asistencia!</h3>
		                    <a href="${formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">📋 Abrir Formulario</a>
		                </div>`;
		            break;
		            
		        case 'ya_respondido':
		            contentHtml += `
		                <div style="text-align: center; background-color: #e8f5e8; border-radius: 15px; padding: 1.5rem;">
		                    <h3 style="margin-bottom: 10px; color: #155724;">✅ ¡Gracias por responder!</h3>
		                    <p style="color: #666;">Tu respuesta para el entreno de hoy ha sido registrada.</p>
		                </div>`;
		            break;
		
		        case 'entreno_futuro':
		            const futureDate = new Date(trainingInfo.fecha + 'T12:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' });
		            contentHtml += `<div style="text-align: center; padding: 20px; color: #666;">🗓️<p style="margin-top:1rem;">El formulario para el entreno del ${futureDate} se activará ese mismo día.</p></div>`;
		            break;
		
		        case 'form_no_preparado':
		            contentHtml += `<div style="text-align: center; padding: 20px; color: #666;">👨‍🏫<p style="margin-top:1rem;">El entrenador aún no ha preparado el formulario para el próximo entreno.</p></div>`;
		            break;
		
		        case 'sin_entrenos':
		            contentHtml = `<div style="text-align: center; padding: 20px; color: #666;">😴<p style="margin-top:1rem;">No hay próximos entrenamientos programados.</p></div>`;
		            break;
		
		        default:
		            contentHtml = `<div class="alert alert-warning">Ha ocurrido un estado desconocido.</div>`;
		    }
		    
		    container.innerHTML = contentHtml;
		}

		/*
        async function loadUserStats(teamId) {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserStats&email=${currentUser.email}&teamId=${teamId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.success) {
                    updateStatsUI(data.stats);
                } else {
                    showDefaultStats();
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                showDefaultStats();
            }
        }
		*/

		/*
		function updateStatsUI(stats) {
		    const attendance = stats.attendanceRate || 0;
		    safeSetText('totalTrainings', stats.totalTrainings || 0);
		    safeSetText('attendanceRate', `${attendance}%`);
		    safeSetWidth('attendanceProgress', `${attendance}%`);
		    safeSetText('monthlyProgress', `${stats.monthlyTrainings || 0}/${stats.monthlyGoal || 0}`);
		    safeSetWidth('monthlyProgressBar', `${(stats.monthlyTrainings / (stats.monthlyGoal || 1)) * 100}%`);
		    
		    // Widget de Comparación (ahora también es seguro)
		    safeSetText('myAttendanceRate', `${attendance}%`);
		    safeSetWidth('myAttendanceProgress', `${attendance}%`);

			// Rellenamos los campos del widget "Comparación con Equipo"
		    document.getElementById('myAttendanceRate').textContent = `${stats.attendanceRate || 0}%`;
		    document.getElementById('myAttendanceProgress').style.width = `${stats.attendanceRate || 0}%`;
		    
		    // Rellenamos la media del equipo con el nuevo dato del backend
		    const teamAverage = stats.teamAverage || 0;
		    document.getElementById('teamAverageRate').textContent = `${teamAverage}%`;
		    document.getElementById('teamAverageProgress').style.width = `${teamAverage}%`;
		}
  		*/

		/**
		 * Dibuja el widget de estadísticas de la jugadora.
		 * @param {object} statsData El objeto de estadísticas recibido del backend.
		 */
		function updateStatsUI(statsData) {
		    if (!statsData || !statsData.success) {
		        showDefaultStats();
		        return;
		    }
		    const stats = statsData.stats; // Los datos están dentro de la clave 'stats'
		    
		    safeSetText('totalTrainings', stats.totalTrainings || 0);
		    safeSetText('attendanceRate', `${stats.attendanceRate || 0}%`);
		    safeSetWidth('attendanceProgress', `${stats.attendanceRate || 0}%`);
		    safeSetText('monthlyProgress', `${stats.monthlyTrainings || 0}/${stats.monthlyGoal || 0}`);
		    safeSetWidth('monthlyProgressBar', `${(stats.monthlyTrainings / (stats.monthlyGoal || 1)) * 100}%`);
		    
		    safeSetText('myAttendanceRate', `${stats.attendanceRate || 0}%`);
		    safeSetWidth('myAttendanceProgress', `${stats.attendanceRate || 0}%`);
		    
		    // Rellenamos la media del equipo si viene en los datos
		    if (stats.teamAverage !== undefined) {
		        safeSetText('teamAverageRate', `${stats.teamAverage}%`);
		        safeSetWidth('teamAverageProgress', `${stats.teamAverage}%`);
		    }
		}
		
		function showDefaultStats() {
		    safeSetText('totalTrainings', '0');
		    safeSetText('attendanceRate', '0%');
		    safeSetWidth('attendanceProgress', '0%');
		    safeSetText('monthlyProgress', '0/0');
		    safeSetWidth('monthlyProgressBar', '0%');
		
		    safeSetText('myAttendanceRate', '0%');
		    safeSetWidth('myAttendanceProgress', '0%');

			document.getElementById('myAttendanceRate').textContent = '0%';
		    document.getElementById('myAttendanceProgress').style.width = '0%';
		    
		    // Reiniciamos los campos de la media del equipo
		    document.getElementById('teamAverageRate').textContent = '0%';
		    document.getElementById('teamAverageProgress').style.width = '0%';
		}

		/*
        async function loadUserHistory(teamId) {
			try {
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserHistory&email=${currentUser.email}&teamId=${teamId}`);
		        if (!response.ok) throw new Error(`HTTP ${response.status}`);
		        
		        const data = await response.json();
		        if (data.success) {
		            updateHistoryUI(data.history); // Llamamos a la función que dibuja el historial
		        } else {
		            showHistoryError();
		        }
		    } catch (error) {
		        console.error('Error cargando historial:', error);
		        showHistoryError();
		    }            
        }
		*/

		/**
		 * Dibuja la lista del historial reciente en el dashboard de la jugadora.
		 * VERSIÓN FINAL Y COMPLETA.
		 * @param {Array} history Un array de objetos con el historial.
		 */
		/*
		function updateHistoryUI(history) {
		    const historyList = document.getElementById('historyList');
		    
		    if (!history || history.length === 0) {
		        historyList.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;"><p>Aún no tienes entrenamientos registrados.</p></div>`;
		        return;
		    }
		
		    historyList.innerHTML = history.map(item => {
		        let formattedDate = "Fecha inválida";
		        if (item.date) {
		            // El backend nos envía un objeto Date, lo formateamos directamente.
		            const date = new Date(item.date);
		            if (!isNaN(date.getTime())) { // Verificamos si la fecha es válida
		                formattedDate = date.toLocaleDateString('es-ES', {
		                    weekday: 'long',
		                    day: 'numeric',
		                    month: 'short'
		                });
		            }
		        }
		        
		        const statusClass = item.completed ? 'status-completed' : 'status-missed';
		        const statusText = item.completed ? 'Asistió' : 'No Asistió';
		        
		        return `
		            <div class="history-item">
		                <div class="history-date">${formattedDate}</div>
		                <div class="history-status ${statusClass}">
		                    ${statusText}
		                </div>
		            </div>
		        `;
		    }).join('');
		}
  		*/

		/**
		 * Dibuja el widget del historial reciente de la jugadora.
		 * @param {object} historyData El objeto completo con el historial recibido del backend.
		 */
		function updateHistoryUI(historyData) {
		    const historyList = document.getElementById('historyList');
		    
		    // Comprobamos si la petición fue exitosa y si el array de historial existe y tiene contenido
		    if (!historyData || !historyData.success || !historyData.history || historyData.history.length === 0) {
		        historyList.innerHTML = `
		            <div style="text-align: center; padding: 20px; color: #666;">
		                <p>Aún no tienes entrenamientos registrados.</p>
		            </div>
		        `;
		        return;
		    }
		
		    const history = historyData.history;
		
		    // Construimos el HTML para cada item del historial
		    historyList.innerHTML = history.map(item => {
		        let formattedDate = "Fecha inválida";
		        if (item.date) {
		            // Creamos la fecha de forma segura para evitar errores de formato y zona horaria
		            const date = new Date(item.date);
		            if (!isNaN(date.getTime())) { // Verificamos si la fecha es válida
		                formattedDate = date.toLocaleDateString('es-ES', {
		                    weekday: 'long',
		                    day: 'numeric',
		                    month: 'short'
		                });
		            }
		        }
		        
		        const statusClass = item.completed ? 'status-completed' : 'status-missed';
		        const statusText = item.completed ? 'Asistió' : 'No Asistió';
		        
		        return `
		            <div class="history-item">
		                <div class="history-date">${formattedDate}</div>
		                <div class="history-status ${statusClass}">
		                    ${statusText}
		                </div>
		            </div>
		        `;
		    }).join('');
		}
		
		/**
		 * Muestra un mensaje de error en el widget del historial.
		 */
		/*
		function showHistoryError() {
		    const historyList = document.getElementById('historyList');
		    historyList.innerHTML = `
		        <div style="text-align: center; padding: 20px; color: #666;">
		            <p>Error al cargar el historial.</p>
		            <button onclick="loadUserHistory(currentUser.teams[0])" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">Reintentar</button>
		        </div>
		    `;
		}
  		*/

		/**
		 * Muestra un mensaje de error en el widget del historial.
		 */
		function showHistoryError() {
		    const historyList = document.getElementById('historyList');
		    historyList.innerHTML = `
		        <div style="text-align: center; padding: 20px; color: #666;">
		            <p>Error al cargar el historial.</p>
		            <!-- El botón ahora llama a la función de carga principal -->
		            <button onclick="initializePlayerPanel(currentUser.teams[0])" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">Reintentar</button>
		        </div>
		    `;
		}

		/**
		 * Carga el estado de la jugadora y renderiza la VISTA DIARIA.
		 * @param {string} teamId El ID del equipo de la jugadora.
		 */
		/*
		async function loadPlayerFormState(teamId) {
		  const container = document.getElementById('player-day-view-container');
		  container.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Cargando información del día...</p>';
		  
		  try {
		    const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getPlayerState&email=${currentUser.email}&teamId=${teamId}`);
		    const data = await response.json();
		
		    if (!data.success || !data.playerState.success) {
		      throw new Error(data.error || data.playerState.error);
		    }
		
		    const stateData = data.playerState;
		    const info = stateData.trainingInfo;
		    
		    let contentHtml = '';

			if (info) {
			    // El contenedor ya es un .card, así que inyectamos el contenido directamente
			    contentHtml += `
			        <h3 style="margin-bottom: 1rem;">Próximo Entrenamiento: ${new Date(info.fecha + 'T12:00:00').toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}</h3>
			        <div class="details">
			            <p class="detail-item"><strong>🕒 Horario:</strong> ${info.start} - ${info.end}</p>
			            <p class="detail-item"><strong>📍 Ubicación:</strong> ${info.location || 'No especificada'}</p>
			            <p class="detail-item"><strong>📝 Notas:</strong> ${info.notes || 'Sin notas'}</p>
			        </div>
			        <hr style="margin: 2rem 0;">
			    `;
			}		    
		
		    // Añadimos la sección del formulario basándonos en el estado
		    switch (stateData.state) {
		      case 'listo_para_responder':
		        contentHtml += `
		            <div style="text-align: center;">
		                <h3 style="margin-bottom: 10px;">¡Confirma tu asistencia!</h3>
		                <a href="${stateData.formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">📋 Abrir Formulario</a>
		            </div>`;
		        break;
		        
		      case 'ya_respondido':
		        contentHtml += `
		            <div style="text-align: center; background-color: #e8f5e8; border-radius: 15px; padding: 1.5rem;">
		                <h3 style="margin-bottom: 10px; color: #155724;">✅ ¡Gracias por responder!</h3>
		                <p style="color: #666;">Tu respuesta para el entreno de hoy ha sido registrada.</p>
		            </div>`;
		        break;
		
		      default:
		         contentHtml += `<div style="text-align: center; padding: 20px; color: #666;">🗓️<p style="margin-top:1rem;">${stateData.error || 'No hay formulario disponible para el próximo entreno.'}</p></div>`;
		    }
		    
		    container.innerHTML = contentHtml;
		
		  } catch (error) {
		    console.error('Error cargando el estado del formulario:', error);
		    container.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
		  }
		}
  		*/

        async function loadTodaysForm(teamId) {
			try {
				const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getForm&email=${currentUser.email}&teamId=${teamId}`);
				const data = await response.json();
		
				// Si la llamada al backend fue exitosa PERO la lógica interna falló (ej. no hay entreno)
				if (!data.success) {
					// Lanzamos un error con el mensaje que nos da el backend
					throw new Error(data.error);
				}
				
				// Si todo fue bien, mostramos la UI del formulario
				showFormUI(data);
		
			} catch (error) {
				console.error('Error cargando formulario del día:', error.message);
				// El 'catch' ahora recibe el mensaje de error limpio y se lo pasa a la UI
				showNoTrainingUI(error.message);
			}
		}

		function showFormUI(formData) {
		    const container = document.getElementById('formContainer');
		    const title = document.getElementById('formTitle');
		    
		    let displayHtml = '';
		    
		    if (formData.formUrl && formData.trainingInfo) {
		        const info = formData.trainingInfo;
		        const parts = info.fecha.split('-');
		        const displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
		
		        title.innerHTML = `📝 Próximo Entreno: ${displayDate}`;
		        
		        // --- ¡LÓGICA CONDICIONAL AQUÍ! ---
		        if (formData.hasResponded) {
				    // Si la jugadora YA HA RESPONDIDO
				    displayHtml = `
				        <div style="text-align: center; padding: 30px; background-color: #e8f5e8; border-radius: 15px;">
				            <h3 style="margin-bottom: 10px; color: #155724;">✅ ¡Gracias por responder!</h3>
				            <p style="color: #666; margin-bottom: 25px;">
				                El formulario para el entreno del ${displayDate} ya se ha registrado. Para cualquier modificación, avisa a los entrenadores.
				            </p>
				            <!-- Opcional: Si quieres mantener el botón de modificar -->
				            <a href="${formData.formUrl}" target="_blank" class="btn btn-secondary">📝 Revisar mi Respuesta</a>
				        </div>
				    `;
		        } else {
		            // Si la jugadora AÚN NO HA RESPONDIDO
		            displayHtml = `
		                <div style="text-align: center; padding: 30px;">
		                    <h3 style="margin-bottom: 10px;">¡Listo para el entreno del ${displayDate}!</h3>
		                    <p style="color: #666; margin-bottom: 25px;">
		                        Por favor, completa el formulario de asistencia.
		                    </p>
		                    <a href="${formData.formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">
		                        📋 Abrir Formulario
		                    </a>
		                    <p style="font-size: 0.8rem; color: #888; margin-top: 15px;">(Se abrirá en una nueva pestaña)</p>
		                </div>
		            `;
		        }
		
		    } else {
		        title.innerHTML = `📝 Formulario del Día`;
		        displayHtml = `<div style="text-align: center; padding: 20px; color: #666;">No hay formulario disponible.</div>`;
		    }
		    
		    container.innerHTML = displayHtml;
		}		
        
        function showNoTrainingUI(message) {
		    const container = document.getElementById('formContainer');
		    // Usamos un icono de calendario en lugar del de dormir
		    container.innerHTML = `
		        <div style="text-align: center; padding: 20px; color: #666;">
		            <div style="font-size: 3rem; margin-bottom: 20px;">🗓️</div>
		            <p>${message}</p>
		        </div>
		    `;
		}

        function showFormError() {
            // Similar a showNoTrainingUI
            showNoTrainingUI('Error al cargar el formulario del día.');
        }

        function showMotivationalMessage() {
            const messageDiv = document.getElementById('motivationalMessage');
            const titleEl = document.getElementById('motivationalTitle');
            const textEl = document.getElementById('motivationalText');
            const randomIndex = Math.floor(Math.random() * FRASES_MOTIVACIONALES.length);
            const randomPhrase = FRASES_MOTIVACIONALES[randomIndex];
            titleEl.textContent = randomPhrase.title;
            textEl.textContent = randomPhrase.text;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transition = '';
                }, 500);
            }, 120000);
        }

        // ========================
        // LÓGICA PANEL ADMIN/COACH
        // ========================
        async function initializeAdminPanel(teamId) {
            if (!teamId) {
                console.error("initializeAdminPanel fue llamado sin un teamId.");
                return;
            }
            console.log(`Inicializando panel para el equipo: ${teamId}...`);
            trainings = {};
            document.getElementById('calendar-month').textContent = 'Cargando datos...';
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTrainings&teamId=${teamId}`);
                const data = await response.json();
                if (data.success) {
                    trainings = data.trainings;
                    console.log('Entrenamientos cargados:', trainings);
                    renderCalendarView();
                    const activeTab = sessionStorage.getItem('proassist_active_tab') || 'calendar';
                    const tabButton = document.querySelector(`.tab[onclick="showTab('${activeTab}')"]`);
                    if (tabButton) tabButton.click();
                } else {
                    showAlert('Error al cargar entrenamientos: ' + data.error, 'warning');
                }
            } catch (error) {
                console.error('Error de conexión al cargar entrenamientos:', error);
                showAlert('Error de conexión. No se pudieron cargar los datos.', 'warning');
            }
            loadConfiguration();
        }		
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            const clickedTab = event.currentTarget;
            clickedTab.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            if (tabName === 'stats') {
                const selectedTeamId = document.getElementById('team-selector').value;
                loadAdminStats(selectedTeamId);
				loadPlayerTable(selectedTeamId);
            }else if (tabName === 'attendance') {
		        loadAttendanceTable();
		    }
            sessionStorage.setItem('proassist_active_tab', tabName);
        }

		/**
		 * Cambia la vista activa del calendario y lo vuelve a dibujar.
		 * @param {string} viewName El nombre de la vista ('month', 'week', 'day').
		 */
		function setView(viewName) {
		    currentCalendarView = viewName;
		    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
		    document.getElementById(viewName + '-view-btn').classList.add('active');
		    
		    // --- ¡AQUÍ ESTÁ LA MAGIA! ---
		    if (viewName === 'day') {
		        // Si cambiamos a la vista de día, auto-seleccionamos la fecha actual
		        selectDate(toYYYYMMDD(currentDate));
		    }
		    
		    renderCalendarView();
		}

		function previousPeriod() {
		    if (currentCalendarView === 'month') {
		        currentDate.setMonth(currentDate.getMonth() - 1);
		    } else if (currentCalendarView === 'week') {
		        currentDate.setDate(currentDate.getDate() - 7);
		    } else if (currentCalendarView === 'day') {
		        currentDate.setDate(currentDate.getDate() - 1);
		    }
		    
			renderCalendarView();
			selectDate(toYYYYMMDD(currentDate));
		}

		function nextPeriod() {
		    if (currentCalendarView === 'month') {
		        currentDate.setMonth(currentDate.getMonth() + 1);
		    } else if (currentCalendarView === 'week') {
		        currentDate.setDate(currentDate.getDate() + 7);
		    } else if (currentCalendarView === 'day') {
		        currentDate.setDate(currentDate.getDate() + 1);
		    }
		    renderCalendarView();
			selectDate(toYYYYMMDD(currentDate));
		}		

		/**
		 * Función maestra que decide qué vista del calendario dibujar.
		 */
		function renderCalendarView() {
		    console.log(`Renderizando la vista: ${currentCalendarView}`);
		    
		    // Ocultamos todas las vistas posibles primero (por si añadimos más)
		    // document.getElementById('week-view-container').style.display = 'none';
		    // document.getElementById('day-view-container').style.display = 'none';
		    
		    // Mostramos la correcta
		    if (currentCalendarView === 'month') {
		        renderMonthView();
		    } else if (currentCalendarView === 'week') {
		        renderWeekView();
		    } else if (currentCalendarView === 'day') {
		        renderDayView();
		    }
		}
		
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('calendar-month').textContent = `${['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][month]} ${year}`;
            const firstDay = new Date(year, month, 1);
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            let current = new Date(firstDay);
            current.setDate(current.getDate() - firstDay.getDay());
            for (let i = 0; i < 42; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = current.getDate();
                const dateString = toYYYYMMDD(current);
                dayElement.dataset.date = dateString;
                if (current.getMonth() !== month) dayElement.classList.add('other-month');
                if (trainings[dateString]) {
                    dayElement.classList.add('has-training');
                    const indicator = document.createElement('div');
                    indicator.className = 'training-indicator';
                    dayElement.appendChild(indicator);
                }
                dayElement.addEventListener('click', () => selectDate(dateString));
                grid.appendChild(dayElement);
                current.setDate(current.getDate() + 1);
            }
        }		
		
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendarView();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendarView();
        }

        function selectDate(dateString) {
		    selectedDate = dateString;
		    currentDate = new Date(dateString + 'T12:00:00'); // Sincronizamos la fecha principal
		
		    // Si estamos en la vista de mes o semana, resaltamos el día
		    if (currentCalendarView === 'month' || currentCalendarView === 'week') {
		        document.querySelectorAll('.calendar-day.selected').forEach(day => day.classList.remove('selected'));
		        const dayElement = document.querySelector(`[data-date="${dateString}"]`);
		        if (dayElement) dayElement.classList.add('selected');
		    } else if (currentCalendarView === 'day') {
		        // Si estamos en la vista de día, simplemente la volvemos a dibujar
		        renderDayView();
		    }
		    
		    loadTrainingData(dateString);
		}

		/**
		 * Dibuja la vista semanal del calendario con franjas horarias.
		 */
		function renderWeekView() {
		    const grid = document.getElementById('calendar-grid');
		    grid.innerHTML = ''; // Limpiamos el grid
		    grid.style.display = 'grid'; // Aseguramos que sea un grid
		    grid.style.gridTemplateColumns = 'repeat(7, 1fr)'; // 7 columnas iguales
		
		    const hoy = new Date();
		    const diaDeLaSemana = currentDate.getDay(); // 0 (Dom) a 6 (Sáb)
		    const inicioDeLaSemana = new Date(currentDate);
		    inicioDeLaSemana.setDate(currentDate.getDate() - diaDeLaSemana); // Llevamos la fecha al domingo
		
		    // Actualizamos el título del header para mostrar el rango de la semana
		    const finDeLaSemana = new Date(inicioDeLaSemana);
		    finDeLaSemana.setDate(inicioDeLaSemana.getDate() + 6);
		    const opcionesTitulo = { month: 'long', day: 'numeric' };
		    document.getElementById('calendar-month').textContent = 
		        `${inicioDeLaSemana.toLocaleDateString('es-ES', opcionesTitulo)} - ${finDeLaSemana.toLocaleDateString('es-ES', opcionesTitulo)}`;
		
		    // --- Dibujamos los encabezados de los días ---
		    const dayHeaders = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
		    for (let i = 0; i < 7; i++) {
		        const currentDay = new Date(inicioDeLaSemana);
		        currentDay.setDate(inicioDeLaSemana.getDate() + i);
		        
		        const header = document.createElement('div');
		        header.className = 'calendar-day-header';
		        // Mostramos el nombre del día y el número
		        header.innerHTML = `${dayHeaders[i]} <br> <span style="font-size: 1.2em; font-weight: normal;">${currentDay.getDate()}</span>`;
		        
		        // Resaltamos el día de hoy
		        if (toYYYYMMDD(currentDay) === toYYYYMMDD(hoy)) {
		            header.style.backgroundColor = '#2980b9';
		        }
		        grid.appendChild(header);
		    }
		
		    // --- Dibujamos las casillas para los entrenamientos ---
		    for (let i = 0; i < 7; i++) {
		        const currentDay = new Date(inicioDeLaSemana);
		        currentDay.setDate(inicioDeLaSemana.getDate() + i);
		        const dateString = toYYYYMMDD(currentDay);
		        
		        const dayCell = document.createElement('div');
		        dayCell.className = 'calendar-day';
		        dayCell.style.minHeight = '200px'; // Damos más altura para ver los detalles
		        dayCell.dataset.date = dateString;
		        dayCell.addEventListener('click', () => selectDate(dateString));
		
		        // Buscamos si hay un entrenamiento para este día
		        if (trainings[dateString]) {
		            const training = trainings[dateString];
		            dayCell.classList.add('has-training');
		            dayCell.innerHTML = `
		                <div style="font-weight: bold; margin-bottom: 5px;">${training.start} - ${training.end}</div>
		                <div style="font-size: 0.9em; color: #333;">${training.notes || 'Entrenamiento'}</div>
		                ${training.location ? `<div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">📍 ${training.location}</div>` : ''}
		            `;
		        }
		        
		        grid.appendChild(dayCell);
		    }
		}

		/**
		 * Dibuja la vista diaria del calendario, mostrando detalles del entreno del día actual.
		 */
		function renderDayView() {
		    const grid = document.getElementById('calendar-grid');
		    grid.innerHTML = ''; // Limpiamos el grid
		    // Hacemos que la rejilla se comporte como un bloque normal para esta vista
		    grid.style.display = 'block'; 
		
		    // Actualizamos el título del header para mostrar la fecha completa
		    const opcionesTitulo = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
		    document.getElementById('calendar-month').textContent = currentDate.toLocaleDateString('es-ES', opcionesTitulo);
		
		    const dateString = toYYYYMMDD(currentDate);
		    const training = trainings[dateString];
		
		    let contentHtml = '';
		
		    if (training) {
		        // Si SÍ hay entrenamiento para este día
		        contentHtml = `
		            <div class="day-view-card">
		                <h3>Detalles del Entrenamiento</h3>
		                <div class="details">
		                    <p class="detail-item">
		                        <strong>🕒 Horario:</strong> ${training.start} - ${training.end}
		                    </p>
		                    <p class="detail-item">
		                        <strong>📍 Ubicación:</strong> ${training.location || 'No especificada'}
		                    </p>
		                    <p class="detail-item">
		                        <strong>📝 Notas:</strong> ${training.notes || 'Sin notas'}
		                    </p>
		                    ${training.pdfId ? `
							<div class="detail-item">
							    <strong>📄 Sesión:</strong>
							    <a href="https://drive.google.com/file/d/${training.pdfId}/view" target="_blank" class="btn btn-secondary" style="padding: 5px 12px; font-size: 0.9em; margin-left: 10px;">
							        Ver Sesión Adjunta
							    </a>
							</div>
							` : ''}
		                </div>
		            </div>
		        `;
		    } else {
		        // Si NO hay entrenamiento para este día
		        contentHtml = `
		            <div class="day-view-card">
		                <div style="font-size: 3rem; margin-bottom: 1rem;">😴</div>
		                <h3>Día de Descanso</h3>
		                <p>No hay ningún entrenamiento programado para hoy.</p>
		            </div>
		        `;
		    }
		
		    // Usamos un contenedor para que los estilos se apliquen bien
		    grid.innerHTML = `<div class="day-view-container">${contentHtml}</div>`;
		}

		/**
		 * Carga los datos de un entrenamiento seleccionado en el sidebar, OCULTANDO los
		 * botones de acción y el selector de archivos para fechas pasadas.
		 * @param {string} dateString La fecha seleccionada en formato 'YYYY--MM-DD'.
		 */
		function loadTrainingData(dateString) {
		    // --- 1. REFERENCIAS A ELEMENTOS HTML ---
		    const trainingForm = document.getElementById('training-details-form');
		    const buttonContainer = document.getElementById('action-buttons-container');
		    const pdfStatusContainer = document.getElementById('pdf-status-container');
		    const filePickerButton = document.querySelector('#training-details-form button[onclick="openFilePicker()"]');
		    const formInputs = document.querySelectorAll('#training-details-form input, #training-details-form textarea');
		
		    // --- 2. CÁLCULO DE ESTADOS ---
		    const today = toYYYYMMDD(new Date());
		    const isPastDate = dateString && dateString < today;
		    const hasTraining = dateString && trainings[dateString];
		    const training = trainings[dateString] || {};
			const status = training.status || 'Planificado';

			const prepareBtn = document.getElementById('create-form-btn');
			const startBtn = document.getElementById('start-training-btn');
			const attendanceBtn = document.querySelector('button[onclick="submitAttendance()"]');

			// Lógica de visibilidad de botones en el sidebar
			prepareBtn.style.display = (status === 'Planificado') ? 'block' : 'none';
			startBtn.style.display = (status === 'Preparado') ? 'block' : 'none';
			
			// Lógica de visibilidad del botón en la pestaña de asistencia
			if (attendanceBtn) {
			  attendanceBtn.style.display = (status === 'Iniciado') ? 'block' : 'none';
			}
		
		    // --- 3. LÓGICA DE VISIBILIDAD ---
		    trainingForm.style.display = 'block';
		    buttonContainer.style.display = 'block';
		    if (filePickerButton) filePickerButton.style.display = 'block'; // Mostramos el botón por defecto
		    formInputs.forEach(input => input.disabled = false);
		
		    if (isPastDate && !hasTraining) {
		        trainingForm.style.display = 'none';
		        showAlert('Fecha pasada sin entrenamiento registrado.', 'warning');
		    } else if (isPastDate && hasTraining) {
		        buttonContainer.style.display = 'none'; // Ocultamos Guardar/Eliminar/Preparar
		        if (filePickerButton) filePickerButton.style.display = 'none'; // <-- OCULTAMOS EL BOTÓN
		        formInputs.forEach(input => input.disabled = true);
		        showAlert('Estás viendo un entrenamiento pasado. La edición está deshabilitada.', 'warning');
		    }
		
		    // --- 4. RELLENAR LOS DATOS DEL FORMULARIO ---
		    let displayDate = 'dd/mm/aaaa';
		    if (dateString) {
		        const parts = dateString.split('-');
		        displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
		    }
		    document.getElementById('selected-date').value = displayDate;
		    document.getElementById('start-time').value = training.start || '20:45';
		    document.getElementById('end-time').value = training.end || '22:30';
		    document.getElementById('location').value = training.location || '';
		    document.getElementById('notes').value = training.notes || '';
		    
		    // Rellenamos el estado del PDF
		    if (training.pdfId) {
		        pdfStatusContainer.innerHTML = `<a href="https://drive.google.com/file/d/${training.pdfId}/view" target="_blank" class="btn btn-secondary" style="width: 100%;">📄 Ver Sesión Adjunta</a>`;
		    } else {
		        pdfStatusContainer.innerHTML = `<p style="color: #7f8c8d; text-align: center; font-size: 0.9em;">No hay ninguna sesión adjunta.</p>`;
		    }			
		}		

		async function saveTraining() {
		    if (!selectedDate) return showAlert('Por favor, selecciona una fecha.', 'warning');
		    const selectedTeamId = document.getElementById('team-selector').value;
		    if (!selectedTeamId) return showAlert('No se ha seleccionado ningún equipo.', 'warning');
		    		    
		    // 1. Obtenemos el ID del PDF que ya pudiera existir para este entreno.
		    const existingPdfId = trainings[selectedDate] ? trainings[selectedDate].pdfId : '';
		    
		    // 2. Usamos el nuevo archivo seleccionado (si lo hay) o mantenemos el antiguo.
		    //    La variable 'selectedFileId' la rellena la función 'selectFile' del modal.
		    const finalPdfId = selectedFileId || existingPdfId;
		
		    const trainingDetails = {
		        fecha: selectedDate,
		        start: document.getElementById('start-time').value,
		        end: document.getElementById('end-time').value,
		        location: document.getElementById('location').value,
		        notes: document.getElementById('notes').value,
		        pdfId: finalPdfId // <-- Ahora usamos el ID correcto
		    };
		
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'saveTraining');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', selectedTeamId);
		        
		        // Enviamos todos los detalles, incluyendo el pdfId correcto
		        Object.keys(trainingDetails).forEach(key => {
		            url.searchParams.append(key, trainingDetails[key])
		        });
		        
		        console.log("Intentando guardar con URL:", url.toString()); // Mantenemos el debug
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.result && data.result.success) {
		            // Actualizamos nuestro estado local para que la UI se refresque
		            trainings[selectedDate] = trainingDetails;
		            loadTrainingData(selectedDate);
		            renderCalendarView(); // Usamos la función maestra
		            showAlert(data.result.message, 'success');
		        } else {
		            const errorMessage = data.error || data.result?.error || "Error desconocido.";
		            showAlert('Error al guardar: ' + errorMessage, 'warning');
		        }
		    } catch (error) {
		        console.error('Error de conexión al guardar:', error);
		        showAlert('Error de conexión. No se pudo guardar el entrenamiento.', 'warning');
		    } finally {
		        // ¡Importante! Reseteamos la selección para el próximo uso.
		        selectedFileId = null;
		    }
		}        

        async function deleteTraining() {
            if (!selectedDate || !trainings[selectedDate]) return showAlert('No hay un entrenamiento seleccionado para eliminar.', 'warning');
            const selectedTeamId = document.getElementById('team-selector').value;
            if (confirm(`¿Estás seguro de que quieres eliminar el entrenamiento del ${selectedDate} para el equipo ${selectedTeamId}?`)) {
                try {
                    const url = new URL(CONFIG.SCRIPT_URL);
                    url.searchParams.append('action', 'deleteTraining');
                    url.searchParams.append('userEmail', currentUser.email);
                    url.searchParams.append('fecha', selectedDate);
                    url.searchParams.append('teamId', selectedTeamId);
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.success && data.result && data.result.success) {
                        delete trainings[selectedDate];
                        loadTrainingData('');
                        renderCalendarView();
                        showAlert(data.result.message, 'success');
                    } else {
                        const errorMessage = data.error || data.result?.error || "Error desconocido.";
                        showAlert('Error al eliminar: ' + errorMessage, 'warning');
                    }
                } catch (error) {
                    console.error('Error de conexión al eliminar:', error);
                    showAlert('Error de conexión. No se pudo eliminar el entrenamiento.', 'warning');
                }
            }
        }

		/**
		 * Inicia un entrenamiento. Llama al backend para cambiar el estado
		 * y actualiza la interfaz del entrenador.
		 */
		async function startTraining() {
		    if (!selectedDate || !trainings[selectedDate]) {
		        return showAlert('Por favor, selecciona un entrenamiento primero.', 'warning');
		    }
		
		    if (!confirm(`¿Estás seguro de que quieres iniciar el entreno del ${selectedDate}? \n\nEsta acción bloqueará el formulario para las jugadoras.`)) {
		        return;
		    }
		
		    const selectedTeamId = document.getElementById('team-selector').value;
		    const startButton = event.currentTarget;
		
		    // Mostramos estado de carga
		    startButton.disabled = true;
		    startButton.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px; margin: 0;"></div> Iniciando...';
		
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'startTraining');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', selectedTeamId);
		        url.searchParams.append('fecha', selectedDate);
		
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.result.success) {
		            // 1. Actualizamos el estado en nuestro objeto local
		            trainings[selectedDate].status = 'Iniciado';
		            
		            // 2. Volvemos a cargar los datos en el sidebar.
		            //    Esto hará que el botón 'Iniciar Entreno' desaparezca
		            //    y se prepare la UI para el siguiente estado.
		            loadTrainingData(selectedDate);
		            
		            showAlert(data.result.message, 'success');
		        } else {
		            throw new Error(data.error || data.result.error);
		        }
		    } catch (error) {
		        showAlert(`Error al iniciar el entreno: ${error.message}`, 'warning');
		    } finally {
		        // Restauramos el botón (aunque debería desaparecer, es una buena práctica)
		        startButton.disabled = false;
		        startButton.innerHTML = '▶️ Iniciar Entreno';
		    }
		}

        async function prepareForm() {
            if (!selectedDate || !trainings[selectedDate]) return showAlert('Primero debes seleccionar y guardar un entrenamiento.', 'warning');
            const trainingDetails = trainings[selectedDate];
			trainingDetails.fecha = selectedDate;
            const selectedTeamId = document.getElementById('team-selector').value;
            const prepareButton = event.currentTarget;
            prepareButton.disabled = true;
            prepareButton.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Preparando...';
            try {
                const url = new URL(CONFIG.SCRIPT_URL);
                url.searchParams.append('action', 'prepareForm');
                url.searchParams.append('userEmail', currentUser.email);
                url.searchParams.append('teamId', selectedTeamId);
                url.searchParams.append('details', JSON.stringify(trainingDetails));
                const response = await fetch(url);
                const data = await response.json();
                if (data.success && data.result.success) {
                    showAlert(data.result.message, 'success');
                } else {
                    const errorMessage = data.error || data.result?.error || "Error desconocido.";
                    showAlert('Error al preparar el formulario: ' + errorMessage, 'warning');
                }
            } catch (error) {
                console.error('Error de conexión al preparar formulario:', error);
                showAlert('Error de conexión. No se pudo preparar el formulario.', 'warning');
            } finally {
                prepareButton.disabled = false;
                prepareButton.innerHTML = '📋 Preparar Formulario de Asistencia';
            }
        }

		async function loadAdminStats(teamId) {
		    if (!teamId) return;
		
		    // Muestra placeholders de carga SOLO para las tarjetas de equipo
		    document.getElementById('stat-avg-attendance').textContent = '...';
		    document.getElementById('stat-total-trainings').textContent = '...';
		    document.getElementById('stat-upcoming-trainings').textContent = '...';
		    document.getElementById('stat-total-players').textContent = '...';
		
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'getTeamStats');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', teamId);
		        
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success) {
		            const stats = data.stats;
		            document.getElementById('stat-avg-attendance').textContent = `${stats.avgAttendance}%`;
		            document.getElementById('stat-total-trainings').textContent = stats.totalTrainings;
		            document.getElementById('stat-upcoming-trainings').textContent = stats.upcomingTrainings;
		            document.getElementById('stat-total-players').textContent = stats.totalPlayers;
		        } else {
		            throw new Error(data.error);
		        }
		    } catch (error) {
		        console.error("Error al cargar estadísticas del equipo:", error);
		        showAlert('No se pudieron cargar las estadísticas del equipo.', 'warning');
		    }
		}        

        let allPlayersData = []; // Variable global para guardar los datos y poder filtrarlos

		/**
		 * Carga todos los datos de las jugadoras del equipo y renderiza la tabla.
		 * @param {string} teamId El ID del equipo seleccionado.
		 */
		async function loadPlayerTable(teamId) {
		    if (!teamId) return;
		    const tableBody = document.getElementById('player-table-body');
		    tableBody.innerHTML = '<tr><td colspan="5"><div class="spinner"></div><p style="text-align:center;">Cargando datos de jugadoras...</p></td></tr>';
		
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'getPlayerDataForTable');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', teamId);
		
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.data.success) {
		            allPlayersData = data.data.players; // Guardamos los datos en la variable global
		            renderPlayerTable(allPlayersData); // Renderizamos la tabla completa
		        } else {
		            throw new Error(data.error || data.data.error);
		        }
		    } catch (error) {
		        console.error("Error al cargar datos para la tabla de jugadoras:", error);
		        tableBody.innerHTML = `<tr><td colspan="5"><div class="alert alert-warning">${error.message}</div></td></tr>`;
		    }
		}
		
		/**
		 * Dibuja las filas de la tabla de jugadoras a partir de un array de datos.
		 * @param {Array} playersData El array de jugadoras con sus estadísticas.
		 */
		function renderPlayerTable(playersData) {
		    const tableBody = document.getElementById('player-table-body');
		    tableBody.innerHTML = ''; // Limpiamos la tabla
		
		    if (playersData.length === 0) {
		        tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 2rem;">No hay jugadoras que mostrar.</td></tr>';
		        return;
		    }
		
		    playersData.forEach(player => {
		        const row = tableBody.insertRow();
		        row.innerHTML = `
		            <td><strong>${player.name}</strong></td>
		            <td>${player.position || 'N/A'}</td>
		            <td>
		                <div class="attendance-bar-container">
		                    <span>${player.attendanceRate}%</span>
		                    <div class="bar">
		                        <div class="bar-fill" style="width: ${player.attendanceRate}%;"></div>
		                    </div>
		                </div>
		            </td>
			  		<td>
					    <div class="attendance-history">
					        ${player.lastFive.map(item => `<span class="${item.class}">${item.symbol}</span>`).join('')}
					    </div>
					</td>	 				
		            <td>${player.lastMenstruation}</td>
		        `;
		    });
		}

		function filterPlayerTable() {
		    const searchTerm = document.getElementById('player-search-input').value.toLowerCase();
		    const filteredData = allPlayersData.filter(player => 
		        player.name.toLowerCase().includes(searchTerm)
		    );
		    renderPlayerTable(filteredData);
		}

		/**
		 * Carga y muestra la tabla de respuestas para el día seleccionado,
		 * manejando todos los posibles estados del día.
		 */
		async function loadAttendanceTable() {
		    const container = document.getElementById('attendance-table-container');
		    const title = document.getElementById('attendance-title');
		
		    // 1. Manejar el caso de que no haya ninguna fecha seleccionada
		    if (!selectedDate) {
		        title.textContent = "Asistencia de Entreno";
		        container.innerHTML = `<p style="text-align:center; padding:1.5rem;">Selecciona un día en el calendario para ver la asistencia.</p>`;
		        return;
		    }
		
		    const training = trainings[selectedDate];
		    const displayDate = new Date(selectedDate + 'T12:00:00').toLocaleDateString('es-ES', { day: 'numeric', month: 'long' });
		    title.textContent = `Asistencia para el Entreno del ${displayDate}`;
		
		    // 2. Manejar el caso de que sea un DÍA DE DESCANSO
		    if (!training) {
		        container.innerHTML = `
		            <div style="text-align: center; padding: 2rem;">
		                <div style="font-size: 2.5rem; margin-bottom: 1rem;">😴</div>
		                <p>Es un día de descanso. No hay asistencia que mostrar.</p>
		            </div>`;
		        return;
		    }
		
		    // 3. Manejar el caso de que el FORMULARIO NO ESTÉ LISTO
		    if (!training.formId) {
		        container.innerHTML = `<p style="text-align:center; padding:1.5rem;">El formulario para este día aún no ha sido preparado por el entrenador.</p>`;
		        return;
		    }
		
		    // 4. Si todo está bien, CARGAR LAS RESPUESTAS
		    container.innerHTML = '<div class="spinner"></div>';
		    const selectedTeamId = document.getElementById('team-selector').value || (currentUser.teams ? currentUser.teams[0] : null);
		
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'getResponsesForTraining');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', selectedTeamId);
		        url.searchParams.append('date', selectedDate);
		        
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.data.success) {
		            // Reutilizamos la función que dibuja la tabla
		            renderPlayerResponsesTable(data.data.responses, container);
		        } else {
		            throw new Error(data.error || data.data.error);
		        }
		    } catch (error) {
		        container.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
		    }
		}

		/**
		 * Dibuja la tabla de asistencia de forma robusta y en el orden correcto.
		 * @param {Array} responses El array de datos de jugadoras.
		 * @param {HTMLElement} container El div donde se dibujará la tabla.
		 */
		function renderPlayerResponsesTable(responses, container) {
		    if (!responses || responses.length === 0) {
		        container.innerHTML = '<p style="text-align:center; padding: 2rem;">No hay jugadoras en este equipo.</p>';
		        return;
		    }
		    
		    // --- 1. DEFINIMOS EL ORDEN Y TÍTULOS DE NUESTRAS COLUMNAS ---
		    const columns = [
		        { key: 'Jugadora', title: 'Jugadora' },
		        { key: 'Respuesta_Previa', title: 'Respuesta' },
		        { key: 'Asistencia_Confirmada', title: 'Asist.' },
		        { key: 'Físico', title: 'Físico' },
		        { key: 'Notas', title: 'Notas' }
		    ];
		
		    // --- 2. CONSTRUIMOS EL HTML DE LA TABLA ---
		    let tableHtml = '<div style="overflow-x:auto;"><table id="player-stats-table"><thead><tr>';
		    
		    // Creamos los encabezados
		    columns.forEach(col => {
		        tableHtml += `<th>${col.title}</th>`;
		    });
		    tableHtml += '</tr></thead><tbody>';
		
		    // Comprobamos si el entreno es una fecha pasada
		    const isPastDate = selectedDate && selectedDate < toYYYYMMDD(new Date());
		
		    // Creamos las filas
		    responses.forEach(playerData => {
		        tableHtml += '<tr>';
		        columns.forEach(col => {
		            if (col.key === 'Asistencia_Confirmada') {
		                // Caso especial para el checkbox
		                const isChecked = playerData[col.key] === true ? 'checked' : '';
		                const isDisabled = isPastDate && currentUser.role === 'ASSISTANT' ? 'disabled' : '';
		                tableHtml += `<td><input type="checkbox" data-email="${playerData['Email']}" ${isChecked} ${isDisabled}></td>`;
		            } else {
		                // Para el resto de columnas, simplemente añadimos el dato
		                tableHtml += `<td>${playerData[col.key] || '-'}</td>`;
		            }
		        });
		        tableHtml += '</tr>';
		    });
		
		    tableHtml += '</tbody></table></div>';
		    
		    // --- 3. AÑADIMOS EL BOTÓN DE GUARDAR SI ES NECESARIO ---
			let showSaveButton = true; // Por defecto, mostramos el botón

			if (isPastDate && currentUser.role === 'ASSISTANT') {
			    // Si el entreno ha pasado Y el usuario es un Ayudante, OCULTAMOS el botón
			    showSaveButton = false;
			}
			
			if (showSaveButton) {
			    tableHtml += `
			        <div style="text-align: right; margin-top: 1.5rem;">
			            <button class="btn btn-success" onclick="submitAttendance()">Guardar Asistencia</button>
			        </div>
			    `;
			}		    
		    
		    container.innerHTML = tableHtml;
		}				

		/**
		 * Recopila los datos de los checkboxes de asistencia y los envía al backend.
		 */
		async function submitAttendance() {
		    const saveButton = event.currentTarget;
		    const checkboxes = document.querySelectorAll('#attendance-table-container input[type="checkbox"]');
		    
		    const attendanceData = [];
		    checkboxes.forEach(cb => {
		        if (cb.dataset.email) {
		            attendanceData.push({
		                email: cb.dataset.email,
		                isPresent: cb.checked
		            });
		        }
		    });
		
		    if (attendanceData.length === 0) {
		        return showAlert("No hay datos de asistencia para guardar.", "warning");
		    }
		
		    const selectedTeamId = document.getElementById('team-selector').value || (currentUser.teams ? currentUser.teams[0] : null);
		    const trainingDate = selectedDate;
		
		    // Mostramos estado de carga
		    saveButton.disabled = true;
		    saveButton.innerHTML = '<div class="spinner" style="width:18px;height:18px;border-width:2px; margin: 0;"></div>';
		
		    try {
		        // --- CONSTRUIMOS LA URL CON GET ---
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'saveAttendance');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', selectedTeamId);
		        url.searchParams.append('trainingDate', trainingDate);
		        // Convertimos el array de datos a un string JSON para enviarlo como parámetro
		        url.searchParams.append('attendanceData', JSON.stringify(attendanceData));
		
		        // Hacemos la petición GET
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.result.success) {
		            showAlert(data.result.message, 'success');
		        } else {
		            throw new Error(data.error || data.result.error);
		        }
		    } catch (error) {
		        showAlert(`Error al guardar la asistencia: ${error.message}`, 'warning');
		    } finally {
		        saveButton.disabled = false;
		        saveButton.textContent = 'Guardar Asistencia';
		    }
		}		
        
        // ========================
        // OTRAS FUNCIONES Y LISTENERS
        // ========================
        function loadConfiguration() {
            const savedConfig = localStorage.getItem('proassist-config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('form-base-id').value = config.formBaseId || '';
                document.getElementById('sheet-id').value = config.sheetId || '';
                document.getElementById('email-entry').value = config.emailEntry || '';
            }
        }

        function guardarConfiguracion() {
            const config = {
                formBaseId: document.getElementById('form-base-id').value,
                sheetId: document.getElementById('sheet-id').value,
                emailEntry: document.getElementById('email-entry').value
            };
            localStorage.setItem('proassist-config', JSON.stringify(config));
            showAlert('💾 Configuración guardada localmente', 'success');
        }

		/*
		function startAutoRefresh() {
		    stopAutoRefresh();
		    refreshInterval = setInterval(async () => {
		        showRefreshIndicator();
				        
				if (document.getElementById('player-dashboard').style.display === 'block') {
				    const playerTeamId = currentUser.teams[0];
				    if (playerTeamId) {
				        await loadPlayerFormState(playerTeamId); // <-- Llamada corregida
				    }
				}
				else if (document.getElementById('admin-panel').style.display === 'block') {
		            // En el futuro, podríamos refrescar los datos del admin también
		            console.log("Auto-refresh: Panel de admin activo, no se hace nada por ahora.");
		            // const selectedTeamId = document.getElementById('team-selector').value;
		            // await initializeAdminPanel(selectedTeamId); // <-- Esto lo activaremos si lo necesitamos
		        }
		
		    }, CONFIG.AUTO_REFRESH_INTERVAL);
		}
  		*/

		/*
        function stopAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }
		*/

		/*
        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
        }
		*/

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#ff4757;color:white;padding:15px 25px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,0.2);z-index:10000;font-weight:bold;max-width:400px;text-align:center;`;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

		function showAlert(message, type) {
		    const alert = document.createElement('div');
		    // Usamos una clase genérica para posicionamiento
		    alert.className = `alert-popup alert-${type}`;
		    alert.textContent = message;
		    document.body.appendChild(alert);
		    setTimeout(() => alert.remove(), 4000); // Duración un poco más corta
		}

		/**
		 * Se activa cuando el usuario vuelve a la pestaña de la app.
		 * Refresca los datos de la vista activa.
		 */
		/*
		async function handleVisibilityChange() {
		    if (document.hidden === false && currentUser) {
		        if (document.getElementById('player-dashboard').style.display === 'block') {
		            const playerTeamId = currentUser.teams[0];
		            if (playerTeamId) {
		                // Refrescamos toda la info de la jugadora
		                await loadPlayerFormState(playerTeamId);
		                await loadUserStats(playerTeamId);
		                await loadUserHistory(playerTeamId);
		            }
		        } else if (document.getElementById('admin-panel').style.display === 'block') {
		            const selectedTeamId = document.getElementById('team-selector').value;
		            if (selectedTeamId) {
		                await initializeAdminPanel(selectedTeamId);
		            }
		        }
		    }
		} 
  		*/

		/**
		 * Se activa cuando el usuario vuelve a la pestaña de la app.
		 * Refresca los datos de la vista activa.
		 */
		async function handleVisibilityChange() {
		    if (document.hidden === false && currentUser) {
		        
		        if (document.getElementById('player-dashboard').style.display === 'block') {
		            console.log("Pestaña visible: Refrescando datos de la jugadora...");
		            const playerTeamId = currentUser.teams[0];
		            if (playerTeamId) {
		                // --- LLAMADA A LA NUEVA FUNCIÓN MAESTRA ---
		                await initializePlayerPanel(playerTeamId);
		            }
		        } else if (document.getElementById('admin-panel').style.display === 'block') {
		            console.log("Pestaña visible: Panel de admin activo, refrescando datos del equipo...");
		            const selectedTeamId = document.getElementById('team-selector').value;
		            if (selectedTeamId) {
		                await initializeAdminPanel(selectedTeamId);
		            }
		        }
		    }
		}

		/**
		 * Asigna texto a un elemento de forma segura. Si el elemento no existe, no hace nada.
		 * @param {string} id El ID del elemento.
		 * @param {string} text El texto a asignar.
		 */
		function safeSetText(id, text) {
		    const element = document.getElementById(id);
		    if (element) {
		        element.textContent = text;
		    }
		}
		
		/**
		 * Asigna el ancho a un elemento de forma segura.
		 * @param {string} id El ID del elemento.
		 * @param {string} width El ancho en porcentaje (ej: '50%').
		 */
		function safeSetWidth(id, width) {
		    const element = document.getElementById(id);
		    if (element) {
		        element.style.width = width;
		    }
		}

		let selectedFileId = null; // Variable global temporal para guardar el ID seleccionado

		async function openFilePicker() {
		    const modal = document.getElementById('file-picker-modal');
		    const fileListDiv = document.getElementById('file-picker-list');
		    modal.style.display = 'flex';
		    fileListDiv.innerHTML = '<div class="spinner"></div><p>Cargando archivos...</p>';
		
		    try {
		        // 1. Obtener el ID de la carpeta del equipo desde la hoja Equipos
		        const selectedTeamId = document.getElementById('team-selector').value;
		        const teamFolderId = await getTeamFolderId(selectedTeamId); // Necesitamos esta nueva función en el backend
		
		        // 2. Pedir al backend la lista de archivos de esa carpeta
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=listFilesByFolderId&folderId=${teamFolderId}`);
		        const data = await response.json();
				// La respuesta ahora es { success: true, filesList: { success: true, files: [...] } }
				if (data.success && data.filesList.success) {
				    fileListDiv.innerHTML = '';
				    if (data.filesList.files.length === 0) {
				        fileListDiv.innerHTML = '<p>No hay archivos en esta carpeta.</p>';
				    } else {
				        data.filesList.files.forEach(file => {
				            const fileButton = document.createElement('button');
				            fileButton.className = 'file-item';
				            fileButton.textContent = file.name;
				            fileButton.onclick = () => selectFile(file.id, file.name);
				            fileListDiv.appendChild(fileButton);
				        });
				    }
				} else {
				    throw new Error(data.error || data.filesList.error);
				}
		    } catch (error) {
		        fileListDiv.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
		    }
		}
		
		function selectFile(fileId, fileName) {
		    selectedFileId = fileId; // Guardamos el ID
		    // Actualizamos la UI del sidebar
		    document.getElementById('pdf-status-container').innerHTML = `
		        <div class="alert alert-success">Seleccionado: <strong>${fileName}</strong></div>
		    `;
		    closeFilePicker();
		}
		
		function closeFilePicker() {
		    document.getElementById('file-picker-modal').style.display = 'none';
		}

		/**
		 * Pide al backend el ID de la carpeta de sesiones de un equipo.
		 * @param {string} teamId El ID del equipo.
		 * @returns {string} El ID de la carpeta de Google Drive.
		 */
		async function getTeamFolderId(teamId) {
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'getTeamFolderId');
		        url.searchParams.append('userEmail', currentUser.email); // Seguridad
		        url.searchParams.append('teamId', teamId);
		
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.folderData.success) {
		            return data.folderData.folderId;
		        } else {
		            throw new Error(data.error || data.folderData.error);
		        }
		    } catch (error) {
		        console.error("Error obteniendo el ID de la carpeta del equipo:", error);
		        // Devolvemos una promesa rechazada para que el 'catch' en openFilePicker la maneje
		        return Promise.reject(error);
		    }
		}
    </script>
</body>
