<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚽ ProAssist - Mi Dashboard</title>
    <script src="https://accounts.google.com/gsi/client"></script>
	<!-- ======================== -->
	<!-- ESQUEMA DE COLORES CSS -->
	<!-- ======================== -->
    <style>
	    /* ======================================== */
	    /* === 1. RESET Y CONFIGURACIÓN GLOBAL ==== */
	    /* ======================================== */
	    * {
	        margin: 0;
	        padding: 0;
	        box-sizing: border-box;
	    }
	    
	    body {
	        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	        background-color: #34495e;
	        min-height: 100vh;
	        color: #333;
	    }
	
	    /* ======================================== */
	    /* ========= 2. LAYOUT PRINCIPAL ========== */
	    /* ======================================== */
	    .container {
	        max-width: 1200px;
	        margin: 1.5rem auto;
	        padding: 0 1rem; /* Padding horizontal para que el contenido no toque los bordes en móvil */
	    }
	
	    /* Oculta los dashboards por defecto */
	    #player-dashboard, #admin-panel {
	        display: none;
	    }
	
	    /* ======================================== */
	    /* ========= 3. PANTALLA DE LOGIN ========= */
	    /* ======================================== */
	    .login-screen {
	        display: flex;
	        flex-direction: column;
	        justify-content: center;
	        align-items: center;
	        min-height: 100vh;
	        text-align: center;
	        padding: 1rem;
	    }
	
	    .login-card {
	        background: rgba(255, 255, 255, 0.95);
	        padding: 2.5rem;
	        border-radius: 20px;
	        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
	        max-width: 400px;
	        width: 100%;
	    }
	
	    .app-logo img {
	        width: 80px;
	        height: 80px;
	        margin-bottom: 1rem;
	    }
	
	    .app-title {
	        font-size: 2rem;
	        font-weight: bold;
	        margin-bottom: 0.5rem;
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        -webkit-background-clip: text;
	        -webkit-text-fill-color: transparent;
	        background-clip: text;
	    }
	
	    .app-subtitle {
	        color: #666;
	        margin-bottom: 2rem;
	        font-size: 1.1rem;
	    }
	
	    /* ======================================== */
	    /* ======== 4. COMPONENTES COMUNES ======== */
	    /* ======================================== */
	
	    /* --- Header Unificado --- */
	    .header {
	        background: white;
	        padding: 1rem 1.5rem;
	        border-radius: 15px;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        margin-bottom: 1.5rem;
	    }
	    
	    .logo {
	        display: flex;
	        align-items: center;
	        gap: 10px;
	        font-size: 1.4em;
	        font-weight: bold;
	        color: #2c3e50;
	    }
	
	    .admin-badge {
	        background: #e74c3c;
	        color: white;
	        padding: 4px 12px;
	        border-radius: 15px;
	        font-size: 0.7em;
	    }
	
	    /* --- Botones Genéricos --- */
	    .btn {
	        padding: 10px 20px;
	        border: none;
	        border-radius: 8px;
	        cursor: pointer;
	        font-size: 14px;
	        font-weight: bold;
	        transition: all 0.3s ease;
	        display: inline-flex;
	        align-items: center;
	        justify-content: center;
	        gap: 8px;
	    }
	    .btn:hover {
	        transform: translateY(-2px);
	        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	    }
	    .btn-primary { background: #3498db; color: white; }
	    .btn-success { background: #27ae60; color: white; }
	    .btn-danger { background: #e74c3c; color: white; }
	    .btn-secondary { background: #95a5a6; color: white; }
	    .btn-primary:hover { background: #2980b9; }
	    .btn-success:hover { background: #219a52; }
	    .btn-danger:hover { background: #c0392b; }
	    .btn-secondary:hover { background: #7f8c8d; }
	
	    /* --- Tarjetas (Cards) --- */
	    .card {
	        background: white;
	        border-radius: 15px;
	        padding: 1.5rem;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        transition: transform 0.3s ease;
	    }
	    .card:hover {
	        transform: translateY(-5px);
	    }
	    
	    /* --- Formularios --- */
	    .form-group {
	        margin-bottom: 1rem;
	    }
	    .form-group label {
	        display: block;
	        margin-bottom: 5px;
	        font-weight: bold;
	        color: #2c3e50;
	    }
	    .form-group input, .form-group select, .form-group textarea {
	        width: 100%;
	        padding: 12px;
	        border: 1px solid #ddd;
	        border-radius: 8px;
	        font-size: 14px;
	    }
	    
	    /* --- Alertas y Carga --- */
	    .alert {
	        padding: 1rem;
	        border-radius: 8px;
	        margin-bottom: 1rem;
	    }
	    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
	    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
	
	    .loading-placeholder {
	        text-align: center;
	        padding: 40px;
	        color: #666;
	    }
	    .spinner {
	        border: 4px solid #f3f3f3;
	        border-top: 4px solid #3498db;
	        border-radius: 50%;
	        width: 40px;
	        height: 40px;
	        animation: spin 1s linear infinite;
	        margin: 0 auto 1rem;
	    }
	    @keyframes spin {
	        0% { transform: rotate(0deg); }
	        100% { transform: rotate(360deg); }
	    }
	
	    /* ======================================== */
	    /* ===== 5. DASHBOARD JUGADORA (PLAYER) ==== */
	    /* ======================================== */
	    .stats-grid {
	        display: grid;
	        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
	        gap: 1.5rem;
	        margin-bottom: 1.5rem;
	    }
	
	    .motivational-message {
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        color: white;
	        padding: 1.5rem;
	        border-radius: 15px;
	        margin-bottom: 1.5rem;
	        text-align: center;
	        box-shadow: 0 5px 20px rgba(52, 152, 219, 0.2);
	    }
	    .motivational-message h3 {
	        margin-bottom: 0.5rem;
	        font-size: 1.3rem;
	    }
	
	    .stat-title {
	        font-size: 1.2rem;
	        font-weight: bold;
	        margin-bottom: 1rem;
	        display: flex;
	        align-items: center;
	        gap: 10px;
	    }
	    .stat-value {
	        font-size: 2.5rem;
	        font-weight: bold;
	        color: #3498db;
	        margin-bottom: 0.5rem;
	    }
	    .stat-description {
	        color: #666;
	        font-size: 0.9rem;
	    }
	    .progress-bar {
	        width: 100%;
	        height: 10px;
	        background: #e0e0e0;
	        border-radius: 5px;
	        margin-top: 0.5rem;
	        overflow: hidden;
	    }
	    .progress-fill {
	        height: 100%;
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        border-radius: 5px;
	        transition: width 0.3s ease;
	    }
	    .form-frame {
	        width: 100%;
	        min-height: 600px;
	        border: none;
	        border-radius: 10px;
	    }
		.history-item {
		    display: flex;
		    justify-content: space-between;
		    align-items: center;
		    padding: 1rem 0;
		    border-bottom: 1px solid #eee;
		}
		.history-item:last-child {
		    border-bottom: none;
		    padding-bottom: 0;
		}
		.history-date {
		    font-weight: bold;
		}
		.history-status {
		    padding: 5px 12px;
		    border-radius: 20px;
		    font-size: 0.8rem;
		    font-weight: bold;
		    text-align: center;
		}
		.status-completed { /* Verde para "Asistió" */
		    background-color: #d4edda;
		    color: #155724;
		}
		.status-missed { /* Rojo para "No Asistió" */
		    background-color: #f8d7da;
		    color: #721c24;
		}
	
	    /* ======================================== */
	    /* ===== 6. PANEL ADMINISTRADOR (ADMIN) ===== */
	    /* ======================================== */
	    .admin-content {
	        background: white;
	        border-radius: 15px;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        overflow: hidden; /* Para contener los bordes redondeados */
	    }
	    .tabs {
	        display: flex;
	        background: #ecf0f1;
	    }
	    .tab {
	        flex: 1;
	        padding: 1rem;
	        background: none;
	        border: none;
	        cursor: pointer;
	        font-size: 1em;
	        font-weight: bold;
	        transition: all 0.3s ease;
	        display: flex;
	        align-items: center;
	        justify-content: center;
	        gap: 8px;
	        color: #7f8c8d;
	    }
	    .tab.active {
	        background: white;
	        color: #2c3e50;
	    }
	    .tab:hover:not(.active) {
	        background: #e0e6e8;
	    }
	    .tab-panel {
	        display: none;
	        padding: 1.5rem;
	    }
	    .tab-panel.active {
	        display: block;
	    }
	
	    .calendar-container {
	        display: grid;
	        grid-template-columns: 1fr 300px;
	        gap: 1.5rem;
	    }

		.calendar-header {
		    /* Hacemos que el header sea un flexbox */
		    display: flex;
		    justify-content: space-between; /* Empuja los elementos a los extremos */
		    align-items: center;
		    flex-wrap: wrap; /* Permite que los elementos se coloquen abajo si no caben */
		    gap: 1rem; /* Espacio entre los bloques por si se apilan */
		}
		
		.calendar-title-nav {
		    display: flex;
		    align-items: center;
		    gap: 1rem;
		    flex-grow: 1; /* Permite que este bloque crezca */
		    justify-content: center; /* Centra el título y las flechas */
		}
		
		#calendar-month {
		    min-width: 200px;
		    text-align: center;
		}
		
		/* En pantallas muy pequeñas, centramos todo */
		@media (max-width: 500px) {
		    .calendar-header {
		        justify-content: center;
		    }
		}
		
	    .calendar-grid {
	        display: grid;
	        grid-template-columns: repeat(7, 1fr);
	        gap: 1px;
	        background: #ddd;
	    }
	    .calendar-day-header {
	        background: #34495e;
	        color: white;
	        padding: 10px;
	        text-align: center;
	        font-weight: bold;
	        font-size: 0.9em;
	    }
	    .calendar-day {
	        background: white;
	        min-height: 80px;
	        padding: 8px;
	        cursor: pointer;
	        position: relative;
	        transition: all 0.3s ease;
	    }
	    .calendar-day:hover { background: #f0f5f9; }
	    .calendar-day.other-month { background: #f8f9fa; color: #ccc; }
	    .calendar-day.has-training { background: #e8f5e8; }
	    .calendar-day.selected { background: #3498db; color: white; }
	    .training-indicator {
	        position: absolute;
	        bottom: 4px;
	        right: 4px;
	        width: 8px;
	        height: 8px;
	        background: #27ae60;
	        border-radius: 50%;
	    }
	    .sidebar {
	        background: #f8f9fa;
	        border-radius: 8px;
	        padding: 1.5rem;
	    }
	
	    /* ======================================== */
	    /* ======== 7. RESPONSIVE DESIGN ========== */
	    /* ======================================== */
	    @media (max-width: 992px) {
	        .calendar-container {
	            grid-template-columns: 1fr; /* Apila el calendario y el formulario */
	        }
	        .sidebar {
	            margin-top: 1.5rem;
	        }
	    }
	    
	    @media (max-width: 768px) {
	        .header {
	            flex-direction: column; /* Apila logo y botones */
	            gap: 1rem;
	            padding: 1rem;
	        }
	        .logo { font-size: 1.3em; }
	
	        .stats-grid {
	            grid-template-columns: 1fr; /* Una columna para las estadísticas */
	        }
	        
	        .tabs {
	            flex-direction: column; /* Apila las pestañas del admin */
	        }
	    }

		/* Estilo para las alertas flotantes */
		.alert-popup {
		    position: fixed;
		    top: 20px;
		    left: 50%;
		    transform: translateX(-50%);
		    padding: 15px 25px;
		    border-radius: 10px;
		    box-shadow: 0 5px 20px rgba(0,0,0,0.2);
		    z-index: 10000;
		    font-weight: bold;
		    max-width: 90%;
		    text-align: center;
		}

		/* Estilos para el selector de vistas del calendario */
		.view-btn {
		    border: none;
		    color: white;
		    padding: 6px 14px;
		    border-radius: 5px;
		    cursor: pointer;
		    transition: all 0.2s ease;
		    margin-left: 5px;
		    font-weight: bold;
		    background: #34495e; /* Azul oscuro (como los días del calendario) */
		}
		
		.view-btn:not(.active):hover {
		    background: #2c3e50; /* Un azul oscuro más intenso al pasar el ratón */
		}
		
		.view-btn.active {
		    background: #3498db; /* Azul claro para el botón activo */
		    color: white;
		}
		
		.calendar-nav {
		    background: #3498db; /* Azul claro (como el día seleccionado) */
		    border: none;
		    color: white;
		    font-size: 1.5em;
		    cursor: pointer;
		    padding: 5px 10px;
		    border-radius: 5px;
		    transition: background 0.2s ease;
		    line-height: 1;
		}
		.calendar-nav:hover {
		    background: #2980b9; /* Un azul un poco más oscuro al pasar el ratón */
		}

		/* Estilos para la Vista Diaria */
		.day-view-container {
		    padding: 2rem;
		    text-align: center;
		}
		
		.day-view-card {
		    background-color: #f8f9fa;
		    border-radius: 15px;
		    padding: 2rem;
		    max-width: 600px;
		    margin: 0 auto;
		    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
		}
		
		.day-view-card h3 {
		    font-size: 1.8em;
		    color: #2c3e50;
		    margin-bottom: 1rem;
		}
		
		.day-view-card p {
		    font-size: 1.1em;
		    color: #7f8c8d;
		    line-height: 1.6;
		}
		
		.day-view-card .details {
		    text-align: left;
		    margin-top: 2rem;
		    border-top: 1px solid #ddd;
		    padding-top: 2rem;
		}
		
		.day-view-card .detail-item {
		    display: flex;
		    align-items: center;
		    gap: 15px;
		    margin-bottom: 1rem;
		    font-size: 1.1em;
		}	

		.modal-overlay {
		    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
		    background: rgba(0,0,0,0.6); z-index: 1000;
		    display: flex; align-items: center; justify-content: center;
		}
		.modal-content {
		    background: white; border-radius: 15px; width: 90%; max-width: 600px;
		    box-shadow: 0 5px 25px rgba(0,0,0,0.2); overflow: hidden;
		}
		.modal-header {
		    display: flex; justify-content: space-between; align-items: center;
		    padding: 1rem 1.5rem; border-bottom: 1px solid #eee;
		}
		.close-btn {
		    background: none; border: none; font-size: 2em; cursor: pointer; color: #888;
		}
		.modal-body {
		    padding: 1.5rem; max-height: 60vh; overflow-y: auto;
		}
		.file-item {
		    display: block; width: 100%; text-align: left; padding: 1rem;
		    border: 1px solid #ddd; border-radius: 8px; margin-bottom: 10px;
		    cursor: pointer; transition: all 0.2s ease;
		}
		.file-item:hover { background: #f0f5f9; border-color: #3498db; }
	</style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <!-- ======================== -->
			<!-- LOGO HTML -->
			<!-- ======================== -->
			<!-- Reemplazar esta línea: <div class="app-logo">⚽</div> -->
			<div class="app-logo">
				<img src="ProAssist.png" alt="ProAssist Logo" style="width: 80px; height: 80px; margin-bottom: 15px;">
			</div>
            <h1 class="app-title">ProAssist</h1>
            <p class="app-subtitle">Tu dashboard personal de entrenamientos</p>
            <button id="signInButton" class="google-signin-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Iniciar sesión con Google
            </button>
            <div id="loginLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Iniciando sesión...</p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD JUGADORA -->    
	<div id="player-dashboard" style="display: none;">
        <div class="container">
	        <!-- Header Unificado -->
	        <header class="header">
	            <div class="logo">
	                <span id="greeting"></span>
	            </div>
	            <div>
	                <button class="btn btn-danger" onclick="signOut()">🚪 Cerrar Sesión</button>
	            </div>
	        </header>
	
	        <!-- Mensaje Motivacional -->
	        <div id="motivationalMessage" class="motivational-message" style="display: none;">
	            <h3 id="motivationalTitle"></h3>
	            <p id="motivationalText"></p>
	        </div>
	
	        <!-- Contenedor Principal para la Vista Diaria de la Jugadora -->
	        <div id="player-day-view-container" class="card">
	            <!-- El contenido se generará con JavaScript -->
	        </div>

			<div class="stats-grid" style="margin-top: 1.5rem;">
			    <div class="card">
			        <div class="stat-title">📊 Mis Estadísticas</div>
			        <div class="stat-value" id="totalTrainings">-</div>
			        <div class="stat-description">Entrenamientos completados</div>
			        <div style="margin-top: 20px;">
			            <span>Asistencia</span>
			            <span id="attendanceRate" style="float: right;">-</span>
			            <div class="progress-bar">
			                <div id="attendanceProgress" class="progress-fill" style="width: 0%"></div>
			            </div>
			        </div>
			    </div>
			    <div class="card">
			        <div class="stat-title">👥 Comparación con Equipo</div>
			         <div style="margin-top: 1rem;">
			            <span>Tu Asistencia</span>
			            <span id="myAttendanceRate" style="float: right;">-</span>
			            <div class="progress-bar">
			                <div id="myAttendanceProgress" class="progress-fill" style="width: 0%"></div>
			            </div>
			        </div>
			        <div style="margin-top: 1.5rem;">
			            <span>Media del Equipo</span>
			            <span id="teamAverageRate" style="float: right;">-</span>
			            <div class="progress-bar">
			                <div id="teamAverageProgress" class="progress-fill" style="background: #e67e22; width: 0%;"></div>
			            </div>
			        </div>
			    </div>
			    <div class="card">
			        <div class="stat-title">📅 Historial Reciente</div>
			        <div id="historyList">Cargando historial...</div>
			    </div>
			</div>
	    </div>
    </div>

    <!-- PANEL DE ADMINISTRADOR -->
    <div id="admin-panel" style="display: none;">  		
	    <div class="container">
			<!-- HEADER UNIFICADO PARA ADMIN -->
	        <header class="header">
	            <div class="logo">
	                ⚽ ProAssist
	                <span id="role-badge" class="admin-badge"></span>
	            </div>
	            <div style="display: flex; gap: 10px;">
	                <button class="btn btn-danger" onclick="signOut()">🚪 Cerrar Sesión</button>
	            </div>
	        </header>
			<!-- NUEVO: SELECTOR DE EQUIPO PARA EL COACH -->
		    <div id="team-selector-header" class="header" style="display: none; margin-bottom: 1.5rem; border-radius: 15px;">
		        <div style="display: flex; align-items: center; gap: 15px;">
		            <label for="team-selector" style="font-weight: bold;">Selecciona un equipo para gestionar:</label>
		            <select id="team-selector" class="btn" style="background-color: white; color: black;"></select>
		        </div>
		    </div>
			<div class="admin-content">
		        <div class="tabs">
		            <button class="tab active" onclick="showTab('calendar')">
		                📅 Calendario
		            </button>
		            <button id="config-tab-button" class="tab" onclick="showTab('config')">
		                ⚙️ Configuración
		            </button>
		            <button class="tab" onclick="showTab('stats')">
		                📊 Estadísticas
		            </button>
		        </div>
		
		        <div class="content">
		            <!-- CALENDARIO TAB -->
		            <div id="calendar-tab" class="tab-panel active">
		                <div class="calendar-container">
		                    <div class="calendar">
		                        <div class="calendar-header">
								    <!-- Contenedor para el título y la navegación -->
								    <div class="calendar-title-nav">
								        <button class="calendar-nav" onclick="previousPeriod()">‹</button>
								        <h2 id="calendar-month">Agosto 2025</h2>
								        <button class="calendar-nav" onclick="nextPeriod()">›</button>
								    </div>
								    
								    <!-- El selector de vistas se queda como está -->
								    <div id="view-switcher">
								        <button id="month-view-btn" class="view-btn" onclick="setView('month')">Mes</button>
								        <button id="week-view-btn" class="view-btn active" onclick="setView('week')">Semana</button>
								        <button id="day-view-btn" class="view-btn" onclick="setView('day')">Día</button>
								    </div>
								</div>
		                        <div class="calendar-grid" id="calendar-grid">
		                            <!-- Se genera con JavaScript -->
		                        </div>
		                    </div>
		                    
		                    <div class="sidebar">
		                        <h3>📝 Entreno Seleccionado</h3>
		                        <div id="training-details-form">
		                            <div class="form-group">
		                                <label>📅 Fecha:</label>
		                                <input type="text" id="selected-date" readonly>
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>🕐 Hora Inicio:</label>
		                                <input type="time" id="start-time" value="20:45">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>🕐 Hora Fin:</label>
		                                <input type="time" id="end-time" value="22:30">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>📍 Ubicación:</label>
		                                <input type="text" id="location" placeholder="Campo de entrenamiento">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>📝 Notas:</label>
		                                <textarea id="notes" rows="3" placeholder="Notas adicionales del entreno..."></textarea>
		                            </div>

									<div class="form-group">
									    <label>📄 Sesión de Entrenamiento:</label>
									    <div id="pdf-status-container">
									        <!-- El JS llenará esto -->
									    </div>
									    <button class="btn btn-primary" style="width:100%; margin-top:10px;" onclick="openFilePicker()">
									        📂 Seleccionar Sesión de Drive
									    </button>
									</div>
									
									<!-- MODAL PARA EL SELECTOR DE ARCHIVOS (añade esto al final del <body>) -->
									<div id="file-picker-modal" class="modal-overlay" style="display:none;">
									    <div class="modal-content">
									        <div class="modal-header">
									            <h3>Seleccionar Archivo de Sesión</h3>
									            <button class="close-btn" onclick="closeFilePicker()">&times;</button>
									        </div>
									        <div id="file-picker-list" class="modal-body">
									            <!-- La lista de archivos se cargará aquí -->
									        </div>
									    </div>
									</div>

									<!-- Contenedor de botones con Flexbox y Flex-wrap -->
									<div id="action-buttons-container" style="margin-top: 1.5rem; border-top: 1px solid #ddd; padding-top: 1.5rem;">
									    <!-- Usaremos Flexbox con envoltura para una máxima adaptabilidad -->
									    <div style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center;">
									        <button id="save-training-btn" class="btn btn-success" onclick="saveTraining()" style="flex-grow: 1;">✅ Guardar</button>
									        <button id="create-form-btn" class="btn btn-primary" onclick="prepareForm()" style="flex-grow: 2; min-width: 180px;">📋 Preparar Formulario</button>
									        <button id="delete-training-btn" class="btn btn-danger" onclick="deleteTraining()" style="flex-grow: 1;">🗑️ Eliminar</button>
									    </div>
									</div>
		                        </div>
		                    </div>
		                </div>
		            </div>
		
		            <!-- CONFIGURACIÓN TAB -->
		            <div id="config-tab" class="tab-panel">
		                <div class="config-section">
		                    <h3>⚙️ Configuración por Defecto</h3>
		                    <p>Define los días y horarios habituales de entrenamiento. Esto creará automáticamente los entrenamientos para las próximas semanas.</p>
		                    
		                    <div class="days-grid">
		                        <div class="day-config" id="day-tuesday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-tuesday" onchange="toggleDay('tuesday')">
		                                <label for="enable-tuesday"><strong>Martes</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="tuesday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="tuesday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                        
		                        <div class="day-config" id="day-thursday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-thursday" onchange="toggleDay('thursday')">
		                                <label for="enable-thursday"><strong>Jueves</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="thursday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="thursday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                        
		                        <div class="day-config" id="day-friday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-friday" onchange="toggleDay('friday')">
		                                <label for="enable-friday"><strong>Viernes</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="friday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="friday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    
		                    <div style="margin-top: 1.5rem;">
		                        <button class="btn btn-success" onclick="generateTrainings()">
		                            🔄 Generar Próximos 4 Entrenamientos
		                        </button>
		                        <button class="btn btn-secondary" onclick="clearAllTrainings()">
		                            🗑️ Limpiar Calendario
		                        </button>
		                    </div>
		                </div>
		
		                <div class="config-section">
		                    <h3>📋 Configuración de Formularios</h3>
		                    
		                    <div class="form-group">
		                        <label>🔗 ID Formulario Base:</label>
		                        <input type="text" id="form-base-id" placeholder="1BbcDef... (ID de tu formulario base)">
		                        <small style="color: #7f8c8d;">Este formulario se duplicará para cada entreno</small>
		                    </div>
		                    
		                    <div class="form-group">
		                        <label>📊 ID Google Sheets:</label>
		                        <input type="text" id="sheet-id" placeholder="1AbcDef... (ID de tu hoja de cálculo)">
		                        <small style="color: #7f8c8d;">Donde se guardarán las respuestas y configuración</small>
		                    </div>
		                    
		                    <div class="form-group">
		                        <label>📧 Entry ID Campo Email:</label>
		                        <input type="text" id="email-entry" placeholder="entry.123456789">
		                        <small style="color: #7f8c8d;">Para pre-rellenar el email de la jugadora</small>
		                    </div>
		                </div>
		            </div>
		
		            <!-- ESTADÍSTICAS TAB -->
		            <div id="stats-tab" class="tab-panel">
						<!-- 1. Estadísticas Generales del Equipo -->
					    <div class="stats-grid" id="team-stats-summary">
					        <!-- Los datos se cargarán aquí desde el backend -->
					        <div class="card">
					            <div class="stat-value" id="stat-avg-attendance">- %</div>
					            <div class="stat-label">Asistencia Media</div>
					        </div>
					        <div class="card">
					            <div class="stat-value" id="stat-total-trainings">-</div>
					            <div class="stat-label">Entrenamientos Planificados</div>
					        </div>
					        <div class="card">
					            <div class="stat-value" id="stat-upcoming-trainings">-</div>
					            <div class="stat-label">Próximos Entrenamientos</div>
					        </div>
					        <div class="card">
					            <div class="stat-value" id="stat-total-players">-</div>
					            <div class="stat-label">Jugadoras en el Equipo</div>
					        </div>
					    </div>
					
					    <hr style="margin: 2rem 0;">
					
					    <!-- 2. Estadísticas por Jugadora -->
					    <div id="player-stats-section">
					        <h3 style="margin-bottom: 1rem;">Análisis por Jugadora</h3>
					        
					        <div class="form-group" style="max-width: 400px;">
					            <label for="player-selector">Selecciona una jugadora:</label>
					            <select id="player-selector" class="btn" style="width: 100%; justify-content: start;" onchange="onPlayerSelected()">
					                <option value="">-- Cargar jugadoras --</option>
					            </select>
					        </div>
					
					        <div class="stats-grid" id="individual-player-stats" style="display: none; margin-top: 1.5rem;">
					            <!-- Aquí se mostrarán las estadísticas de la jugadora seleccionada -->
					        </div>
					    </div>								                
		                <div class="training-list">
		                    <h3 style="padding: 1rem; background: #f8f9fa; margin: 0;">📅 Próximos Entrenamientos</h3>
		                    <div id="upcoming-trainings">
		                        <!-- Se genera con JavaScript -->
		                    </div>
		                </div>
						
		            </div>
		        </div>
			</div>
	    </div>
    </div>

    <!-- INDICADOR DE AUTO-REFRESH -->
    <div id="refreshIndicator" class="refresh-indicator hidden">
        🔄
    </div>

    <script>
        // ========================
        // CONFIGURACIÓN Y GLOBALES
        // ========================
        const CONFIG = {
            CLIENT_ID: '231457973375-lu8n54s56es213oqg5r3c5huas7golbb.apps.googleusercontent.com',
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbxTQZTe9yJvZS0pK-ptjCQTpIbs3iFOjSuQ2mbDn02R5VaUs7aVsb4DAEHHJuQtwHMqGA/exec',
            SCOPES: 'email profile',
            AUTO_REFRESH_INTERVAL: 300000,
        };

        const FRASES_MOTIVACIONALES = [
            { title: "⚽ ¡A por Todas!", text: "El talento depende de la inspiración, pero el esfuerzo depende de cada una." },
            { title: "🔥 Espíritu de Equipo", text: "Juegas para el nombre en el frente de la camiseta, y se acordarán del nombre en la espalda." },
            { title: "🎯 Precisión y Pasión", text: "Cada entrenamiento es una oportunidad para ser mejor que ayer. ¡No la desperdicies!" },
            { title: "🌟 Brilla en el Campo", text: "No sueñes con el éxito. Entrena para conseguirlo. ¡Vamos!" },
            { title: "🏆 Mentalidad Ganadora", text: "Las campeonas no se hacen en los partidos, se hacen en los entrenamientos diarios." },
        ];

        let currentUser = null;
        let refreshInterval = null;
        let currentDate = new Date();
        let selectedDate = null;
        let trainings = {};
		let currentCalendarView = 'week'; // 'week' es ahora la vista por defecto

        function toYYYYMMDD(date) {
            const anio = date.getFullYear();
            const mes = String(date.getMonth() + 1).padStart(2, '0');
            const dia = String(date.getDate()).padStart(2, '0');
            return `${anio}-${mes}-${dia}`;
        }

        // ========================
        // INICIALIZACIÓN
        // ========================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            document.getElementById('signInButton').addEventListener('click', signIn);
            //document.getElementById('logoutButton').addEventListener('click', signOut); // Solo hay un logout button ahora
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: CONFIG.CLIENT_ID,
                    callback: handleCredentialResponse
                });
            }
            checkExistingSession();
        }

        // ========================
        // AUTENTICACIÓN
        // ========================
        function signIn() {
            document.getElementById('loginLoading').style.display = 'block';
            document.getElementById('signInButton').style.display = 'none';
            google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: handleTokenResponse,
            }).requestAccessToken();
        }

        function handleTokenResponse(response) {
            if (response.access_token) {
                fetchUserInfo(response.access_token);
            } else {
                showError('Error al obtener token de acceso');
                resetLoginScreen();
            }
        }

        function handleCredentialResponse(response) {
            const userInfo = parseJwt(response.credential);
            loginUser(userInfo);
        }

        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                if (response.ok) {
                    const userInfo = await response.json();
                    await loginUser(userInfo);
                } else {
                    throw new Error('Error al obtener información del usuario');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al obtener información del usuario');
                resetLoginScreen();
            }
        }

        async function loginUser(userInfo) {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=checkAccess&email=${encodeURIComponent(userInfo.email)}&app=player`);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`El servidor respondió con un error ${response.status}: ${errorText}`);
                }
                const accessData = await response.json();
                if (accessData.status === 'granted') {
                    currentUser = { ...userInfo, role: accessData.role, teams: accessData.teams, teamMap: accessData.teamMap };
                    sessionStorage.setItem('proassist_user', JSON.stringify(currentUser));
                    updateGreeting();
                    await showDashboardBasedOnRole(accessData.role);
                    startAutoRefresh();
                } else {
                    throw new Error(`Acceso denegado por el servidor: ${accessData.reason}`);
                }
            } catch (error) {
                console.error('--- ERROR DE AUTORIZACIÓN DETALLADO ---', error);
                showError('No se pudo verificar tus permisos. Revisa la consola para más detalles.');
                resetLoginScreen();
            }
        }

        async function checkExistingSession() {
            const savedUser = sessionStorage.getItem('proassist_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateGreeting();
                await showDashboardBasedOnRole(currentUser.role);
                startAutoRefresh();
            }
        }

        function signOut() {
            currentUser = null;
            sessionStorage.removeItem('proassist_user');
            stopAutoRefresh();
            showLoginScreen();
        }

        // ========================
        // ROUTER Y NAVEGACIÓN
        // ========================
        async function showDashboardBasedOnRole(role) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('player-dashboard').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            const configTabButton = document.getElementById('config-tab-button');

            if (role === 'ADMIN' || role === 'COACH') {
                document.getElementById('admin-panel').style.display = 'block';

				// --- LÓGICA PARA EL BADGE DE ROL ---
			    const roleBadge = document.getElementById('role-badge');
			    roleBadge.textContent = role; // Pone "ADMIN" o "COACH"
			    if (role === 'COACH') {
			        roleBadge.style.backgroundColor = '#3498db'; // Color azul para COACH
			    } else {
			        roleBadge.style.backgroundColor = '#e74c3c'; // Color rojo para ADMIN
			    }
								
                if (role === 'COACH') {
                    configTabButton.style.display = 'none';
                    document.querySelector('.tab[onclick="showTab(\'calendar\')"]').click();
                } else {
                    configTabButton.style.display = 'flex';
                }
                
                const teamSelectorHeader = document.getElementById('team-selector-header');
                const teamSelector = document.getElementById('team-selector');
                teamSelector.innerHTML = '';

                if (currentUser.teams && currentUser.teams.length > 1) {
                    teamSelectorHeader.style.display = 'flex';
                    currentUser.teams.forEach(teamId => {
                        const option = document.createElement('option');
                        option.value = teamId;
                        option.textContent = currentUser.teamMap[teamId] || teamId;
                        teamSelector.appendChild(option);
                    });
                    teamSelector.onchange = () => initializeAdminPanel(teamSelector.value);
                    await initializeAdminPanel(currentUser.teams[0]);
                } else if (currentUser.teams && currentUser.teams.length === 1) {
                    teamSelectorHeader.style.display = 'none';
                    await initializeAdminPanel(currentUser.teams[0]);
                } else {
                    showAlert('No tienes equipos asignados.', 'warning');
                }
            } else if (role === 'PLAYER') {                
				document.getElementById('player-dashboard').style.display = 'block';
			    showMotivationalMessage();
			    
			    // --- LLAMADA CORRECTA ---
			    // Obtenemos el teamId y llamamos a nuestra nueva función maestra
			    const playerTeamId = currentUser.teams[0];
			    if (playerTeamId) {
			        await loadPlayerFormState(playerTeamId);
					await loadUserStats(playerTeamId);
        			await loadUserHistory(playerTeamId);
			    } else {
			        showError("No estás asignada a ningún equipo.");
			    }
            }
        }

        function showLoginScreen() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('player-dashboard').style.display = 'none';
            document.getElementById('admin-panel').style.display = 'none';
            resetLoginScreen();
        }

        function resetLoginScreen() {
            document.getElementById('loginLoading').style.display = 'none';
            document.getElementById('signInButton').style.display = 'flex';
        }

        // ========================
        // LÓGICA DASHBOARD JUGADORA
        // ========================
        function updateGreeting() {
            if (!currentUser) return;
            const now = new Date();
            const hour = now.getHours();
            let greeting = (hour < 12) ? '🌅 Buenos días' : (hour < 18) ? '☀️ Buenas tardes' : '🌙 Buenas noches';
            const firstName = currentUser.name ? currentUser.name.split(' ')[0] : 'Jugadora';
            document.getElementById('greeting').textContent = `${greeting}, ${firstName}!`;
        }

		async function loadUserData() {
		    if (!currentUser || !currentUser.email) {
		        return showError('No hay información de usuario disponible');
		    }
		    const playerTeamId = currentUser.teams[0];
		    if (!playerTeamId) {
		        return showError("No estás asignada a ningún equipo.");
		    }
		
		    try {
		        console.log("Cargando estadísticas de jugadora...");
		        await loadUserStats(playerTeamId);
		        
		        console.log("Cargando historial de jugadora...");
		        await loadUserHistory(playerTeamId);
		        
		        console.log("Cargando formulario del día...");
		        //await loadTodaysForm(playerTeamId);
				await loadPlayerFormState(playerTeamId)
		
		    } catch (error) {
		        console.error('Error CATASTRÓFICO cargando datos de la jugadora:', error);
		        showError('Error al cargar los datos del usuario. Revisa la consola.');
		    }
		}
        
        async function loadUserStats(teamId) {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserStats&email=${currentUser.email}&teamId=${teamId}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                const data = await response.json();
                if (data.success) {
                    updateStatsUI(data.stats);
                } else {
                    showDefaultStats();
                }
            } catch (error) {
                console.error('Error cargando estadísticas:', error);
                showDefaultStats();
            }
        }

		function updateStatsUI(stats) {
		    const attendance = stats.attendanceRate || 0;
		    safeSetText('totalTrainings', stats.totalTrainings || 0);
		    safeSetText('attendanceRate', `${attendance}%`);
		    safeSetWidth('attendanceProgress', `${attendance}%`);
		    safeSetText('monthlyProgress', `${stats.monthlyTrainings || 0}/${stats.monthlyGoal || 0}`);
		    safeSetWidth('monthlyProgressBar', `${(stats.monthlyTrainings / (stats.monthlyGoal || 1)) * 100}%`);
		    
		    // Widget de Comparación (ahora también es seguro)
		    safeSetText('myAttendanceRate', `${attendance}%`);
		    safeSetWidth('myAttendanceProgress', `${attendance}%`);
		}
		
		function showDefaultStats() {
		    safeSetText('totalTrainings', '0');
		    safeSetText('attendanceRate', '0%');
		    safeSetWidth('attendanceProgress', '0%');
		    safeSetText('monthlyProgress', '0/0');
		    safeSetWidth('monthlyProgressBar', '0%');
		
		    safeSetText('myAttendanceRate', '0%');
		    safeSetWidth('myAttendanceProgress', '0%');
		}
		
        async function loadUserHistory(teamId) {
			try {
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserHistory&email=${currentUser.email}&teamId=${teamId}`);
		        if (!response.ok) throw new Error(`HTTP ${response.status}`);
		        
		        const data = await response.json();
		        if (data.success) {
		            updateHistoryUI(data.history); // Llamamos a la función que dibuja el historial
		        } else {
		            showHistoryError();
		        }
		    } catch (error) {
		        console.error('Error cargando historial:', error);
		        showHistoryError();
		    }            
        }

		/**
		 * Dibuja la lista del historial reciente en el dashboard de la jugadora.
		 * VERSIÓN FINAL Y COMPLETA.
		 * @param {Array} history Un array de objetos con el historial.
		 */
		function updateHistoryUI(history) {
		    const historyList = document.getElementById('historyList');
		    
		    if (!history || history.length === 0) {
		        historyList.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;"><p>Aún no tienes entrenamientos registrados.</p></div>`;
		        return;
		    }
		
		    historyList.innerHTML = history.map(item => {
		        let formattedDate = "Fecha inválida";
		        if (item.date) {
		            // El backend nos envía un objeto Date, lo formateamos directamente.
		            const date = new Date(item.date);
		            if (!isNaN(date.getTime())) { // Verificamos si la fecha es válida
		                formattedDate = date.toLocaleDateString('es-ES', {
		                    weekday: 'long',
		                    day: 'numeric',
		                    month: 'short'
		                });
		            }
		        }
		        
		        const statusClass = item.completed ? 'status-completed' : 'status-missed';
		        const statusText = item.completed ? 'Asistió' : 'No Asistió';
		        
		        return `
		            <div class="history-item">
		                <div class="history-date">${formattedDate}</div>
		                <div class="history-status ${statusClass}">
		                    ${statusText}
		                </div>
		            </div>
		        `;
		    }).join('');
		}
		
		/**
		 * Muestra un mensaje de error en el widget del historial.
		 */
		function showHistoryError() {
		    const historyList = document.getElementById('historyList');
		    historyList.innerHTML = `
		        <div style="text-align: center; padding: 20px; color: #666;">
		            <p>Error al cargar el historial.</p>
		            <button onclick="loadUserHistory(currentUser.teams[0])" class="btn btn-secondary" style="padding: 5px 10px; font-size: 0.8em;">Reintentar</button>
		        </div>
		    `;
		}

		/**
		 * Carga el estado de la jugadora y renderiza la VISTA DIARIA.
		 * @param {string} teamId El ID del equipo de la jugadora.
		 */
		async function loadPlayerFormState(teamId) {
		  const container = document.getElementById('player-day-view-container');
		  container.innerHTML = '<div class="spinner"></div><p style="text-align: center;">Cargando información del día...</p>';
		  
		  try {
		    const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getPlayerState&email=${currentUser.email}&teamId=${teamId}`);
		    const data = await response.json();
		
		    if (!data.success || !data.playerState.success) {
		      throw new Error(data.error || data.playerState.error);
		    }
		
		    const stateData = data.playerState;
		    const info = stateData.trainingInfo;
		    
		    let contentHtml = '';
		
		    if (info) {
		        // Si hay un próximo entreno, mostramos sus detalles
		        contentHtml += `
		            <div class="day-view-card" style="box-shadow: none; padding: 0;">
		                <h3>Próximo Entrenamiento: ${new Date(info.fecha + 'T12:00:00').toLocaleDateString('es-ES', {weekday: 'long', day: 'numeric', month: 'long'})}</h3>
		                <div class="details">
		                    <p class="detail-item"><strong>🕒 Horario:</strong> ${info.start} - ${info.end}</p>
		                    <p class="detail-item"><strong>📍 Ubicación:</strong> ${info.location || 'No especificada'}</p>
		                    <p class="detail-item"><strong>📝 Notas:</strong> ${info.notes || 'Sin notas'}</p>
		                    ${info.pdfId ? `<p class="detail-item"><strong>📄 Sesión:</strong> <a href="https://docs.google.com/document/d/${info.pdfId}/edit?usp=sharing" target="_blank">Ver PDF</a></p>` : ''}
		                </div>
		                <hr style="margin: 2rem 0;">
		            </div>`;
		    }
		
		    // Añadimos la sección del formulario basándonos en el estado
		    switch (stateData.state) {
		      case 'listo_para_responder':
		        contentHtml += `
		            <div style="text-align: center;">
		                <h3 style="margin-bottom: 10px;">¡Confirma tu asistencia!</h3>
		                <a href="${stateData.formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">📋 Abrir Formulario</a>
		            </div>`;
		        break;
		        
		      case 'ya_respondido':
		        contentHtml += `
		            <div style="text-align: center; background-color: #e8f5e8; border-radius: 15px; padding: 1.5rem;">
		                <h3 style="margin-bottom: 10px; color: #155724;">✅ ¡Gracias por responder!</h3>
		                <p style="color: #666;">Tu respuesta para el entreno de hoy ha sido registrada.</p>
		            </div>`;
		        break;
		
		      default:
		         contentHtml += `<div style="text-align: center; padding: 20px; color: #666;">🗓️<p style="margin-top:1rem;">${stateData.error || 'No hay formulario disponible para el próximo entreno.'}</p></div>`;
		    }
		    
		    container.innerHTML = contentHtml;
		
		  } catch (error) {
		    console.error('Error cargando el estado del formulario:', error);
		    container.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
		  }
		}

        async function loadTodaysForm(teamId) {
			try {
				const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getForm&email=${currentUser.email}&teamId=${teamId}`);
				const data = await response.json();
		
				// Si la llamada al backend fue exitosa PERO la lógica interna falló (ej. no hay entreno)
				if (!data.success) {
					// Lanzamos un error con el mensaje que nos da el backend
					throw new Error(data.error);
				}
				
				// Si todo fue bien, mostramos la UI del formulario
				showFormUI(data);
		
			} catch (error) {
				console.error('Error cargando formulario del día:', error.message);
				// El 'catch' ahora recibe el mensaje de error limpio y se lo pasa a la UI
				showNoTrainingUI(error.message);
			}
		}

		function showFormUI(formData) {
		    const container = document.getElementById('formContainer');
		    const title = document.getElementById('formTitle');
		    
		    let displayHtml = '';
		    
		    if (formData.formUrl && formData.trainingInfo) {
		        const info = formData.trainingInfo;
		        const parts = info.fecha.split('-');
		        const displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
		
		        title.innerHTML = `📝 Próximo Entreno: ${displayDate}`;
		        
		        // --- ¡LÓGICA CONDICIONAL AQUÍ! ---
		        if (formData.hasResponded) {
				    // Si la jugadora YA HA RESPONDIDO
				    displayHtml = `
				        <div style="text-align: center; padding: 30px; background-color: #e8f5e8; border-radius: 15px;">
				            <h3 style="margin-bottom: 10px; color: #155724;">✅ ¡Gracias por responder!</h3>
				            <p style="color: #666; margin-bottom: 25px;">
				                El formulario para el entreno del ${displayDate} ya se ha registrado. Para cualquier modificación, avisa a los entrenadores.
				            </p>
				            <!-- Opcional: Si quieres mantener el botón de modificar -->
				            <a href="${formData.formUrl}" target="_blank" class="btn btn-secondary">📝 Revisar mi Respuesta</a>
				        </div>
				    `;
		        } else {
		            // Si la jugadora AÚN NO HA RESPONDIDO
		            displayHtml = `
		                <div style="text-align: center; padding: 30px;">
		                    <h3 style="margin-bottom: 10px;">¡Listo para el entreno del ${displayDate}!</h3>
		                    <p style="color: #666; margin-bottom: 25px;">
		                        Por favor, completa el formulario de asistencia.
		                    </p>
		                    <a href="${formData.formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">
		                        📋 Abrir Formulario
		                    </a>
		                    <p style="font-size: 0.8rem; color: #888; margin-top: 15px;">(Se abrirá en una nueva pestaña)</p>
		                </div>
		            `;
		        }
		
		    } else {
		        title.innerHTML = `📝 Formulario del Día`;
		        displayHtml = `<div style="text-align: center; padding: 20px; color: #666;">No hay formulario disponible.</div>`;
		    }
		    
		    container.innerHTML = displayHtml;
		}		
        
        function showNoTrainingUI(message) {
		    const container = document.getElementById('formContainer');
		    // Usamos un icono de calendario en lugar del de dormir
		    container.innerHTML = `
		        <div style="text-align: center; padding: 20px; color: #666;">
		            <div style="font-size: 3rem; margin-bottom: 20px;">🗓️</div>
		            <p>${message}</p>
		        </div>
		    `;
		}

        function showFormError() {
            // Similar a showNoTrainingUI
            showNoTrainingUI('Error al cargar el formulario del día.');
        }

        function showMotivationalMessage() {
            const messageDiv = document.getElementById('motivationalMessage');
            const titleEl = document.getElementById('motivationalTitle');
            const textEl = document.getElementById('motivationalText');
            const randomIndex = Math.floor(Math.random() * FRASES_MOTIVACIONALES.length);
            const randomPhrase = FRASES_MOTIVACIONALES[randomIndex];
            titleEl.textContent = randomPhrase.title;
            textEl.textContent = randomPhrase.text;
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.transition = 'opacity 0.5s';
                messageDiv.style.opacity = '0';
                setTimeout(() => {
                    messageDiv.style.display = 'none';
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transition = '';
                }, 500);
            }, 120000);
        }

        // ========================
        // LÓGICA PANEL ADMIN/COACH
        // ========================
        async function initializeAdminPanel(teamId) {
            if (!teamId) {
                console.error("initializeAdminPanel fue llamado sin un teamId.");
                return;
            }
            console.log(`Inicializando panel para el equipo: ${teamId}...`);
            trainings = {};
            document.getElementById('calendar-month').textContent = 'Cargando datos...';
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTrainings&teamId=${teamId}`);
                const data = await response.json();
                if (data.success) {
                    trainings = data.trainings;
                    console.log('Entrenamientos cargados:', trainings);
                    renderCalendarView();
                    const activeTab = sessionStorage.getItem('proassist_active_tab') || 'calendar';
                    const tabButton = document.querySelector(`.tab[onclick="showTab('${activeTab}')"]`);
                    if (tabButton) tabButton.click();
                } else {
                    showAlert('Error al cargar entrenamientos: ' + data.error, 'warning');
                }
            } catch (error) {
                console.error('Error de conexión al cargar entrenamientos:', error);
                showAlert('Error de conexión. No se pudieron cargar los datos.', 'warning');
            }
            loadConfiguration();
        }		
        
        function showTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            const clickedTab = event.currentTarget;
            clickedTab.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            if (tabName === 'stats') {
                const selectedTeamId = document.getElementById('team-selector').value;
                loadAdminStats(selectedTeamId);
            }
            sessionStorage.setItem('proassist_active_tab', tabName);
        }

		/**
		 * Cambia la vista activa del calendario y lo vuelve a dibujar.
		 * @param {string} viewName El nombre de la vista ('month', 'week', 'day').
		 */
		function setView(viewName) {
		    currentCalendarView = viewName;
		    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
		    document.getElementById(viewName + '-view-btn').classList.add('active');
		    
		    // --- ¡AQUÍ ESTÁ LA MAGIA! ---
		    if (viewName === 'day') {
		        // Si cambiamos a la vista de día, auto-seleccionamos la fecha actual
		        selectDate(toYYYYMMDD(currentDate));
		    }
		    
		    renderCalendarView();
		}

		function previousPeriod() {
		    if (currentCalendarView === 'month') { /*...*/ } 
		    else if (currentCalendarView === 'week') { /*...*/ } 
		    else if (currentCalendarView === 'day') {
		        currentDate.setDate(currentDate.getDate() - 1);
		    }
		    renderCalendarView();
		    // --- ¡AQUÍ ESTÁ LA MAGIA! ---
		    // Después de redibujar, cargamos los datos del nuevo día seleccionado
		    selectDate(toYYYYMMDD(currentDate));
		}
		
		function nextPeriod() {
		    if (currentCalendarView === 'month') { /*...*/ }
		    else if (currentCalendarView === 'week') { /*...*/ }
		    else if (currentCalendarView === 'day') {
		        currentDate.setDate(currentDate.getDate() + 1);
		    }
		    renderCalendarView();
		    // --- ¡AQUÍ ESTÁ LA MAGIA! ---
		    selectDate(toYYYYMMDD(currentDate));
		}

		/**
		 * Función maestra que decide qué vista del calendario dibujar.
		 */
		function renderCalendarView() {
		    console.log(`Renderizando la vista: ${currentCalendarView}`);
		    
		    // Ocultamos todas las vistas posibles primero (por si añadimos más)
		    // document.getElementById('week-view-container').style.display = 'none';
		    // document.getElementById('day-view-container').style.display = 'none';
		    
		    // Mostramos la correcta
		    if (currentCalendarView === 'month') {
		        renderMonthView();
		    } else if (currentCalendarView === 'week') {
		        renderWeekView();
		    } else if (currentCalendarView === 'day') {
		        renderDayView();
		    }
		}
		
        function renderMonthView() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            document.getElementById('calendar-month').textContent = `${['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'][month]} ${year}`;
            const firstDay = new Date(year, month, 1);
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            let current = new Date(firstDay);
            current.setDate(current.getDate() - firstDay.getDay());
            for (let i = 0; i < 42; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = current.getDate();
                const dateString = toYYYYMMDD(current);
                dayElement.dataset.date = dateString;
                if (current.getMonth() !== month) dayElement.classList.add('other-month');
                if (trainings[dateString]) {
                    dayElement.classList.add('has-training');
                    const indicator = document.createElement('div');
                    indicator.className = 'training-indicator';
                    dayElement.appendChild(indicator);
                }
                dayElement.addEventListener('click', () => selectDate(dateString));
                grid.appendChild(dayElement);
                current.setDate(current.getDate() + 1);
            }
        }		
		
        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendarView();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendarView();
        }

        function selectDate(dateString) {
		    selectedDate = dateString;
		    currentDate = new Date(dateString + 'T12:00:00'); // Sincronizamos la fecha principal
		
		    // Si estamos en la vista de mes o semana, resaltamos el día
		    if (currentCalendarView === 'month' || currentCalendarView === 'week') {
		        document.querySelectorAll('.calendar-day.selected').forEach(day => day.classList.remove('selected'));
		        const dayElement = document.querySelector(`[data-date="${dateString}"]`);
		        if (dayElement) dayElement.classList.add('selected');
		    } else if (currentCalendarView === 'day') {
		        // Si estamos en la vista de día, simplemente la volvemos a dibujar
		        renderDayView();
		    }
		    
		    loadTrainingData(dateString);
		}

		/**
		 * Dibuja la vista semanal del calendario con franjas horarias.
		 */
		function renderWeekView() {
		    const grid = document.getElementById('calendar-grid');
		    grid.innerHTML = ''; // Limpiamos el grid
		    grid.style.display = 'grid'; // Aseguramos que sea un grid
		    grid.style.gridTemplateColumns = 'repeat(7, 1fr)'; // 7 columnas iguales
		
		    const hoy = new Date();
		    const diaDeLaSemana = currentDate.getDay(); // 0 (Dom) a 6 (Sáb)
		    const inicioDeLaSemana = new Date(currentDate);
		    inicioDeLaSemana.setDate(currentDate.getDate() - diaDeLaSemana); // Llevamos la fecha al domingo
		
		    // Actualizamos el título del header para mostrar el rango de la semana
		    const finDeLaSemana = new Date(inicioDeLaSemana);
		    finDeLaSemana.setDate(inicioDeLaSemana.getDate() + 6);
		    const opcionesTitulo = { month: 'long', day: 'numeric' };
		    document.getElementById('calendar-month').textContent = 
		        `${inicioDeLaSemana.toLocaleDateString('es-ES', opcionesTitulo)} - ${finDeLaSemana.toLocaleDateString('es-ES', opcionesTitulo)}`;
		
		    // --- Dibujamos los encabezados de los días ---
		    const dayHeaders = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
		    for (let i = 0; i < 7; i++) {
		        const currentDay = new Date(inicioDeLaSemana);
		        currentDay.setDate(inicioDeLaSemana.getDate() + i);
		        
		        const header = document.createElement('div');
		        header.className = 'calendar-day-header';
		        // Mostramos el nombre del día y el número
		        header.innerHTML = `${dayHeaders[i]} <br> <span style="font-size: 1.2em; font-weight: normal;">${currentDay.getDate()}</span>`;
		        
		        // Resaltamos el día de hoy
		        if (toYYYYMMDD(currentDay) === toYYYYMMDD(hoy)) {
		            header.style.backgroundColor = '#2980b9';
		        }
		        grid.appendChild(header);
		    }
		
		    // --- Dibujamos las casillas para los entrenamientos ---
		    for (let i = 0; i < 7; i++) {
		        const currentDay = new Date(inicioDeLaSemana);
		        currentDay.setDate(inicioDeLaSemana.getDate() + i);
		        const dateString = toYYYYMMDD(currentDay);
		        
		        const dayCell = document.createElement('div');
		        dayCell.className = 'calendar-day';
		        dayCell.style.minHeight = '200px'; // Damos más altura para ver los detalles
		        dayCell.dataset.date = dateString;
		        dayCell.addEventListener('click', () => selectDate(dateString));
		
		        // Buscamos si hay un entrenamiento para este día
		        if (trainings[dateString]) {
		            const training = trainings[dateString];
		            dayCell.classList.add('has-training');
		            dayCell.innerHTML = `
		                <div style="font-weight: bold; margin-bottom: 5px;">${training.start} - ${training.end}</div>
		                <div style="font-size: 0.9em; color: #333;">${training.notes || 'Entrenamiento'}</div>
		                ${training.location ? `<div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">📍 ${training.location}</div>` : ''}
		            `;
		        }
		        
		        grid.appendChild(dayCell);
		    }
		}

		/**
		 * Dibuja la vista diaria del calendario, mostrando detalles del entreno del día actual.
		 */
		function renderDayView() {
		    const grid = document.getElementById('calendar-grid');
		    grid.innerHTML = ''; // Limpiamos el grid
		    // Hacemos que la rejilla se comporte como un bloque normal para esta vista
		    grid.style.display = 'block'; 
		
		    // Actualizamos el título del header para mostrar la fecha completa
		    const opcionesTitulo = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
		    document.getElementById('calendar-month').textContent = currentDate.toLocaleDateString('es-ES', opcionesTitulo);
		
		    const dateString = toYYYYMMDD(currentDate);
		    const training = trainings[dateString];
		
		    let contentHtml = '';
		
		    if (training) {
		        // Si SÍ hay entrenamiento para este día
		        contentHtml = `
		            <div class="day-view-card">
		                <h3>Detalles del Entrenamiento</h3>
		                <div class="details">
		                    <p class="detail-item">
		                        <strong>🕒 Horario:</strong> ${training.start} - ${training.end}
		                    </p>
		                    <p class="detail-item">
		                        <strong>📍 Ubicación:</strong> ${training.location || 'No especificada'}
		                    </p>
		                    <p class="detail-item">
		                        <strong>📝 Notas:</strong> ${training.notes || 'Sin notas'}
		                    </p>
		                    ${training.pdfId ? `
		                    <p class="detail-item">
		                        <strong>📄 Sesión:</strong> <a href="https://docs.google.com/document/d/${training.pdfId}/edit?usp=sharing" target="_blank">Ver PDF</a>
		                    </p>
		                    ` : ''}
		                </div>
		            </div>
		        `;
		    } else {
		        // Si NO hay entrenamiento para este día
		        contentHtml = `
		            <div class="day-view-card">
		                <div style="font-size: 3rem; margin-bottom: 1rem;">😴</div>
		                <h3>Día de Descanso</h3>
		                <p>No hay ningún entrenamiento programado para hoy.</p>
		            </div>
		        `;
		    }
		
		    // Usamos un contenedor para que los estilos se apliquen bien
		    grid.innerHTML = `<div class="day-view-container">${contentHtml}</div>`;
		}

		/**
		 * Carga los datos de un entrenamiento seleccionado en el formulario del sidebar,
		 * gestionando la visibilidad y el estado de los campos y botones.
		 * @param {string} dateString La fecha seleccionada en formato 'YYYY-MM-DD'.
		 */
		function loadTrainingData(dateString) {
		    // --- 1. REFERENCIAS A ELEMENTOS HTML ---
		    const trainingForm = document.getElementById('training-details-form');
		    const buttonContainer = document.getElementById('action-buttons-container');
		    const pdfStatusContainer = document.getElementById('pdf-status-container');
		    const formInputs = document.querySelectorAll('#training-details-form input, #training-details-form textarea');
		
		    // --- 2. CÁLCULO DE ESTADOS ---
		    const today = toYYYYMMDD(new Date());
		    const isPastDate = dateString && dateString < today;
		    const hasTraining = dateString && trainings[dateString];
		    const training = trainings[dateString] || {};
		
		    // --- 3. LÓGICA DE VISIBILIDAD Y HABILITACIÓN ---
		    trainingForm.style.display = 'block'; // Mostramos el formulario por defecto
		    buttonContainer.style.display = 'block'; // Mostramos los botones por defecto
		    formInputs.forEach(input => input.disabled = false); // Habilitamos los inputs por defecto
		
		    if (isPastDate && !hasTraining) {
		        trainingForm.style.display = 'none';
		        showAlert('Fecha pasada sin entrenamiento registrado.', 'warning');
		    } else if (isPastDate && hasTraining) {
		        buttonContainer.style.display = 'none';
		        formInputs.forEach(input => input.disabled = true);
		        showAlert('Estás viendo un entrenamiento pasado. La edición está deshabilitada.', 'warning');
		    }
		
		    // --- 4. RELLENAR LOS DATOS DEL FORMULARIO ---
		    let displayDate = 'dd/mm/aaaa';
		    if (dateString) {
		        const parts = dateString.split('-');
		        displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
		    }
		    document.getElementById('selected-date').value = displayDate;
		    document.getElementById('start-time').value = training.start || '20:45';
		    document.getElementById('end-time').value = training.end || '22:30';
		    document.getElementById('location').value = training.location || '';
		    document.getElementById('notes').value = training.notes || '';
		    
			if (training.pdfId) {
			    pdfStatusContainer.innerHTML = `<a href="https://drive.google.com/file/d/${training.pdfId}/view" target="_blank" class="btn btn-secondary" style="width: 100%;">📄 Ver Sesión Adjunta</a>`;
			} else {
			    pdfStatusContainer.innerHTML = `<p style="color: #7f8c8d; text-align: center; font-size: 0.9em;">No hay ninguna sesión adjunta.</p>`;
			}
		}

		async function saveTraining() {
		    console.log("--- saveTraining: INICIO ---");
		    
		    if (!selectedDate) {
		        console.log("saveTraining: ERROR - No hay selectedDate.");
		        return showAlert('Por favor, selecciona una fecha.', 'warning');
		    }
		    
		    const selectedTeamId = document.getElementById('team-selector').value;
		    if (!selectedTeamId) {
		        console.log("saveTraining: ERROR - No hay selectedTeamId.");
		        return showAlert('No se ha seleccionado ningún equipo.', 'warning');
		    }
		    
		    const pdfLink = document.getElementById('pdf-link').value;
		    let pdfId = '';
		    if (pdfLink.includes('/d/')) {
		        const match = pdfLink.match(/\/d\/(.+?)\//);
		        if (match && match[1]) { pdfId = match[1]; }
		    } else if (pdfLink.length > 30) {
		         pdfId = pdfLink;
		    }
		    console.log(`saveTraining: PDF ID extraído -> "${pdfId}"`);
		
		    const trainingDetails = {
		        fecha: selectedDate,
		        start: document.getElementById('start-time').value,
		        end: document.getElementById('end-time').value,
		        location: document.getElementById('location').value,
		        notes: document.getElementById('notes').value,
		        pdfId: selectedFileId || (trainings[selectedDate] ? trainings[selectedDate].pdfId : '')
		    };
		    console.log("saveTraining: Detalles del entreno a guardar ->", trainingDetails);
		
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'saveTraining');
		        url.searchParams.append('userEmail', currentUser.email);
		        url.searchParams.append('teamId', selectedTeamId);
		        Object.keys(trainingDetails).forEach(key => url.searchParams.append(key, trainingDetails[key]));
		        
		        console.log("saveTraining: URL construida ->", url.toString());
		
		        const response = await fetch(url);
		        console.log("saveTraining: Respuesta recibida del fetch ->", response);
		
		        if (!response.ok) {
		            const errorText = await response.text();
		            console.error("saveTraining: La respuesta del servidor no fue OK.", errorText);
		            throw new Error(`Error del servidor: ${response.status}`);
		        }
		
		        const data = await response.json();
		        console.log("saveTraining: Datos JSON parseados ->", data);
		
		        if (data.success && data.result && data.result.success) {
		            console.log("saveTraining: El guardado fue exitoso. Actualizando UI.");
		            trainings[selectedDate] = trainingDetails;
		            loadTrainingData(selectedDate); 
		            renderCalendar();
		            showAlert(data.result.message, 'success');
		        } else {
		            const errorMessage = data.error || data.result?.error || "Error desconocido en la respuesta.";
		            console.error("saveTraining: El backend devolvió un error ->", errorMessage);
		            showAlert('Error al guardar: ' + errorMessage, 'warning');
		        }
		    } catch (error) {
		        console.error('--- saveTraining: ERROR CATASTRÓFICO EN CATCH ---');
		        console.error(error);
		        showAlert('Error de conexión. No se pudo guardar el entrenamiento.', 'warning');
		    }
		}        

        async function deleteTraining() {
            if (!selectedDate || !trainings[selectedDate]) return showAlert('No hay un entrenamiento seleccionado para eliminar.', 'warning');
            const selectedTeamId = document.getElementById('team-selector').value;
            if (confirm(`¿Estás seguro de que quieres eliminar el entrenamiento del ${selectedDate} para el equipo ${selectedTeamId}?`)) {
                try {
                    const url = new URL(CONFIG.SCRIPT_URL);
                    url.searchParams.append('action', 'deleteTraining');
                    url.searchParams.append('userEmail', currentUser.email);
                    url.searchParams.append('fecha', selectedDate);
                    url.searchParams.append('teamId', selectedTeamId);
                    const response = await fetch(url);
                    const data = await response.json();
                    if (data.success && data.result && data.result.success) {
                        delete trainings[selectedDate];
                        loadTrainingData('');
                        renderCalendarView();
                        showAlert(data.result.message, 'success');
                    } else {
                        const errorMessage = data.error || data.result?.error || "Error desconocido.";
                        showAlert('Error al eliminar: ' + errorMessage, 'warning');
                    }
                } catch (error) {
                    console.error('Error de conexión al eliminar:', error);
                    showAlert('Error de conexión. No se pudo eliminar el entrenamiento.', 'warning');
                }
            }
        }

        async function prepareForm() {
            if (!selectedDate || !trainings[selectedDate]) return showAlert('Primero debes seleccionar y guardar un entrenamiento.', 'warning');
            const trainingDetails = trainings[selectedDate];
            const selectedTeamId = document.getElementById('team-selector').value;
            const prepareButton = event.currentTarget;
            prepareButton.disabled = true;
            prepareButton.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; border-width: 2px;"></div> Preparando...';
            try {
                const url = new URL(CONFIG.SCRIPT_URL);
                url.searchParams.append('action', 'prepareForm');
                url.searchParams.append('userEmail', currentUser.email);
                url.searchParams.append('teamId', selectedTeamId);
                url.searchParams.append('details', JSON.stringify(trainingDetails));
                const response = await fetch(url);
                const data = await response.json();
                if (data.success && data.result.success) {
                    showAlert(data.result.message, 'success');
                } else {
                    const errorMessage = data.error || data.result?.error || "Error desconocido.";
                    showAlert('Error al preparar el formulario: ' + errorMessage, 'warning');
                }
            } catch (error) {
                console.error('Error de conexión al preparar formulario:', error);
                showAlert('Error de conexión. No se pudo preparar el formulario.', 'warning');
            } finally {
                prepareButton.disabled = false;
                prepareButton.innerHTML = '📋 Preparar Formulario de Asistencia';
            }
        }

        async function loadAdminStats(teamId) {
            if (!teamId) return;
            document.getElementById('stat-avg-attendance').textContent = '...';
            document.getElementById('stat-total-trainings').textContent = '...';
            document.getElementById('stat-upcoming-trainings').textContent = '...';
            document.getElementById('stat-total-players').textContent = '...';
            document.getElementById('player-selector').innerHTML = '<option>Cargando...</option>';
            try {
                let response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTeamStats&teamId=${teamId}&userEmail=${currentUser.email}`);
                let data = await response.json();
                if (data.success) {
                    document.getElementById('stat-avg-attendance').textContent = `${data.stats.avgAttendance}%`;
                    document.getElementById('stat-total-trainings').textContent = data.stats.totalTrainings;
                    document.getElementById('stat-upcoming-trainings').textContent = data.stats.upcomingTrainings;
                    document.getElementById('stat-total-players').textContent = data.stats.totalPlayers;
                }
                response = await fetch(`${CONFIG.SCRIPT_URL}?action=getPlayersByTeam&teamId=${teamId}&userEmail=${currentUser.email}`);
                data = await response.json();
                if (data.success) {
                    const playerSelector = document.getElementById('player-selector');
                    playerSelector.innerHTML = '<option value="">-- Selecciona una jugadora --</option>';
                    data.players.forEach(player => {
                        const option = document.createElement('option');
                        option.value = player.email;
                        option.textContent = player.name;
                        playerSelector.appendChild(option);
                    });
                }
            } catch (error) {
                console.error("Error al cargar estadísticas del admin:", error);
                showAlert('No se pudieron cargar las estadísticas del equipo.', 'warning');
            }
        }

        async function onPlayerSelected() {
            const playerSelector = document.getElementById('player-selector');
            const selectedEmail = playerSelector.value;
            const statsContainer = document.getElementById('individual-player-stats');
            if (!selectedEmail) {
                statsContainer.style.display = 'none';
                return;
            }
            statsContainer.style.display = 'grid';
            statsContainer.innerHTML = '<div class="card"><div class="spinner"></div><p>Cargando estadísticas...</p></div>';
            const selectedTeamId = document.getElementById('team-selector').value;
            try {
                const url = new URL(CONFIG.SCRIPT_URL);
                url.searchParams.append('action', 'getPlayerStats');
                url.searchParams.append('userEmail', currentUser.email);
                url.searchParams.append('playerEmail', selectedEmail);
                url.searchParams.append('teamId', selectedTeamId);
                const response = await fetch(url);
                const data = await response.json();
                if (data.success) {
                    const stats = data.stats;
                    statsContainer.innerHTML = `
                        <div class="card"><div class="stat-value">${stats.attendanceRate}%</div><div class="stat-label">Tasa de Asistencia</div></div>
                        <div class="card"><div class="stat-value">${stats.attendedCount} / ${stats.totalResponses}</div><div class="stat-label">Respuestas Afirmativas</div></div>
                        <div class="card"><div class="stat-value">${stats.lastResponse}</div><div class="stat-label">Última Respuesta</div></div>
                    `;
                } else {
                    statsContainer.innerHTML = `<div class="alert alert-warning">No se pudieron cargar las estadísticas.</div>`;
                }
            } catch (error) {
                console.error("Error al cargar stats de jugadora:", error);
                statsContainer.innerHTML = `<div class="alert alert-warning">Error de conexión.</div>`;
            }
        }
        
        // ========================
        // OTRAS FUNCIONES Y LISTENERS
        // ========================
        function loadConfiguration() {
            const savedConfig = localStorage.getItem('proassist-config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('form-base-id').value = config.formBaseId || '';
                document.getElementById('sheet-id').value = config.sheetId || '';
                document.getElementById('email-entry').value = config.emailEntry || '';
            }
        }

        function guardarConfiguracion() {
            const config = {
                formBaseId: document.getElementById('form-base-id').value,
                sheetId: document.getElementById('sheet-id').value,
                emailEntry: document.getElementById('email-entry').value
            };
            localStorage.setItem('proassist-config', JSON.stringify(config));
            showAlert('💾 Configuración guardada localmente', 'success');
        }

		function startAutoRefresh() {
		    stopAutoRefresh();
		    refreshInterval = setInterval(async () => {
		        showRefreshIndicator();
		        
		        // --- ¡AQUÍ ESTÁ LA LÓGICA CONTEXTUAL! ---
		        // Comprobamos qué dashboard está visible actualmente
		        //if (document.getElementById('player-dashboard').style.display === 'block') {
		        //    console.log("Auto-refresh: Refrescando datos de la jugadora...");
		        //    await loadUserData();
		        //} 
				if (document.getElementById('player-dashboard').style.display === 'block') {
				    const playerTeamId = currentUser.teams[0];
				    if (playerTeamId) {
				        await loadPlayerFormState(playerTeamId); // <-- Llamada corregida
				    }
				}
				else if (document.getElementById('admin-panel').style.display === 'block') {
		            // En el futuro, podríamos refrescar los datos del admin también
		            console.log("Auto-refresh: Panel de admin activo, no se hace nada por ahora.");
		            // const selectedTeamId = document.getElementById('team-selector').value;
		            // await initializeAdminPanel(selectedTeamId); // <-- Esto lo activaremos si lo necesitamos
		        }
		
		    }, CONFIG.AUTO_REFRESH_INTERVAL);
		}
        
        function stopAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.remove('hidden');
            setTimeout(() => indicator.classList.add('hidden'), 2000);
        }

        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
                return JSON.parse(jsonPayload);
            } catch (e) { return null; }
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `position:fixed;top:20px;left:50%;transform:translateX(-50%);background:#ff4757;color:white;padding:15px 25px;border-radius:10px;box-shadow:0 5px 20px rgba(0,0,0,0.2);z-index:10000;font-weight:bold;max-width:400px;text-align:center;`;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

		function showAlert(message, type) {
		    const alert = document.createElement('div');
		    // Usamos una clase genérica para posicionamiento
		    alert.className = `alert-popup alert-${type}`;
		    alert.textContent = message;
		    document.body.appendChild(alert);
		    setTimeout(() => alert.remove(), 4000); // Duración un poco más corta
		}

		document.addEventListener('visibilitychange', async function() {
		    // Solo actúa si la pestaña se vuelve visible Y hay un usuario logueado
		    if (document.hidden === false && currentUser) {
		        
		        // --- ¡AQUÍ ESTÁ LA LÓGICA CONTEXTUAL! ---
		        //if (document.getElementById('player-dashboard').style.display === 'block') {
		        //    console.log("Pestaña visible: Refrescando datos de la jugadora...");
		        //    await loadUserData();
		        //} 
				if (document.getElementById('player-dashboard').style.display === 'block') {
				    const playerTeamId = currentUser.teams[0];
				    if (playerTeamId) {
				        await loadPlayerFormState(playerTeamId); // <-- Llamada corregida
				    }
				}
				else if (document.getElementById('admin-panel').style.display === 'block') {
		            console.log("Pestaña visible: Panel de admin activo, refrescando datos del equipo...");
		            const selectedTeamId = document.getElementById('team-selector').value;
		            if (selectedTeamId) {
		                await initializeAdminPanel(selectedTeamId);
		            }
		        }
		    }
		});  

		/**
		 * Asigna texto a un elemento de forma segura. Si el elemento no existe, no hace nada.
		 * @param {string} id El ID del elemento.
		 * @param {string} text El texto a asignar.
		 */
		function safeSetText(id, text) {
		    const element = document.getElementById(id);
		    if (element) {
		        element.textContent = text;
		    }
		}
		
		/**
		 * Asigna el ancho a un elemento de forma segura.
		 * @param {string} id El ID del elemento.
		 * @param {string} width El ancho en porcentaje (ej: '50%').
		 */
		function safeSetWidth(id, width) {
		    const element = document.getElementById(id);
		    if (element) {
		        element.style.width = width;
		    }
		}

		let selectedFileId = null; // Variable global temporal para guardar el ID seleccionado

		async function openFilePicker() {
		    const modal = document.getElementById('file-picker-modal');
		    const fileListDiv = document.getElementById('file-picker-list');
		    modal.style.display = 'flex';
		    fileListDiv.innerHTML = '<div class="spinner"></div><p>Cargando archivos...</p>';
		
		    try {
		        // 1. Obtener el ID de la carpeta del equipo desde la hoja Equipos
		        const selectedTeamId = document.getElementById('team-selector').value;
		        const teamFolderId = await getTeamFolderId(selectedTeamId); // Necesitamos esta nueva función en el backend
		
		        // 2. Pedir al backend la lista de archivos de esa carpeta
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=listFilesByFolderId&folderId=${teamFolderId}`);
		        const data = await response.json();
		
		        if (data.filesData.success) {
		            fileListDiv.innerHTML = '';
		            data.filesData.files.forEach(file => {
		                const fileButton = document.createElement('button');
		                fileButton.className = 'file-item';
		                fileButton.textContent = file.name;
		                fileButton.onclick = () => selectFile(file.id, file.name);
		                fileListDiv.appendChild(fileButton);
		            });
		        } else {
		            throw new Error(data.filesData.error);
		        }
		    } catch (error) {
		        fileListDiv.innerHTML = `<div class="alert alert-warning">${error.message}</div>`;
		    }
		}
		
		function selectFile(fileId, fileName) {
		    selectedFileId = fileId; // Guardamos el ID
		    // Actualizamos la UI del sidebar
		    document.getElementById('pdf-status-container').innerHTML = `
		        <div class="alert alert-success">Seleccionado: <strong>${fileName}</strong></div>
		    `;
		    closeFilePicker();
		}
		
		function closeFilePicker() {
		    document.getElementById('file-picker-modal').style.display = 'none';
		}

		/**
		 * Pide al backend el ID de la carpeta de sesiones de un equipo.
		 * @param {string} teamId El ID del equipo.
		 * @returns {string} El ID de la carpeta de Google Drive.
		 */
		async function getTeamFolderId(teamId) {
		    try {
		        const url = new URL(CONFIG.SCRIPT_URL);
		        url.searchParams.append('action', 'getTeamFolderId');
		        url.searchParams.append('userEmail', currentUser.email); // Seguridad
		        url.searchParams.append('teamId', teamId);
		
		        const response = await fetch(url);
		        const data = await response.json();
		
		        if (data.success && data.folderData.success) {
		            return data.folderData.folderId;
		        } else {
		            throw new Error(data.error || data.folderData.error);
		        }
		    } catch (error) {
		        console.error("Error obteniendo el ID de la carpeta del equipo:", error);
		        // Devolvemos una promesa rechazada para que el 'catch' en openFilePicker la maneje
		        return Promise.reject(error);
		    }
		}
    </script>
</body>
