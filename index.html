<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚öΩ ProAssist - Mi Dashboard</title>
    <script src="https://accounts.google.com/gsi/client"></script>
	<!-- ======================== -->
	<!-- ESQUEMA DE COLORES CSS -->
	<!-- ======================== -->
    <style>
	    /* ======================================== */
	    /* === 1. RESET Y CONFIGURACI√ìN GLOBAL ==== */
	    /* ======================================== */
	    * {
	        margin: 0;
	        padding: 0;
	        box-sizing: border-box;
	    }
	    
	    body {
	        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	        background-color: #34495e;
	        min-height: 100vh;
	        color: #333;
	    }
	
	    /* ======================================== */
	    /* ========= 2. LAYOUT PRINCIPAL ========== */
	    /* ======================================== */
	    .container {
	        max-width: 1200px;
	        margin: 1.5rem auto;
	        padding: 0 1rem; /* Padding horizontal para que el contenido no toque los bordes en m√≥vil */
	    }
	
	    /* Oculta los dashboards por defecto */
	    #player-dashboard, #admin-panel {
	        display: none;
	    }
	
	    /* ======================================== */
	    /* ========= 3. PANTALLA DE LOGIN ========= */
	    /* ======================================== */
	    .login-screen {
	        display: flex;
	        flex-direction: column;
	        justify-content: center;
	        align-items: center;
	        min-height: 100vh;
	        text-align: center;
	        padding: 1rem;
	    }
	
	    .login-card {
	        background: rgba(255, 255, 255, 0.95);
	        padding: 2.5rem;
	        border-radius: 20px;
	        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
	        max-width: 400px;
	        width: 100%;
	    }
	
	    .app-logo img {
	        width: 80px;
	        height: 80px;
	        margin-bottom: 1rem;
	    }
	
	    .app-title {
	        font-size: 2rem;
	        font-weight: bold;
	        margin-bottom: 0.5rem;
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        -webkit-background-clip: text;
	        -webkit-text-fill-color: transparent;
	        background-clip: text;
	    }
	
	    .app-subtitle {
	        color: #666;
	        margin-bottom: 2rem;
	        font-size: 1.1rem;
	    }
	
	    /* ======================================== */
	    /* ======== 4. COMPONENTES COMUNES ======== */
	    /* ======================================== */
	
	    /* --- Header Unificado --- */
	    .header {
	        background: white;
	        padding: 1rem 1.5rem;
	        border-radius: 15px;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        margin-bottom: 1.5rem;
	    }
	    
	    .logo {
	        display: flex;
	        align-items: center;
	        gap: 10px;
	        font-size: 1.4em;
	        font-weight: bold;
	        color: #2c3e50;
	    }
	
	    .admin-badge {
	        background: #e74c3c;
	        color: white;
	        padding: 4px 12px;
	        border-radius: 15px;
	        font-size: 0.7em;
	    }
	
	    /* --- Botones Gen√©ricos --- */
	    .btn {
	        padding: 10px 20px;
	        border: none;
	        border-radius: 8px;
	        cursor: pointer;
	        font-size: 14px;
	        font-weight: bold;
	        transition: all 0.3s ease;
	        display: inline-flex;
	        align-items: center;
	        justify-content: center;
	        gap: 8px;
	    }
	    .btn:hover {
	        transform: translateY(-2px);
	        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
	    }
	    .btn-primary { background: #3498db; color: white; }
	    .btn-success { background: #27ae60; color: white; }
	    .btn-danger { background: #e74c3c; color: white; }
	    .btn-secondary { background: #95a5a6; color: white; }
	    .btn-primary:hover { background: #2980b9; }
	    .btn-success:hover { background: #219a52; }
	    .btn-danger:hover { background: #c0392b; }
	    .btn-secondary:hover { background: #7f8c8d; }
	
	    /* --- Tarjetas (Cards) --- */
	    .card {
	        background: white;
	        border-radius: 15px;
	        padding: 1.5rem;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        transition: transform 0.3s ease;
	    }
	    .card:hover {
	        transform: translateY(-5px);
	    }
	    
	    /* --- Formularios --- */
	    .form-group {
	        margin-bottom: 1rem;
	    }
	    .form-group label {
	        display: block;
	        margin-bottom: 5px;
	        font-weight: bold;
	        color: #2c3e50;
	    }
	    .form-group input, .form-group select, .form-group textarea {
	        width: 100%;
	        padding: 12px;
	        border: 1px solid #ddd;
	        border-radius: 8px;
	        font-size: 14px;
	    }
	    
	    /* --- Alertas y Carga --- */
	    .alert {
	        padding: 1rem;
	        border-radius: 8px;
	        margin-bottom: 1rem;
	    }
	    .alert-success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
	    .alert-warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
	
	    .loading-placeholder {
	        text-align: center;
	        padding: 40px;
	        color: #666;
	    }
	    .spinner {
	        border: 4px solid #f3f3f3;
	        border-top: 4px solid #3498db;
	        border-radius: 50%;
	        width: 40px;
	        height: 40px;
	        animation: spin 1s linear infinite;
	        margin: 0 auto 1rem;
	    }
	    @keyframes spin {
	        0% { transform: rotate(0deg); }
	        100% { transform: rotate(360deg); }
	    }
	
	    /* ======================================== */
	    /* ===== 5. DASHBOARD JUGADORA (PLAYER) ==== */
	    /* ======================================== */
	    .stats-grid {
	        display: grid;
	        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
	        gap: 1.5rem;
	        margin-bottom: 1.5rem;
	    }
	
	    .motivational-message {
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        color: white;
	        padding: 1.5rem;
	        border-radius: 15px;
	        margin-bottom: 1.5rem;
	        text-align: center;
	        box-shadow: 0 5px 20px rgba(52, 152, 219, 0.2);
	    }
	    .motivational-message h3 {
	        margin-bottom: 0.5rem;
	        font-size: 1.3rem;
	    }
	
	    .stat-title {
	        font-size: 1.2rem;
	        font-weight: bold;
	        margin-bottom: 1rem;
	        display: flex;
	        align-items: center;
	        gap: 10px;
	    }
	    .stat-value {
	        font-size: 2.5rem;
	        font-weight: bold;
	        color: #3498db;
	        margin-bottom: 0.5rem;
	    }
	    .stat-description {
	        color: #666;
	        font-size: 0.9rem;
	    }
	    .progress-bar {
	        width: 100%;
	        height: 10px;
	        background: #e0e0e0;
	        border-radius: 5px;
	        margin-top: 0.5rem;
	        overflow: hidden;
	    }
	    .progress-fill {
	        height: 100%;
	        background: linear-gradient(45deg, #3498db, #1abc9c);
	        border-radius: 5px;
	        transition: width 0.3s ease;
	    }
	    .form-frame {
	        width: 100%;
	        min-height: 600px;
	        border: none;
	        border-radius: 10px;
	    }
	
	    /* ======================================== */
	    /* ===== 6. PANEL ADMINISTRADOR (ADMIN) ===== */
	    /* ======================================== */
	    .admin-content {
	        background: white;
	        border-radius: 15px;
	        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
	        overflow: hidden; /* Para contener los bordes redondeados */
	    }
	    .tabs {
	        display: flex;
	        background: #ecf0f1;
	    }
	    .tab {
	        flex: 1;
	        padding: 1rem;
	        background: none;
	        border: none;
	        cursor: pointer;
	        font-size: 1em;
	        font-weight: bold;
	        transition: all 0.3s ease;
	        display: flex;
	        align-items: center;
	        justify-content: center;
	        gap: 8px;
	        color: #7f8c8d;
	    }
	    .tab.active {
	        background: white;
	        color: #2c3e50;
	    }
	    .tab:hover:not(.active) {
	        background: #e0e6e8;
	    }
	    .tab-panel {
	        display: none;
	        padding: 1.5rem;
	    }
	    .tab-panel.active {
	        display: block;
	    }
	
	    .calendar-container {
	        display: grid;
	        grid-template-columns: 1fr 300px;
	        gap: 1.5rem;
	    }
	    .calendar-header {
	        background: #3498db;
	        color: white;
	        padding: 1rem;
	        display: flex;
	        justify-content: space-between;
	        align-items: center;
	        border-radius: 8px 8px 0 0;
	    }
	    .calendar-grid {
	        display: grid;
	        grid-template-columns: repeat(7, 1fr);
	        gap: 1px;
	        background: #ddd;
	    }
	    .calendar-day-header {
	        background: #34495e;
	        color: white;
	        padding: 10px;
	        text-align: center;
	        font-weight: bold;
	        font-size: 0.9em;
	    }
	    .calendar-day {
	        background: white;
	        min-height: 80px;
	        padding: 8px;
	        cursor: pointer;
	        position: relative;
	        transition: all 0.3s ease;
	    }
	    .calendar-day:hover { background: #f0f5f9; }
	    .calendar-day.other-month { background: #f8f9fa; color: #ccc; }
	    .calendar-day.has-training { background: #e8f5e8; }
	    .calendar-day.selected { background: #3498db; color: white; }
	    .training-indicator {
	        position: absolute;
	        bottom: 4px;
	        right: 4px;
	        width: 8px;
	        height: 8px;
	        background: #27ae60;
	        border-radius: 50%;
	    }
	    .sidebar {
	        background: #f8f9fa;
	        border-radius: 8px;
	        padding: 1.5rem;
	    }
	
	    /* ======================================== */
	    /* ======== 7. RESPONSIVE DESIGN ========== */
	    /* ======================================== */
	    @media (max-width: 992px) {
	        .calendar-container {
	            grid-template-columns: 1fr; /* Apila el calendario y el formulario */
	        }
	        .sidebar {
	            margin-top: 1.5rem;
	        }
	    }
	    
	    @media (max-width: 768px) {
	        .header {
	            flex-direction: column; /* Apila logo y botones */
	            gap: 1rem;
	            padding: 1rem;
	        }
	        .logo { font-size: 1.3em; }
	
	        .stats-grid {
	            grid-template-columns: 1fr; /* Una columna para las estad√≠sticas */
	        }
	        
	        .tabs {
	            flex-direction: column; /* Apila las pesta√±as del admin */
	        }
	    }
	</style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <!-- ======================== -->
			<!-- LOGO HTML -->
			<!-- ======================== -->
			<!-- Reemplazar esta l√≠nea: <div class="app-logo">‚öΩ</div> -->
			<div class="app-logo">
				<img src="ProAssist.png" alt="ProAssist Logo" style="width: 80px; height: 80px; margin-bottom: 15px;">
			</div>
            <h1 class="app-title">ProAssist</h1>
            <p class="app-subtitle">Tu dashboard personal de entrenamientos</p>
            <button id="signInButton" class="google-signin-btn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/>
                    <path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/>
                    <path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/>
                    <path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/>
                </svg>
                Iniciar sesi√≥n con Google
            </button>
            <div id="loginLoading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Iniciando sesi√≥n...</p>
            </div>
        </div>
    </div>

    <!-- DASHBOARD JUGADORA -->
    <div id="player-dashboard" class="main-screen">		
        <div class="container">  
			<!-- HEADER UNIFICADO CON SALUDO PARA JUGADORA -->
	        <header class="header">
	            <div class="logo">
	                <span id="greeting">Cargando saludo...</span>
	            </div>
	            <div style="display: flex; gap: 10px;">
	                <button id="logoutButton" class="btn btn-danger" onclick="signOut()">üö™ Cerrar Sesi√≥n</button>
	            </div>
	        </header>
            <!-- MENSAJE MOTIVACIONAL -->
            <div id="motivationalMessage" class="motivational-message" style="display: none;">
                <h3 id="motivationalTitle"></h3>
                <p id="motivationalText"></p>
            </div>

            <!-- ESTAD√çSTICAS PRINCIPALES -->
            <div class="stats-grid">
                <!-- ESTAD√çSTICAS PERSONALES -->
                <div class="card">
                    <div class="stat-title">
                        üìä Mis Estad√≠sticas
                    </div>
                    <div class="stat-value" id="totalTrainings">-</div>
                    <div class="stat-description">Entrenamientos completados</div>
                    
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Asistencia</span>
                            <span id="attendanceRate">-</span>
                        </div>
                        <div class="progress-bar">
                            <div id="attendanceProgress" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>

                    <div style="margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Progreso Mensual</span>
                            <span id="monthlyProgress">-</span>
                        </div>
                        <div class="progress-bar">
                            <div id="monthlyProgressBar" class="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <!-- COMPARACI√ìN CON EQUIPO -->
                <div class="card">
				    <div class="stat-title">
				        üë• Comparaci√≥n con Equipo
				    </div>
				    <div style="margin-top: 1rem;">
				        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
				            <span>Tu Asistencia</span>
				            <span id="myAttendanceRate">-</span>
				        </div>
				        <div class="progress-bar">
				            <div id="myAttendanceProgress" class="progress-fill" style="width: 0%"></div>
				        </div>
				    </div>
				    <div style="margin-top: 1.5rem;">
				        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
				            <span>Media del Equipo</span>
				            <span id="teamAverageRate">-</span>
				        </div>
				        <div class="progress-bar">
				            <div id="teamAverageProgress" class="progress-fill" style="background: #e67e22;"></div>
				        </div>
				    </div>
				</div>

                <!-- HISTORIAL RECIENTE -->
                <div class="card">
                    <div class="stat-title">
                        üìÖ Historial Reciente
                    </div>
                    <div id="historyList">
                        <div class="loading">
                            <div class="spinner"></div>
                            <p>Cargando historial...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FORMULARIO DEL D√çA -->
            <div class="card">
                <div class="form-title">
                	<span id="formTitle">Formulario del D√≠a</span>
                </div>
                <div id="formContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>Cargando formulario...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PANEL DE ADMINISTRADOR -->
    <div id="admin-panel" style="display: none;">    
	    <div class="container">
			<!-- HEADER UNIFICADO PARA ADMIN -->
	        <header class="header">
	            <div class="logo">
	                ‚öΩ ProAssist
	                <span class="admin-badge">ADMIN</span>
	            </div>
	            <div style="display: flex; gap: 10px;">
	                <button class="btn btn-primary" onclick="guardarConfiguracion()">üíæ Guardar Todo</button>
	                <button class="btn btn-danger" onclick="signOut()">üö™ Cerrar Sesi√≥n</button>
	            </div>
	        </header>
			<div class="admin-content">
		        <div class="tabs">
		            <button class="tab active" onclick="showTab('calendar')">
		                üìÖ Calendario
		            </button>
		            <button class="tab" onclick="showTab('config')">
		                ‚öôÔ∏è Configuraci√≥n
		            </button>
		            <button class="tab" onclick="showTab('stats')">
		                üìä Estad√≠sticas
		            </button>
		        </div>
		
		        <div class="content">
		            <!-- CALENDARIO TAB -->
		            <div id="calendar-tab" class="tab-panel active">
		                <div class="calendar-container">
		                    <div class="calendar">
		                        <div class="calendar-header">
		                            <button class="calendar-nav" onclick="previousMonth()">‚Äπ</button>
		                            <h2 id="calendar-month"></h2>
		                            <button class="calendar-nav" onclick="nextMonth()">‚Ä∫</button>
		                        </div>
		                        <div class="calendar-grid" id="calendar-grid">
		                            <!-- Se genera con JavaScript -->
		                        </div>
		                    </div>
		                    
		                    <div class="sidebar">
		                        <h3>üìù Entreno Seleccionado</h3>
		                        <div id="training-form">
		                            <div class="form-group">
		                                <label>üìÖ Fecha:</label>
		                                <input type="date" id="selected-date" readonly>
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>üïê Hora Inicio:</label>
		                                <input type="time" id="start-time" value="20:45">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>üïê Hora Fin:</label>
		                                <input type="time" id="end-time" value="22:30">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>üìç Ubicaci√≥n:</label>
		                                <input type="text" id="location" placeholder="Campo de entrenamiento">
		                            </div>
		                            
		                            <div class="form-group">
		                                <label>üìù Notas:</label>
		                                <textarea id="notes" rows="3" placeholder="Notas adicionales del entreno..."></textarea>
		                            </div>
		                            
		                            <div style="display: flex; gap: 10px;">
		                                <button class="btn btn-success" onclick="saveTraining()">‚úÖ Guardar</button>
		                                <button class="btn btn-danger" onclick="deleteTraining()">üóëÔ∏è Eliminar</button>
		                            </div>
		                            
		                            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #ddd;">
		                                <button class="btn btn-primary" onclick="createForm()" style="width: 100%;">
		                                    üìã Crear Formulario
		                                </button>
		                            </div>
		                        </div>
		                    </div>
		                </div>
		            </div>
		
		            <!-- CONFIGURACI√ìN TAB -->
		            <div id="config-tab" class="tab-panel">
		                <div class="config-section">
		                    <h3>‚öôÔ∏è Configuraci√≥n por Defecto</h3>
		                    <p>Define los d√≠as y horarios habituales de entrenamiento. Esto crear√° autom√°ticamente los entrenamientos para las pr√≥ximas semanas.</p>
		                    
		                    <div class="days-grid">
		                        <div class="day-config" id="day-tuesday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-tuesday" onchange="toggleDay('tuesday')">
		                                <label for="enable-tuesday"><strong>Martes</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="tuesday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="tuesday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                        
		                        <div class="day-config" id="day-thursday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-thursday" onchange="toggleDay('thursday')">
		                                <label for="enable-thursday"><strong>Jueves</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="thursday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="thursday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                        
		                        <div class="day-config" id="day-friday">
		                            <div class="checkbox-group">
		                                <input type="checkbox" id="enable-friday" onchange="toggleDay('friday')">
		                                <label for="enable-friday"><strong>Viernes</strong></label>
		                            </div>
		                            <div class="time-inputs">
		                                <div>
		                                    <label>Inicio:</label>
		                                    <input type="time" id="friday-start" value="20:45">
		                                </div>
		                                <div>
		                                    <label>Fin:</label>
		                                    <input type="time" id="friday-end" value="22:30">
		                                </div>
		                            </div>
		                        </div>
		                    </div>
		                    
		                    <div style="margin-top: 1.5rem;">
		                        <button class="btn btn-success" onclick="generateTrainings()">
		                            üîÑ Generar Pr√≥ximos 4 Entrenamientos
		                        </button>
		                        <button class="btn btn-secondary" onclick="clearAllTrainings()">
		                            üóëÔ∏è Limpiar Calendario
		                        </button>
		                    </div>
		                </div>
		
		                <div class="config-section">
		                    <h3>üìã Configuraci√≥n de Formularios</h3>
		                    
		                    <div class="form-group">
		                        <label>üîó ID Formulario Base:</label>
		                        <input type="text" id="form-base-id" placeholder="1BbcDef... (ID de tu formulario base)">
		                        <small style="color: #7f8c8d;">Este formulario se duplicar√° para cada entreno</small>
		                    </div>
		                    
		                    <div class="form-group">
		                        <label>üìä ID Google Sheets:</label>
		                        <input type="text" id="sheet-id" placeholder="1AbcDef... (ID de tu hoja de c√°lculo)">
		                        <small style="color: #7f8c8d;">Donde se guardar√°n las respuestas y configuraci√≥n</small>
		                    </div>
		                    
		                    <div class="form-group">
		                        <label>üìß Entry ID Campo Email:</label>
		                        <input type="text" id="email-entry" placeholder="entry.123456789">
		                        <small style="color: #7f8c8d;">Para pre-rellenar el email de la jugadora</small>
		                    </div>
		                </div>
		            </div>
		
		            <!-- ESTAD√çSTICAS TAB -->
		            <div id="stats-tab" class="tab-panel">
		                <div class="stats-grid">
		                    <div class="card">
		                        <div class="stat-value" id="stat-trainings">0</div>
		                        <div class="stat-label">Entrenamientos Programados</div>
		                    </div>
		                    
		                    <div class="card">
		                        <div class="stat-value" id="stat-forms">0</div>
		                        <div class="stat-label">Formularios Creados</div>
		                    </div>
		                    
		                    <div class="card">
		                        <div class="stat-value" id="stat-responses">0</div>
		                        <div class="stat-label">Respuestas Recibidas</div>
		                    </div>
		                    
		                    <div class="card">
		                        <div class="stat-value" id="stat-players">0</div>
		                        <div class="stat-label">Jugadoras Activas</div>
		                    </div>
		                </div>
		
		                <div class="training-list">
		                    <h3 style="padding: 1rem; background: #f8f9fa; margin: 0;">üìÖ Pr√≥ximos Entrenamientos</h3>
		                    <div id="upcoming-trainings">
		                        <!-- Se genera con JavaScript -->
		                    </div>
		                </div>
		            </div>
		        </div>
			</div>
	    </div>
    </div>

    <!-- INDICADOR DE AUTO-REFRESH -->
    <div id="refreshIndicator" class="refresh-indicator hidden">
        üîÑ
    </div>

    <script>
        // ========================
        // CONFIGURACI√ìN
        // ========================
        const CONFIG = {
            CLIENT_ID: '231457973375-lu8n54s56es213oqg5r3c5huas7golbb.apps.googleusercontent.com',
            SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbzxB3VoZ5qEgsO1Q9c5k3_JGRE60Fgnwt3BVfHRf0RTZsYZMdofEX91yBJ4jvDbYyj_Mg/exec',
            SCOPES: 'email profile',
            AUTO_REFRESH_INTERVAL: 300000, // 5 minutos
        };

		const FRASES_MOTIVACIONALES = [
		    { title: "‚öΩ ¬°A por Todas!", text: "El talento depende de la inspiraci√≥n, pero el esfuerzo depende de cada una." },
		    { title: "üî• Esp√≠ritu de Equipo", text: "Juegas para el nombre en el frente de la camiseta, y se acordar√°n del nombre en la espalda." },
		    { title: "üéØ Precisi√≥n y Pasi√≥n", text: "Cada entrenamiento es una oportunidad para ser mejor que ayer. ¬°No la desperdicies!" },
		    { title: "üåü Brilla en el Campo", text: "No sue√±es con el √©xito. Entrena para conseguirlo. ¬°Vamos!" },
		    { title: "üèÜ Mentalidad Ganadora", text: "Las campeonas no se hacen en los partidos, se hacen en los entrenamientos diarios." },
		    { title: "üí™ Fuerza y Coraje", text: "La diferencia entre lo posible y lo imposible reside en tu determinaci√≥n." },
		    { title: "üß† Juega con Inteligencia", text: "El bal√≥n es tu amigo, el campo tu lienzo. ¬°Crea tu obra de arte hoy!" }
		];

        // Variables globales
        let currentUser = null;
        let refreshInterval = null;
		// --- Variables Globales para el Panel de Administrador ---
		let currentDate = new Date(); // Controla el mes y a√±o que muestra el calendario
		let selectedDate = null;      // Guarda la fecha que el admin ha seleccionado (ej: '2025-08-19')
		let trainings = {};           // Almacena los entrenamientos cargados desde el backend

		// --- Funci√≥n de Utilidad para Fechas ---
		function toYYYYMMDD(date) {
		    const anio = date.getFullYear();
		    const mes = String(date.getMonth() + 1).padStart(2, '0'); // +1 porque los meses empiezan en 0
		    const dia = String(date.getDate()).padStart(2, '0');
		    return `${anio}-${mes}-${dia}`;
		}

        // ========================
        // INICIALIZACI√ìN
        // ========================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        function initializeApp() {
            // Configurar botones
            document.getElementById('signInButton').addEventListener('click', signIn);
            document.getElementById('logoutButton').addEventListener('click', signOut);

            // Cargar Google Identity Services
            if (typeof google !== 'undefined') {
                google.accounts.id.initialize({
                    client_id: CONFIG.CLIENT_ID,
                    callback: handleCredentialResponse
                });
            }

            // Verificar si ya hay sesi√≥n activa
            checkExistingSession();
        }

        // ========================
        // AUTENTICACI√ìN
        // ========================
        function signIn() {
            document.getElementById('loginLoading').style.display = 'block';
            document.getElementById('signInButton').style.display = 'none';

            google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.CLIENT_ID,
                scope: CONFIG.SCOPES,
                callback: handleTokenResponse,
            }).requestAccessToken();
        }

        function handleTokenResponse(response) {
            if (response.access_token) {
                fetchUserInfo(response.access_token);
            } else {
                showError('Error al obtener token de acceso');
                resetLoginScreen();
            }
        }

        function handleCredentialResponse(response) {
            // Decodificar JWT token
            const userInfo = parseJwt(response.credential);
            loginUser(userInfo);
        }

        async function fetchUserInfo(accessToken) {
            try {
                const response = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const userInfo = await response.json();
                    loginUser(userInfo);
                } else {
                    throw new Error('Error al obtener informaci√≥n del usuario');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Error al obtener informaci√≥n del usuario');
                resetLoginScreen();
            }
        }

        async function loginUser(userInfo) {
		    try {
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=checkAccess&email=${encodeURIComponent(userInfo.email)}&app=player`);
		        
		        // Si la respuesta NO es OK (ej. 404, 500), leemos el texto del error y lo lanzamos
		        if (!response.ok) {
		            const errorText = await response.text();
		            throw new Error(`El servidor respondi√≥ con un error ${response.status}: ${errorText}`);
		        }
		
		        const accessData = await response.json();
		
		        if (accessData.status === 'granted') {
		            currentUser = { ...userInfo, role: accessData.role };
		            sessionStorage.setItem('proassist_user', JSON.stringify(currentUser));
		            updateGreeting();
		            await showDashboardBasedOnRole(accessData.role);
		            startAutoRefresh(); 
		        } else {
		            // Esto es si el backend nos deniega el acceso expl√≠citamente
		            throw new Error(`Acceso denegado por el servidor: ${accessData.reason}`);
		        }
		    } catch (error) {
		        // Este bloque ahora capturar√° tanto errores de red (CORS) como los errores que lanzamos nosotros.
		        console.error('--- ERROR DE AUTORIZACI√ìN DETALLADO ---');
		        console.error(error); // <-- Esto nos dar√° el mensaje de error real y sin filtros.
		        showError('No se pudo verificar tus permisos. Revisa la consola para m√°s detalles.');
		        resetLoginScreen();
		    }
		}

        function checkExistingSession() {
		    const savedUser = sessionStorage.getItem('proassist_user');
		    if (savedUser) {
		        currentUser = JSON.parse(savedUser);
				updateGreeting();
		        // Usamos nuestro router tambi√©n aqu√≠ para restaurar la vista correcta
		        showDashboardBasedOnRole(currentUser.role);
		        startAutoRefresh();
		    }
		}

        function signOut() {
            // Limpiar datos
            currentUser = null;
            sessionStorage.removeItem('proassist_user');
            
            // Detener auto-refresh
            stopAutoRefresh();
            
            // Mostrar pantalla de login
            showLoginScreen();            
        }

		// ========================
		// ROUTER DE VISTAS
		// ========================
		async function showDashboardBasedOnRole(role) {
		    // Primero, ocultamos todas las pantallas principales para asegurar un estado limpio
		    document.getElementById('loginScreen').style.display = 'none';
		    document.getElementById('player-dashboard').style.display = 'none';
		    document.getElementById('admin-panel').style.display = 'none';
		
		    // Ahora, mostramos el panel correcto seg√∫n el rol del usuario
		    if (role === 'ADMIN' || role === 'COACH') {
		        document.getElementById('admin-panel').style.display = 'block';
		        // Llamamos a la funci√≥n que inicializa los datos del administrador
		        await initializeAdminPanel(); 
		    } else if (role === 'PLAYER') {
		        document.getElementById('player-dashboard').style.display = 'block';
		        // Llamamos a la funci√≥n que carga los datos de la jugadora (esta ya la tienes)
				showMotivationalMessage();
		        await loadUserData(); 
		    } else {
		        // En caso de que un rol desconocido intente acceder
		        showError('Tu rol de usuario no es v√°lido para esta aplicaci√≥n.');
		        signOut(); // Lo deslogueamos por seguridad
		    }
		}

		async function initializeAdminPanel() {
		    console.log("Inicializando el panel de Administrador...");
			trainings = {}; // Reseteamos los datos para evitar "fantasmas"
		    
		    // Muestra un estado de carga mientras se obtienen los datos
		    document.getElementById('calendar-month').textContent = 'Cargando datos...';
		
		    try {
		        // Llama al backend para obtener todos los entrenamientos
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTrainings`);
		        const data = await response.json();
		
		        if (data.success) {
		            // Si la llamada es exitosa, guarda los entrenamientos en nuestra variable global
		            trainings = data.trainings;
		            console.log('Entrenamientos cargados:', trainings);
		            
		            // Ahora que tenemos los datos, renderizamos todo el panel
		            renderCalendar();
		            updateStats();
		            
		        } else {
		            // Si el backend devuelve un error, lo mostramos
		            showAlert('Error al cargar entrenamientos: ' + data.error, 'warning');
		        }
		    } catch (error) {
		        // Si hay un error de red, tambi√©n lo mostramos
		        console.error('Error de conexi√≥n al cargar entrenamientos:', error);
		        showAlert('Error de conexi√≥n. No se pudieron cargar los datos.', 'warning');
		    }
		    
		    // La configuraci√≥n de los campos (form base id, etc.) la podemos seguir
		    // cargando desde localStorage por ahora, o crear otra llamada al backend m√°s adelante.
		    loadConfiguration();

			// --- RESTAURAMOS LA PESTA√ëA ACTIVA ---
		    const activeTab = sessionStorage.getItem('proassist_active_tab');
		    if (activeTab) {
		        // Buscamos el bot√≥n de la pesta√±a y lo "clickamos" para restaurar el estado
		        // Usamos un querySelector para encontrar el bot√≥n que llama a la funci√≥n con el nombre de la pesta√±a
		        const tabButton = document.querySelector(`.tab[onclick="showTab('${activeTab}')"]`);
		        if (tabButton) {
		            tabButton.click();
		        }
		    }
		}
		
        // ========================
        // UI NAVIGATION
        // ========================
        function showLoginScreen() {
    		document.getElementById('loginScreen').style.display = 'flex';
		    // Ocultamos AMBOS dashboards para asegurar un estado limpio
		    document.getElementById('player-dashboard').style.display = 'none';
		    document.getElementById('admin-panel').style.display = 'none';
		    resetLoginScreen();
		}        		

        function resetLoginScreen() {
            document.getElementById('loginLoading').style.display = 'none';
            document.getElementById('signInButton').style.display = 'flex';
        }

        // ========================
        // SALUDO PERSONALIZADO
        // ========================
        function updateGreeting() {
            if (!currentUser) return;
            
            const now = new Date();
            const hour = now.getHours();
            let greeting;
            
            if (hour < 12) {
                greeting = 'üåÖ Buenos d√≠as';
            } else if (hour < 18) {
                greeting = '‚òÄÔ∏è Buenas tardes';
            } else {
                greeting = 'üåô Buenas noches';
            }
            
            const firstName = currentUser.name ? currentUser.name.split(' ')[0] : 'Jugadora';
            document.getElementById('greeting').textContent = `${greeting}, ${firstName}!`;
        }

        // ========================
        // CARGAR DATOS DEL USUARIO
        // ========================
        async function loadUserData() {
            if (!currentUser || !currentUser.email) {
                showError('No hay informaci√≥n de usuario disponible');
                return;
            }

            try {
                // Cargar estad√≠sticas del usuario
                await loadUserStats();
                
                // Cargar historial
                await loadUserHistory();
                
                // Cargar formulario del d√≠a
                await loadTodaysForm();
                
                // Cargar estad√≠sticas del equipo para comparaci√≥n
                //await loadTeamComparison();
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                showError('Error al cargar los datos del usuario');
            }
        }

        async function loadUserStats() {
		    try {
		        // Usamos la acci√≥n correcta del backend que creamos como placeholder
		        const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserStats&email=${encodeURIComponent(currentUser.email)}`);
		        if (!response.ok) throw new Error(`HTTP ${response.status}`);
		        
		        const data = await response.json();
		        // La respuesta del backend ahora es { success: true, stats: {...} }
		        if (data.success) {
		            updateStatsUI(data.stats);		            		        
		        } else {
		            console.error('Error del servidor:', data.error);
		            showDefaultStats();
		        }
		    } catch (error) {
		        console.error('Error cargando estad√≠sticas:', error);
		        showDefaultStats();
		    }
		}

		function updateStatsUI(stats) {
		    // --- SECCI√ìN DE "MIS ESTAD√çSTICAS" (Esto ya estaba bien) ---
		    document.getElementById('totalTrainings').textContent = stats.totalTrainings || 0;
		    document.getElementById('attendanceRate').textContent = `${stats.attendanceRate || 0}%`;
		    
		    const attendanceProgress = Math.min(100, stats.attendanceRate || 0);
		    document.getElementById('attendanceProgress').style.width = `${attendanceProgress}%`;
		    
		    const monthlyProgress = Math.min(100, ((stats.monthlyTrainings || 0) / (stats.monthlyGoal || 1)) * 100);
		    document.getElementById('monthlyProgressBar').style.width = `${monthlyProgress}%`;
		    document.getElementById('monthlyProgress').textContent = `${stats.monthlyTrainings || 0}/${stats.monthlyGoal || 0}`;
		
		    // --- SECCI√ìN DE "COMPARACI√ìN CON EQUIPO" (Aqu√≠ est√° la correcci√≥n) ---
		    // Rellenamos los nuevos campos que creamos
		    document.getElementById('myAttendanceRate').textContent = `${stats.attendanceRate || 0}%`;
		    document.getElementById('myAttendanceProgress').style.width = `${attendanceProgress}%`;
		    
		    // El 'teamAverageRate' y 'teamAverageProgress' los dejaremos para cuando activemos la l√≥gica de equipo.
		    // Las siguientes l√≠neas son las que causaban el error. Las eliminamos:
		    // document.getElementById('currentStreak').textContent = stats.currentStreak || 0; // <-- ELIMINADA
		    // document.getElementById('myRanking').textContent = `#${stats.ranking || '-'}`;      // <-- ELIMINADA
		    
		    // Actualizar √∫ltima actividad
		    if (stats.lastActivity) {
		        const lastDate = new Date(stats.lastActivity);
		        const formattedDate = lastDate.toLocaleDateString('es-ES', {
		            day: 'numeric', month: 'long', year: 'numeric'
		        });
		        document.getElementById('lastActivity').textContent = `√öltimo entreno: ${formattedDate}`;
		    }
		}

		function showDefaultStats() {
		    document.getElementById('totalTrainings').textContent = '0';
		    document.getElementById('attendanceRate').textContent = '0%';
		    document.getElementById('monthlyProgress').textContent = '0/0';
		    
		    // Nuevos campos de comparaci√≥n
		    document.getElementById('myAttendanceRate').textContent = '0%';
		    document.getElementById('teamAverageRate').textContent = '-'; // A√∫n no tenemos este dato
		    
		    // Las siguientes l√≠neas causaban el error. Las eliminamos:
		    // document.getElementById('currentStreak').textContent = '0'; // <-- ELIMINADA
		    // document.getElementById('myRanking').textContent = '-';     // <-- ELIMINADA
		    
		    document.getElementById('lastActivity').textContent = 'A√∫n no hay actividad registrada';
		}        

        async function loadTeamComparison() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getTeamStats`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    updateTeamComparisonUI(data.stats);
                }
            } catch (error) {
                console.error('Error cargando comparaci√≥n de equipo:', error);
                document.getElementById('teamAverage').textContent = '-';
                document.getElementById('performanceComparison').textContent = '-';
            }
        }

        function updateTeamComparisonUI(teamStats) {
            document.getElementById('teamAverage').textContent = `${teamStats.averageAttendance || 0}%`;
            
            // Calcular comparaci√≥n de rendimiento
            const userAttendance = parseInt(document.getElementById('attendanceRate').textContent) || 0;
            const teamAverage = teamStats.averageAttendance || 0;
            
            let performanceText, performanceWidth;
            if (userAttendance > teamAverage) {
                const diff = userAttendance - teamAverage;
                performanceText = `+${diff}% sobre la media`;
                performanceWidth = Math.min(100, 50 + (diff / teamAverage) * 50);
            } else if (userAttendance < teamAverage) {
                const diff = teamAverage - userAttendance;
                performanceText = `-${diff}% bajo la media`;
                performanceWidth = Math.max(0, 50 - (diff / teamAverage) * 50);
            } else {
                performanceText = 'En la media del equipo';
                performanceWidth = 50;
            }
            
            document.getElementById('performanceComparison').textContent = performanceText;
            document.getElementById('performanceBar').style.width = `${performanceWidth}%`;
        }
		
		// ========================
        // HISTORIAL DE ENTRENAMIENTOS
        // ========================
        async function loadUserHistory() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getUserHistory&email=${encodeURIComponent(currentUser.email)}&limit=5`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success) {
                    updateHistoryUI(data.history);
                } else {
                    showHistoryError();
                }
            } catch (error) {
                console.error('Error cargando historial:', error);
                showHistoryError();
            }
        }
		
		function updateHistoryUI(history) {
            const historyList = document.getElementById('historyList');
            
            if (!history || history.length === 0) {
                historyList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p>A√∫n no tienes entrenamientos registrados</p>
                        <p style="font-size: 0.9rem;">¬°Completa tu primer formulario!</p>
                    </div>
                `;
                return;
            }

            historyList.innerHTML = history.map(item => {
                const date = new Date(item.date);
                const formattedDate = date.toLocaleDateString('es-ES', {
                    weekday: 'short',
                    day: 'numeric',
                    month: 'short'
                });
                
                const statusClass = item.completed ? 'status-completed' : 'status-missed';
                const statusText = item.completed ? 'Completado' : 'No asisti√≥';
                
                return `
                    <div class="history-item">
                        <div>
                            <div class="history-date">${formattedDate}</div>
                            <div style="font-size: 0.8rem; color: #666;">${item.time || 'Horario no especificado'}</div>
                        </div>
                        <div class="history-status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function showHistoryError() {
            document.getElementById('historyList').innerHTML = `
                <div style="text-align: center; padding: 20px; color: #666;">
                    <p>Error al cargar el historial</p>
                    <button onclick="loadUserHistory()" style="margin-top: 10px; padding: 5px 15px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                        Reintentar
                    </button>
                </div>
            `;
        }

        // ========================
        // FORMULARIO DEL D√çA
        // ========================
        async function loadTodaysForm() {
            try {
                const response = await fetch(`${CONFIG.SCRIPT_URL}?action=getForm&email=${encodeURIComponent(currentUser.email)}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (data.success && data.formUrl) {
                    showFormUI(data);
                } else {
                    showNoTrainingUI(data.message || 'No hay entreno programado para hoy');
                }
            } catch (error) {
                console.error('Error cargando formulario del d√≠a:', error);
                showFormError();
            }
        }

		function showFormUI(formData) {
		    const container = document.getElementById('formContainer');
		    const title = document.getElementById('formTitle');
		    
		    // Mantenemos la l√≥gica de actualizar el t√≠tulo, si existe la informaci√≥n
		    if (formData.trainingInfo) { // Suponiendo que el backend puede enviar esta info
		        const info = formData.trainingInfo;
		        title.innerHTML = `üìù Entreno de Hoy - ${info.time || ''} üìç ${info.location || ''}`;
		    } else {
		        title.innerHTML = `üìù Formulario del D√≠a`;
		    }
		    
		    // --- ESTE ES EL CAMBIO CLAVE ---
		    // En lugar de un iframe, creamos un bot√≥n grande y atractivo.
		    container.innerHTML = `
		        <div style="text-align: center; padding: 30px;">
		            <h3 style="margin-bottom: 10px;">¬°Listo para el pr√≥ximo entreno!</h3>
		            <p style="color: #666; margin-bottom: 25px;">
		                Por favor, completa el formulario de control antes de la sesi√≥n.
		            </p>
		            <a href="${formData.formUrl}" target="_blank" class="btn btn-success" style="padding: 15px 30px; font-size: 1.2em;">
		                üìã Abrir Formulario
		            </a>
		            <p style="font-size: 0.8rem; color: #888; margin-top: 15px;">
		                (Se abrir√° en una nueva pesta√±a)
		            </p>
		        </div>
		    `;
		}
		
        function showNoTrainingUI(message) {
            const container = document.getElementById('formContainer');
            const title = document.getElementById('formTitle');
            
            title.textContent = 'üìÖ Informaci√≥n del D√≠a';
            container.innerHTML = `
                <div class="no-training">
                    <div style="font-size: 3rem; margin-bottom: 20px;">üò¥</div>
                    <h3 style="margin-bottom: 10px;">No hay entreno hoy</h3>
                    <p style="color: #666; margin-bottom: 20px;">${message}</p>
                    <p style="font-size: 0.9rem; color: #888;">
                        ¬°Descansa y prep√°rate para el pr√≥ximo entreno!
                    </p>
                </div>
            `;
        }

        function showFormError() {
            const container = document.getElementById('formContainer');
            container.innerHTML = `
                <div class="no-training">
                    <div style="font-size: 3rem; margin-bottom: 20px;">‚ö†Ô∏è</div>
                    <h3 style="margin-bottom: 10px;">Error al cargar formulario</h3>
                    <p style="color: #666; margin-bottom: 20px;">
                        No se pudo cargar el formulario del d√≠a
                    </p>
                    <button onclick="loadTodaysForm()" 
                            style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        Reintentar
                    </button>
                </div>
            `;
        }

        // ========================
        // MENSAJES MOTIVACIONALES
        // ========================
		function showMotivationalMessage() {
		    const messageDiv = document.getElementById('motivationalMessage');
		    const titleEl = document.getElementById('motivationalTitle');
		    const textEl = document.getElementById('motivationalText');
		
		    // 1. Elegir una frase aleatoria de nuestro banco de frases
		    const randomIndex = Math.floor(Math.random() * FRASES_MOTIVACIONALES.length);
		    const randomPhrase = FRASES_MOTIVACIONALES[randomIndex];
		
		    // 2. Asignar el t√≠tulo y el texto
		    titleEl.textContent = randomPhrase.title;
		    textEl.textContent = randomPhrase.text;
		
		    // 3. Mostrar el mensaje
		    messageDiv.style.display = 'block';
		
		    // 4. Ocultarlo despu√©s de 10 segundos para no saturar
		    setTimeout(() => {
		        // A√±adimos una transici√≥n suave para que desaparezca
		        messageDiv.style.transition = 'opacity 0.5s';
		        messageDiv.style.opacity = '0';
		        // Y lo ocultamos del layout despu√©s de la transici√≥n
		        setTimeout(() => {
		            messageDiv.style.display = 'none';
		            messageDiv.style.opacity = '1'; // Lo reseteamos para la pr√≥xima vez
		            messageDiv.style.transition = '';
		        }, 500);
		    }, 10000);
		}        

        // ========================
        // AUTO-REFRESH
        // ========================
        function startAutoRefresh() {
            // Limpiar intervalo existente
            stopAutoRefresh();
            
            // Crear nuevo intervalo
            refreshInterval = setInterval(() => {
                showRefreshIndicator();
                loadUserData();
            }, CONFIG.AUTO_REFRESH_INTERVAL);
        }

        function stopAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function showRefreshIndicator() {
            const indicator = document.getElementById('refreshIndicator');
            indicator.classList.remove('hidden');
            
            setTimeout(() => {
                indicator.classList.add('hidden');
            }, 2000);
        }

        // ========================
        // UTILIDADES
        // ========================
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));
                return JSON.parse(jsonPayload);
            } catch (error) {
                console.error('Error parsing JWT:', error);
                return null;
            }
        }

        function showError(message) {
            // Crear notificaci√≥n de error
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: #ff4757;
                color: white;
                padding: 15px 25px;
                border-radius: 10px;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                z-index: 10000;
                font-weight: bold;
                max-width: 400px;
                text-align: center;
            `;
            errorDiv.textContent = message;
            
            document.body.appendChild(errorDiv);
            
            // Auto-remove despu√©s de 5 segundos
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        // Funciones para el iframe del formulario
        function handleFormLoad() {
            console.log('Formulario cargado correctamente');
        }

        function handleFormError() {
            console.error('Error al cargar el formulario');
            showFormError();
        }

        // ========================
        // EVENT LISTENERS GLOBALES
        // ========================
        
        // Detectar cuando el usuario regresa a la pesta√±a
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser) {
                loadUserData(); // Refrescar datos
            }
        });

        // Detectar errores globales
        window.addEventListener('error', function(e) {
            console.error('Error global:', e.error);
            if (e.error.message && e.error.message.includes('fetch')) {
                showError('Error de conexi√≥n. Por favor verifica tu internet.');
            }
        });

        // Limpiar al cerrar la ventana
        window.addEventListener('beforeunload', function() {
            stopAutoRefresh();
        });
	
        // FUNCIONES DE PESTA√ëAS
        function showTab(tabName) {
            // Ocultar todas las pesta√±as
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            
            // Usamos event.currentTarget para asegurarnos de que es el bot√≥n
    		const clickedTab = event.currentTarget;
			clickedTab.classList.add('active');
    		document.getElementById(tabName + '-tab').classList.add('active');			
            
            if (tabName === 'stats') {
                updateStats();
            }

			// --- GUARDAMOS LA PESTA√ëA ACTIVA ---
    		sessionStorage.setItem('proassist_active_tab', tabName);
        }

        // FUNCIONES DE CALENDARIO
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            // Actualizar t√≠tulo
            const monthNames = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                              'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
            document.getElementById('calendar-month').textContent = `${monthNames[month]} ${year}`;
            
            // Generar grid del calendario
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            // Headers de d√≠as
            const dayHeaders = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-day-header';
                header.textContent = day;
                grid.appendChild(header);
            });
            
            // D√≠as del calendario
            const current = new Date(startDate);
            for (let i = 0; i < 42; i++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = current.getDate();
                
                const dateString = toYYYYMMDD(current); // Usamos nuestra nueva funci√≥n
                dayElement.dataset.date = dateString;
                
                // Clases adicionales
                if (current.getMonth() !== month) {
                    dayElement.classList.add('other-month');
                }
                
                if (trainings[dateString]) {
                    dayElement.classList.add('has-training');
                    const indicator = document.createElement('div');
                    indicator.className = 'training-indicator';
                    dayElement.appendChild(indicator);
                }
                
                // Event listener
                dayElement.addEventListener('click', () => selectDate(dateString));
                
                grid.appendChild(dayElement);
                current.setDate(current.getDate() + 1);
            }
        }

        function previousMonth() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        }

        function selectDate(dateString) {
            // Remover selecci√≥n anterior
            document.querySelectorAll('.calendar-day.selected').forEach(day => {
                day.classList.remove('selected');
            });
            
            // Seleccionar nuevo d√≠a
            const dayElement = document.querySelector(`[data-date="${dateString}"]`);
            if (dayElement) {
                dayElement.classList.add('selected');
            }
            
            selectedDate = dateString;
            loadTrainingData(dateString);
        }

        function loadTrainingData(dateString) {
            const training = trainings[dateString] || {};
            
            document.getElementById('selected-date').value = dateString;
            document.getElementById('start-time').value = training.start || '20:45';
            document.getElementById('end-time').value = training.end || '22:30';
            document.getElementById('location').value = training.location || '';
            document.getElementById('notes').value = training.notes || '';
        }

        // FUNCIONES DE ENTRENAMIENTO
        async function saveTraining() {
		    if (!selectedDate) {
		        showAlert('Por favor, selecciona una fecha en el calendario primero.', 'warning');
		        return;
		    }
		    
		    const trainingDetails = {
		        fecha: selectedDate,
		        start: document.getElementById('start-time').value,
		        end: document.getElementById('end-time').value,
		        location: document.getElementById('location').value,
		        notes: document.getElementById('notes').value,
		    };
		
		    try {
		        // 1. Convertimos los detalles a un string JSON
		        const detailsString = JSON.stringify(trainingDetails);
		        
				// 2.1. Creamos la URL base
				const url = new URL(CONFIG.SCRIPT_URL);
				url.searchParams.append('action', 'saveTraining');
				url.searchParams.append('userEmail', currentUser.email);
				
				// 2.2. A√±adimos cada pieza del entrenamiento como un par√°metro simple
				url.searchParams.append('fecha', trainingDetails.fecha);
				url.searchParams.append('start', trainingDetails.start);
				url.searchParams.append('end', trainingDetails.end);
				url.searchParams.append('location', trainingDetails.location);
				url.searchParams.append('notes', trainingDetails.notes);

				console.log("Intentando llamar a la siguiente URL:");
        		console.log(url.toString());
		
		        // 3. Hacemos la petici√≥n GET a la nueva URL
		        const response = await fetch(url); // No se necesita method, por defecto es GET
		
		        const data = await response.json();
				// Primero, comprobamos si la respuesta general del backend fue exitosa.
				// Luego, nos aseguramos de que el objeto 'result' existe.
				// Y finalmente, comprobamos si la operaci√≥n espec√≠fica de guardado fue exitosa.
				if (data.success && data.result && data.result.success) {
				    trainings[selectedDate] = trainingDetails;
				    renderCalendar();
				    updateStats();
				    showAlert(data.result.message, 'success');
				} else {
				    // Si cualquiera de las condiciones anteriores falla, mostramos el mensaje de error.
				    // Usamos data.error para el error general, o data.result.error para el espec√≠fico.
				    const errorMessage = data.error || data.result?.error || "Ocurri√≥ un error desconocido.";
				    showAlert('Error al guardar: ' + errorMessage, 'warning');
				}
		    } catch (error) {
		        console.error('Error de conexi√≥n al guardar:', error);
		        showAlert('Error de conexi√≥n. No se pudo guardar el entrenamiento.', 'warning');
		    }
		}
		
        async function deleteTraining() {
		    if (!selectedDate || !trainings[selectedDate]) {
		        showAlert('No hay un entrenamiento guardado en esta fecha para eliminar.', 'warning');
		        return;
		    }
		    
		    if (confirm(`¬øEst√°s seguro de que quieres eliminar el entrenamiento del ${selectedDate}? Esta acci√≥n no se puede deshacer.`)) {
		        try {
		            // Construimos la URL con los par√°metros
		            const url = new URL(CONFIG.SCRIPT_URL);
		            url.searchParams.append('action', 'deleteTraining');
		            url.searchParams.append('userEmail', currentUser.email); // Seguridad
		            url.searchParams.append('fecha', selectedDate); // La fecha a eliminar
		
		            console.log("Intentando eliminar con la URL:", url.toString()); // Debug
		
		            const response = await fetch(url);
		            const data = await response.json();
		
		            if (data.success && data.result && data.result.success) {
		                // Eliminamos el entrenamiento de nuestro objeto local
		                delete trainings[selectedDate];
		                
		                // Limpiamos el formulario y redibujamos todo
		                document.getElementById('selected-date').value = '';
		                loadTrainingData(''); // Llama a la funci√≥n que limpia el formulario
		                
		                renderCalendar();
		                updateStats();
		                
		                showAlert(data.result.message, 'success');
		            } else {
		                const errorMessage = data.error || data.result?.error || "Ocurri√≥ un error desconocido.";
		                showAlert('Error al eliminar: ' + errorMessage, 'warning');
		            }
		        } catch (error) {
		            console.error('Error de conexi√≥n al eliminar:', error);
		            showAlert('Error de conexi√≥n. No se pudo eliminar el entrenamiento.', 'warning');
		        }
		    }
		}

        function createForm() {
            if (!selectedDate || !trainings[selectedDate]) {
                alert('Guarda el entrenamiento primero');
                return;
            }
            
            // Simular creaci√≥n de formulario
            const formId = 'form_' + selectedDate.replace(/-/g, '');
            trainings[selectedDate].formId = formId;
            
            showAlert('üìã Formulario creado correctamente', 'success');
            updateStats();
        }

        // FUNCIONES DE CONFIGURACI√ìN
        function toggleDay(day) {
            const checkbox = document.getElementById(`enable-${day}`);
            const dayElement = document.getElementById(`day-${day}`);
            
            if (checkbox.checked) {
                dayElement.classList.add('active');
            } else {
                dayElement.classList.remove('active');
            }
        }

        function generateTrainings() {
            const days = ['tuesday', 'thursday', 'friday'];
            const dayNumbers = { tuesday: 2, thursday: 4, friday: 5 };
            
            let generated = 0;
            const today = new Date();
            
            // Generar para las pr√≥ximas 4 semanas
            for (let week = 0; week < 4; week++) {
                days.forEach(day => {
                    const checkbox = document.getElementById(`enable-${day}`);
                    if (!checkbox.checked) return;
                    
                    const targetDate = new Date(today);
                    const daysToAdd = (dayNumbers[day] - today.getDay() + 7) % 7 + (week * 7);
                    targetDate.setDate(today.getDate() + daysToAdd);
                    
                    const dateString = targetDate.toISOString().split('T')[0];
                    
                    if (!trainings[dateString]) {
                        trainings[dateString] = {
                            start: document.getElementById(`${day}-start`).value,
                            end: document.getElementById(`${day}-end`).value,
                            location: '',
                            notes: `Entrenamiento ${day} - Semana ${week + 1}`,
                            formId: null
                        };
                        generated++;
                    }
                });
            }
            
            renderCalendar();
            updateStats();
            showAlert(`üîÑ ${generated} entrenamientos generados autom√°ticamente`, 'success');
        }

        function clearAllTrainings() {
            if (confirm('¬øEst√°s seguro de eliminar TODOS los entrenamientos? Esta acci√≥n no se puede deshacer.')) {
                trainings = {};
                renderCalendar();
                updateStats();
                showAlert('üóëÔ∏è Todos los entrenamientos eliminados', 'warning');
            }
        }

        // FUNCIONES DE ESTAD√çSTICAS
        function updateStats() {
            const trainingCount = Object.keys(trainings).length;
            const formsCount = Object.values(trainings).filter(t => t.formId).length;
            
            document.getElementById('stat-trainings').textContent = trainingCount;
            document.getElementById('stat-forms').textContent = formsCount;
            document.getElementById('stat-responses').textContent = Math.floor(Math.random() * 50); // Simulado
            document.getElementById('stat-players').textContent = Math.floor(Math.random() * 20) + 10; // Simulado
            
            // Actualizar lista de pr√≥ximos entrenamientos
            updateUpcomingTrainings();
        }

        function updateUpcomingTrainings() {
		    const container = document.getElementById('upcoming-trainings');
		    container.innerHTML = ''; // Limpiamos el contenedor
		
		    // Verificaci√≥n de seguridad: nos aseguramos de que 'trainings' exista y no est√© vac√≠o.
		    if (!trainings || Object.keys(trainings).length === 0) {
		        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #7f8c8d;">No hay entrenamientos programados</div>';
		        return;
		    }
		
		    const today = toYYYYMMDD(new Date());
		    
		    const futureTrainings = Object.entries(trainings)
		        .filter(([date, trainingData]) => date >= today && trainingData) // Filtro m√°s seguro
		        .sort(([a], [b]) => a.localeCompare(b))
		        .slice(0, 5);
		    
		    if (futureTrainings.length === 0) {
		        container.innerHTML = '<div style="padding: 2rem; text-align: center; color: #7f8c8d;">No hay entrenamientos programados</div>';
		        return;
		    }
		    
		    futureTrainings.forEach(([date, training]) => {
		        const item = document.createElement('div');
		        item.className = 'training-item';
		        
		        const formatDate = new Date(date + 'T12:00:00').toLocaleDateString('es-ES', {
		            weekday: 'long',
		            day: 'numeric',
		            month: 'long'
		        });
		        
		        item.innerHTML = `
		            <div class="training-info">
		                <div class="training-date">${formatDate}</div>
		                <div class="training-time">${training.start} - ${training.end}</div>
		                ${training.location ? `<div class="training-time">üìç ${training.location}</div>` : ''}
		            </div>
		            <div class="training-actions">
		                ${training.formId 
		                    ? '<span style="color: #27ae60;">üìã Formulario creado</span>'
		                    : '<span style="color: #e74c3c;">‚è≥ Sin formulario</span>'
		                }
		            </div>
		        `;
		        container.appendChild(item);
		    });
		}

        // FUNCIONES DE PERSISTENCIA
        function loadConfiguration() {            
            const savedConfig = localStorage.getItem('proassist-config');
            if (savedConfig) {
                const config = JSON.parse(savedConfig);
                document.getElementById('form-base-id').value = config.formBaseId || '';
                document.getElementById('sheet-id').value = config.sheetId || '';
                document.getElementById('email-entry').value = config.emailEntry || '';
                
                // Cargar configuraci√≥n de d√≠as
                ['tuesday', 'thursday', 'friday'].forEach(day => {
                    if (config.defaultDays && config.defaultDays[day]) {
                        document.getElementById(`enable-${day}`).checked = config.defaultDays[day].enabled;
                        document.getElementById(`${day}-start`).value = config.defaultDays[day].start;
                        document.getElementById(`${day}-end`).value = config.defaultDays[day].end;
                        toggleDay(day);
                    }
                });
            } else {
                // Configuraci√≥n por defecto
                ['tuesday', 'thursday', 'friday'].forEach(day => {
                    document.getElementById(`enable-${day}`).checked = true;
                    toggleDay(day);
                });
            }
        }

        function guardarConfiguracion() {
            // Guardar entrenamientos
            localStorage.setItem('proassist-trainings', JSON.stringify(trainings));
            
            // Guardar configuraci√≥n
            const config = {
                formBaseId: document.getElementById('form-base-id').value,
                sheetId: document.getElementById('sheet-id').value,
                emailEntry: document.getElementById('email-entry').value,
                defaultDays: {}
            };
            
            ['tuesday', 'thursday', 'friday'].forEach(day => {
                config.defaultDays[day] = {
                    enabled: document.getElementById(`enable-${day}`).checked,
                    start: document.getElementById(`${day}-start`).value,
                    end: document.getElementById(`${day}-end`).value
                };
            });
            
            localStorage.setItem('proassist-config', JSON.stringify(config));
            
            // En producci√≥n, aqu√≠ enviar√≠as los datos al backend
            syncWithBackend();
            
            showAlert('üíæ Configuraci√≥n guardada correctamente', 'success');
        }

        function syncWithBackend() {
            // Simular sincronizaci√≥n con Google Apps Script
            console.log('Sincronizando con backend...', {
                trainings: trainings,
                config: JSON.parse(localStorage.getItem('proassist-config'))
            });
            
            // En producci√≥n:
            // fetch(CONFIG.SCRIPT_URL + '?action=saveConfig', {
            //     method: 'POST',
            //     body: JSON.stringify({trainings, config})
            // });
        }

        // UTILIDADES
        function showAlert(message, type) {
            // Crear elemento de alerta
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            
            // Insertar al inicio del contenido activo
            const activePanel = document.querySelector('.tab-panel.active');
            activePanel.insertBefore(alert, activePanel.firstChild);
            
            // Remover despu√©s de 5 segundos
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // FUNCIONES DE INTEGRACI√ìN CON BACKEND
        function createFormularioReal(fecha) {
            const training = trainings[fecha];
            if (!training) return;
            
            // Llamada real al backend
            fetch(CONFIG.SCRIPT_URL + '?action=createForm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    fecha: fecha,
                    horaInicio: training.start,
                    horaFin: training.end,
                    ubicacion: training.location,
                    notas: training.notes
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    trainings[fecha].formId = data.formId;
                    showAlert('üìã Formulario creado en Google Forms', 'success');
                } else {
                    showAlert('Error creando formulario: ' + data.error, 'warning');
                }
            })
            .catch(error => {
                showAlert('Error de conexi√≥n con el backend', 'warning');
                console.error(error);
            });
        }	                                                                                                                               
    </script>
</body>
